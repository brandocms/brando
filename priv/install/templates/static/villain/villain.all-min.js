if(function(){function t(t){function e(e,n,r,i,s,a){for(;s>=0&&a>s;s+=t){var o=i?i[s]:s;r=n(r,e[o],o,e)}return r}return function(n,r,i,s){r=_(r,s,4);var a=!j(n)&&y.keys(n),o=(a||n).length,u=t>0?0:o-1;return arguments.length<3&&(i=n[a?a[u]:u],u+=t),e(n,r,i,a,u,o)}}function e(t){return function(e,n,r){n=b(n,r);for(var i=S(e),s=t>0?0:i-1;s>=0&&i>s;s+=t)if(n(e[s],s,e))return s;return-1}}function n(t,e,n){return function(r,i,s){var a=0,o=S(r);if("number"==typeof s)t>0?a=s>=0?s:Math.max(s+o,a):o=s>=0?Math.min(s+1,o):s+o+1;else if(n&&s&&o)return s=n(r,i),r[s]===i?s:-1;if(i!==i)return s=e(c.call(r,a,o),y.isNaN),s>=0?s+a:-1;for(s=t>0?a:o-1;s>=0&&o>s;s+=t)if(r[s]===i)return s;return-1}}function r(t,e){var n=M.length,r=t.constructor,i=y.isFunction(r)&&r.prototype||o,s="constructor";for(y.has(t,s)&&!y.contains(e,s)&&e.push(s);n--;)s=M[n],s in t&&t[s]!==i[s]&&!y.contains(e,s)&&e.push(s)}var i=this,s=i._,a=Array.prototype,o=Object.prototype,u=Function.prototype,l=a.push,c=a.slice,h=o.toString,f=o.hasOwnProperty,p=Array.isArray,d=Object.keys,g=u.bind,v=Object.create,m=function(){},y=function(t){return t instanceof y?t:this instanceof y?void(this._wrapped=t):new y(t)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=y),exports._=y):i._=y,y.VERSION="1.8.3";var _=function(t,e,n){if(void 0===e)return t;switch(null==n?3:n){case 1:return function(n){return t.call(e,n)};case 2:return function(n,r){return t.call(e,n,r)};case 3:return function(n,r,i){return t.call(e,n,r,i)};case 4:return function(n,r,i,s){return t.call(e,n,r,i,s)}}return function(){return t.apply(e,arguments)}},b=function(t,e,n){return null==t?y.identity:y.isFunction(t)?_(t,e,n):y.isObject(t)?y.matcher(t):y.property(t)};y.iteratee=function(t,e){return b(t,e,1/0)};var k=function(t,e){return function(n){var r=arguments.length;if(2>r||null==n)return n;for(var i=1;r>i;i++)for(var s=arguments[i],a=t(s),o=a.length,u=0;o>u;u++){var l=a[u];e&&void 0!==n[l]||(n[l]=s[l])}return n}},w=function(t){if(!y.isObject(t))return{};if(v)return v(t);m.prototype=t;var e=new m;return m.prototype=null,e},x=function(t){return function(e){return null==e?void 0:e[t]}},E=Math.pow(2,53)-1,S=x("length"),j=function(t){var e=S(t);return"number"==typeof e&&e>=0&&E>=e};y.each=y.forEach=function(t,e,n){e=_(e,n);var r,i;if(j(t))for(r=0,i=t.length;i>r;r++)e(t[r],r,t);else{var s=y.keys(t);for(r=0,i=s.length;i>r;r++)e(t[s[r]],s[r],t)}return t},y.map=y.collect=function(t,e,n){e=b(e,n);for(var r=!j(t)&&y.keys(t),i=(r||t).length,s=Array(i),a=0;i>a;a++){var o=r?r[a]:a;s[a]=e(t[o],o,t)}return s},y.reduce=y.foldl=y.inject=t(1),y.reduceRight=y.foldr=t(-1),y.find=y.detect=function(t,e,n){var r;return r=j(t)?y.findIndex(t,e,n):y.findKey(t,e,n),void 0!==r&&-1!==r?t[r]:void 0},y.filter=y.select=function(t,e,n){var r=[];return e=b(e,n),y.each(t,function(t,n,i){e(t,n,i)&&r.push(t)}),r},y.reject=function(t,e,n){return y.filter(t,y.negate(b(e)),n)},y.every=y.all=function(t,e,n){e=b(e,n);for(var r=!j(t)&&y.keys(t),i=(r||t).length,s=0;i>s;s++){var a=r?r[s]:s;if(!e(t[a],a,t))return!1}return!0},y.some=y.any=function(t,e,n){e=b(e,n);for(var r=!j(t)&&y.keys(t),i=(r||t).length,s=0;i>s;s++){var a=r?r[s]:s;if(e(t[a],a,t))return!0}return!1},y.contains=y.includes=y.include=function(t,e,n,r){return j(t)||(t=y.values(t)),("number"!=typeof n||r)&&(n=0),y.indexOf(t,e,n)>=0},y.invoke=function(t,e){var n=c.call(arguments,2),r=y.isFunction(e);return y.map(t,function(t){var i=r?e:t[e];return null==i?i:i.apply(t,n)})},y.pluck=function(t,e){return y.map(t,y.property(e))},y.where=function(t,e){return y.filter(t,y.matcher(e))},y.findWhere=function(t,e){return y.find(t,y.matcher(e))},y.max=function(t,e,n){var r,i,s=-1/0,a=-1/0;if(null==e&&null!=t){t=j(t)?t:y.values(t);for(var o=0,u=t.length;u>o;o++)r=t[o],r>s&&(s=r)}else e=b(e,n),y.each(t,function(t,n,r){i=e(t,n,r),(i>a||i===-1/0&&s===-1/0)&&(s=t,a=i)});return s},y.min=function(t,e,n){var r,i,s=1/0,a=1/0;if(null==e&&null!=t){t=j(t)?t:y.values(t);for(var o=0,u=t.length;u>o;o++)r=t[o],s>r&&(s=r)}else e=b(e,n),y.each(t,function(t,n,r){i=e(t,n,r),(a>i||1/0===i&&1/0===s)&&(s=t,a=i)});return s},y.shuffle=function(t){for(var e,n=j(t)?t:y.values(t),r=n.length,i=Array(r),s=0;r>s;s++)e=y.random(0,s),e!==s&&(i[s]=i[e]),i[e]=n[s];return i},y.sample=function(t,e,n){return null==e||n?(j(t)||(t=y.values(t)),t[y.random(t.length-1)]):y.shuffle(t).slice(0,Math.max(0,e))},y.sortBy=function(t,e,n){return e=b(e,n),y.pluck(y.map(t,function(t,n,r){return{value:t,index:n,criteria:e(t,n,r)}}).sort(function(t,e){var n=t.criteria,r=e.criteria;if(n!==r){if(n>r||void 0===n)return 1;if(r>n||void 0===r)return-1}return t.index-e.index}),"value")};var A=function(t){return function(e,n,r){var i={};return n=b(n,r),y.each(e,function(r,s){var a=n(r,s,e);t(i,r,a)}),i}};y.groupBy=A(function(t,e,n){y.has(t,n)?t[n].push(e):t[n]=[e]}),y.indexBy=A(function(t,e,n){t[n]=e}),y.countBy=A(function(t,e,n){y.has(t,n)?t[n]++:t[n]=1}),y.toArray=function(t){return t?y.isArray(t)?c.call(t):j(t)?y.map(t,y.identity):y.values(t):[]},y.size=function(t){return null==t?0:j(t)?t.length:y.keys(t).length},y.partition=function(t,e,n){e=b(e,n);var r=[],i=[];return y.each(t,function(t,n,s){(e(t,n,s)?r:i).push(t)}),[r,i]},y.first=y.head=y.take=function(t,e,n){return null==t?void 0:null==e||n?t[0]:y.initial(t,t.length-e)},y.initial=function(t,e,n){return c.call(t,0,Math.max(0,t.length-(null==e||n?1:e)))},y.last=function(t,e,n){return null==t?void 0:null==e||n?t[t.length-1]:y.rest(t,Math.max(0,t.length-e))},y.rest=y.tail=y.drop=function(t,e,n){return c.call(t,null==e||n?1:e)},y.compact=function(t){return y.filter(t,y.identity)};var $=function(t,e,n,r){for(var i=[],s=0,a=r||0,o=S(t);o>a;a++){var u=t[a];if(j(u)&&(y.isArray(u)||y.isArguments(u))){e||(u=$(u,e,n));var l=0,c=u.length;for(i.length+=c;c>l;)i[s++]=u[l++]}else n||(i[s++]=u)}return i};y.flatten=function(t,e){return $(t,e,!1)},y.without=function(t){return y.difference(t,c.call(arguments,1))},y.uniq=y.unique=function(t,e,n,r){y.isBoolean(e)||(r=n,n=e,e=!1),null!=n&&(n=b(n,r));for(var i=[],s=[],a=0,o=S(t);o>a;a++){var u=t[a],l=n?n(u,a,t):u;e?(a&&s===l||i.push(u),s=l):n?y.contains(s,l)||(s.push(l),i.push(u)):y.contains(i,u)||i.push(u)}return i},y.union=function(){return y.uniq($(arguments,!0,!0))},y.intersection=function(t){for(var e=[],n=arguments.length,r=0,i=S(t);i>r;r++){var s=t[r];if(!y.contains(e,s)){for(var a=1;n>a&&y.contains(arguments[a],s);a++);a===n&&e.push(s)}}return e},y.difference=function(t){var e=$(arguments,!0,!0,1);return y.filter(t,function(t){return!y.contains(e,t)})},y.zip=function(){return y.unzip(arguments)},y.unzip=function(t){for(var e=t&&y.max(t,S).length||0,n=Array(e),r=0;e>r;r++)n[r]=y.pluck(t,r);return n},y.object=function(t,e){for(var n={},r=0,i=S(t);i>r;r++)e?n[t[r]]=e[r]:n[t[r][0]]=t[r][1];return n},y.findIndex=e(1),y.findLastIndex=e(-1),y.sortedIndex=function(t,e,n,r){n=b(n,r,1);for(var i=n(e),s=0,a=S(t);a>s;){var o=Math.floor((s+a)/2);n(t[o])<i?s=o+1:a=o}return s},y.indexOf=n(1,y.findIndex,y.sortedIndex),y.lastIndexOf=n(-1,y.findLastIndex),y.range=function(t,e,n){null==e&&(e=t||0,t=0),n=n||1;for(var r=Math.max(Math.ceil((e-t)/n),0),i=Array(r),s=0;r>s;s++,t+=n)i[s]=t;return i};var T=function(t,e,n,r,i){if(!(r instanceof e))return t.apply(n,i);var s=w(t.prototype),a=t.apply(s,i);return y.isObject(a)?a:s};y.bind=function(t,e){if(g&&t.bind===g)return g.apply(t,c.call(arguments,1));if(!y.isFunction(t))throw new TypeError("Bind must be called on a function");var n=c.call(arguments,2),r=function(){return T(t,r,e,this,n.concat(c.call(arguments)))};return r},y.partial=function(t){var e=c.call(arguments,1),n=function(){for(var r=0,i=e.length,s=Array(i),a=0;i>a;a++)s[a]=e[a]===y?arguments[r++]:e[a];for(;r<arguments.length;)s.push(arguments[r++]);return T(t,n,this,this,s)};return n},y.bindAll=function(t){var e,n,r=arguments.length;if(1>=r)throw new Error("bindAll must be passed function names");for(e=1;r>e;e++)n=arguments[e],t[n]=y.bind(t[n],t);return t},y.memoize=function(t,e){var n=function(r){var i=n.cache,s=""+(e?e.apply(this,arguments):r);return y.has(i,s)||(i[s]=t.apply(this,arguments)),i[s]};return n.cache={},n},y.delay=function(t,e){var n=c.call(arguments,2);return setTimeout(function(){return t.apply(null,n)},e)},y.defer=y.partial(y.delay,y,1),y.throttle=function(t,e,n){var r,i,s,a=null,o=0;n||(n={});var u=function(){o=n.leading===!1?0:y.now(),a=null,s=t.apply(r,i),a||(r=i=null)};return function(){var l=y.now();o||n.leading!==!1||(o=l);var c=e-(l-o);return r=this,i=arguments,0>=c||c>e?(a&&(clearTimeout(a),a=null),o=l,s=t.apply(r,i),a||(r=i=null)):a||n.trailing===!1||(a=setTimeout(u,c)),s}},y.debounce=function(t,e,n){var r,i,s,a,o,u=function(){var l=y.now()-a;e>l&&l>=0?r=setTimeout(u,e-l):(r=null,n||(o=t.apply(s,i),r||(s=i=null)))};return function(){s=this,i=arguments,a=y.now();var l=n&&!r;return r||(r=setTimeout(u,e)),l&&(o=t.apply(s,i),s=i=null),o}},y.wrap=function(t,e){return y.partial(e,t)},y.negate=function(t){return function(){return!t.apply(this,arguments)}},y.compose=function(){var t=arguments,e=t.length-1;return function(){for(var n=e,r=t[e].apply(this,arguments);n--;)r=t[n].call(this,r);return r}},y.after=function(t,e){return function(){return--t<1?e.apply(this,arguments):void 0}},y.before=function(t,e){var n;return function(){return--t>0&&(n=e.apply(this,arguments)),1>=t&&(e=null),n}},y.once=y.partial(y.before,2);var O=!{toString:null}.propertyIsEnumerable("toString"),M=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"];y.keys=function(t){if(!y.isObject(t))return[];if(d)return d(t);var e=[];for(var n in t)y.has(t,n)&&e.push(n);return O&&r(t,e),e},y.allKeys=function(t){if(!y.isObject(t))return[];var e=[];for(var n in t)e.push(n);return O&&r(t,e),e},y.values=function(t){for(var e=y.keys(t),n=e.length,r=Array(n),i=0;n>i;i++)r[i]=t[e[i]];return r},y.mapObject=function(t,e,n){e=b(e,n);for(var r,i=y.keys(t),s=i.length,a={},o=0;s>o;o++)r=i[o],a[r]=e(t[r],r,t);return a},y.pairs=function(t){for(var e=y.keys(t),n=e.length,r=Array(n),i=0;n>i;i++)r[i]=[e[i],t[e[i]]];return r},y.invert=function(t){for(var e={},n=y.keys(t),r=0,i=n.length;i>r;r++)e[t[n[r]]]=n[r];return e},y.functions=y.methods=function(t){var e=[];for(var n in t)y.isFunction(t[n])&&e.push(n);return e.sort()},y.extend=k(y.allKeys),y.extendOwn=y.assign=k(y.keys),y.findKey=function(t,e,n){e=b(e,n);for(var r,i=y.keys(t),s=0,a=i.length;a>s;s++)if(r=i[s],e(t[r],r,t))return r},y.pick=function(t,e,n){var r,i,s={},a=t;if(null==a)return s;y.isFunction(e)?(i=y.allKeys(a),r=_(e,n)):(i=$(arguments,!1,!1,1),r=function(t,e,n){return e in n},a=Object(a));for(var o=0,u=i.length;u>o;o++){var l=i[o],c=a[l];r(c,l,a)&&(s[l]=c)}return s},y.omit=function(t,e,n){if(y.isFunction(e))e=y.negate(e);else{var r=y.map($(arguments,!1,!1,1),String);e=function(t,e){return!y.contains(r,e)}}return y.pick(t,e,n)},y.defaults=k(y.allKeys,!0),y.create=function(t,e){var n=w(t);return e&&y.extendOwn(n,e),n},y.clone=function(t){return y.isObject(t)?y.isArray(t)?t.slice():y.extend({},t):t},y.tap=function(t,e){return e(t),t},y.isMatch=function(t,e){var n=y.keys(e),r=n.length;if(null==t)return!r;for(var i=Object(t),s=0;r>s;s++){var a=n[s];if(e[a]!==i[a]||!(a in i))return!1}return!0};var I=function(t,e,n,r){if(t===e)return 0!==t||1/t===1/e;if(null==t||null==e)return t===e;t instanceof y&&(t=t._wrapped),e instanceof y&&(e=e._wrapped);var i=h.call(t);if(i!==h.call(e))return!1;switch(i){case"[object RegExp]":case"[object String]":return""+t==""+e;case"[object Number]":return+t!==+t?+e!==+e:0===+t?1/+t===1/e:+t===+e;case"[object Date]":case"[object Boolean]":return+t===+e}var s="[object Array]"===i;if(!s){if("object"!=typeof t||"object"!=typeof e)return!1;var a=t.constructor,o=e.constructor;if(a!==o&&!(y.isFunction(a)&&a instanceof a&&y.isFunction(o)&&o instanceof o)&&"constructor"in t&&"constructor"in e)return!1}n=n||[],r=r||[];for(var u=n.length;u--;)if(n[u]===t)return r[u]===e;if(n.push(t),r.push(e),s){if(u=t.length,u!==e.length)return!1;for(;u--;)if(!I(t[u],e[u],n,r))return!1}else{var l,c=y.keys(t);if(u=c.length,y.keys(e).length!==u)return!1;for(;u--;)if(l=c[u],!y.has(e,l)||!I(t[l],e[l],n,r))return!1}return n.pop(),r.pop(),!0};y.isEqual=function(t,e){return I(t,e)},y.isEmpty=function(t){return null==t?!0:j(t)&&(y.isArray(t)||y.isString(t)||y.isArguments(t))?0===t.length:0===y.keys(t).length},y.isElement=function(t){return!(!t||1!==t.nodeType)},y.isArray=p||function(t){return"[object Array]"===h.call(t)},y.isObject=function(t){var e=typeof t;return"function"===e||"object"===e&&!!t},y.each(["Arguments","Function","String","Number","Date","RegExp","Error"],function(t){y["is"+t]=function(e){return h.call(e)==="[object "+t+"]"}}),y.isArguments(arguments)||(y.isArguments=function(t){return y.has(t,"callee")}),"function"!=typeof/./&&"object"!=typeof Int8Array&&(y.isFunction=function(t){return"function"==typeof t||!1}),y.isFinite=function(t){return isFinite(t)&&!isNaN(parseFloat(t))},y.isNaN=function(t){return y.isNumber(t)&&t!==+t},y.isBoolean=function(t){return t===!0||t===!1||"[object Boolean]"===h.call(t)},y.isNull=function(t){return null===t},y.isUndefined=function(t){return void 0===t},y.has=function(t,e){return null!=t&&f.call(t,e)},y.noConflict=function(){return i._=s,this},y.identity=function(t){return t},y.constant=function(t){return function(){return t}},y.noop=function(){},y.property=x,y.propertyOf=function(t){return null==t?function(){}:function(e){return t[e]}},y.matcher=y.matches=function(t){return t=y.extendOwn({},t),function(e){return y.isMatch(e,t)}},y.times=function(t,e,n){var r=Array(Math.max(0,t));e=_(e,n,1);for(var i=0;t>i;i++)r[i]=e(i);return r},y.random=function(t,e){return null==e&&(e=t,t=0),t+Math.floor(Math.random()*(e-t+1))},y.now=Date.now||function(){return(new Date).getTime()};var N={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},R=y.invert(N),H=function(t){var e=function(e){return t[e]},n="(?:"+y.keys(t).join("|")+")",r=RegExp(n),i=RegExp(n,"g");return function(t){return t=null==t?"":""+t,r.test(t)?t.replace(i,e):t}};y.escape=H(N),y.unescape=H(R),y.result=function(t,e,n){var r=null==t?void 0:t[e];return void 0===r&&(r=n),y.isFunction(r)?r.call(t):r};var P=0;y.uniqueId=function(t){var e=++P+"";return t?t+e:e},y.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var q=/(.)^/,F={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},L=/\\|'|\r|\n|\u2028|\u2029/g,B=function(t){return"\\"+F[t]};y.template=function(t,e,n){!e&&n&&(e=n),e=y.defaults({},e,y.templateSettings);var r=RegExp([(e.escape||q).source,(e.interpolate||q).source,(e.evaluate||q).source].join("|")+"|$","g"),i=0,s="__p+='";t.replace(r,function(e,n,r,a,o){return s+=t.slice(i,o).replace(L,B),i=o+e.length,n?s+="'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'":r?s+="'+\n((__t=("+r+"))==null?'':__t)+\n'":a&&(s+="';\n"+a+"\n__p+='"),e}),s+="';\n",e.variable||(s="with(obj||{}){\n"+s+"}\n"),s="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+s+"return __p;\n";try{var a=new Function(e.variable||"obj","_",s)}catch(o){throw o.source=s,o}var u=function(t){return a.call(this,t,y)},l=e.variable||"obj";return u.source="function("+l+"){\n"+s+"}",u},y.chain=function(t){var e=y(t);return e._chain=!0,e};var C=function(t,e){return t._chain?y(e).chain():e};y.mixin=function(t){y.each(y.functions(t),function(e){var n=y[e]=t[e];y.prototype[e]=function(){var t=[this._wrapped];return l.apply(t,arguments),C(this,n.apply(y,t))}})},y.mixin(y),y.each(["pop","push","reverse","shift","sort","splice","unshift"],function(t){var e=a[t];y.prototype[t]=function(){var n=this._wrapped;return e.apply(n,arguments),"shift"!==t&&"splice"!==t||0!==n.length||delete n[0],C(this,n)}}),y.each(["concat","join","slice"],function(t){var e=a[t];y.prototype[t]=function(){return C(this,e.apply(this._wrapped,arguments))}}),y.prototype.value=function(){return this._wrapped},y.prototype.valueOf=y.prototype.toJSON=y.prototype.value,y.prototype.toString=function(){return""+this._wrapped},"function"==typeof define&&define.amd&&define("underscore",[],function(){return y})}.call(this),function(t,e){if("function"==typeof define&&define.amd)define(["underscore","jquery","exports"],function(n,r,i){t.Backbone=e(t,i,n,r)});else if("undefined"!=typeof exports){var n=require("underscore");e(t,exports,n)}else t.Backbone=e(t,{},t._,t.jQuery||t.Zepto||t.ender||t.$)}(this,function(t,e,n,r){{var i=t.Backbone,s=[],a=(s.push,s.slice);s.splice}e.VERSION="1.1.2",e.$=r,e.noConflict=function(){return t.Backbone=i,this},e.emulateHTTP=!1,e.emulateJSON=!1;var o=e.Events={on:function(t,e,n){if(!l(this,"on",t,[e,n])||!e)return this;this._events||(this._events={});var r=this._events[t]||(this._events[t]=[]);return r.push({callback:e,context:n,ctx:n||this}),this},once:function(t,e,r){if(!l(this,"once",t,[e,r])||!e)return this;var i=this,s=n.once(function(){i.off(t,s),e.apply(this,arguments)});return s._callback=e,this.on(t,s,r)},off:function(t,e,r){var i,s,a,o,u,c,h,f;if(!this._events||!l(this,"off",t,[e,r]))return this;if(!t&&!e&&!r)return this._events=void 0,this;for(o=t?[t]:n.keys(this._events),u=0,c=o.length;c>u;u++)if(t=o[u],a=this._events[t]){if(this._events[t]=i=[],e||r)for(h=0,f=a.length;f>h;h++)s=a[h],(e&&e!==s.callback&&e!==s.callback._callback||r&&r!==s.context)&&i.push(s);i.length||delete this._events[t]}return this},trigger:function(t){if(!this._events)return this;var e=a.call(arguments,1);if(!l(this,"trigger",t,e))return this;var n=this._events[t],r=this._events.all;return n&&c(n,e),r&&c(r,arguments),this},stopListening:function(t,e,r){var i=this._listeningTo;if(!i)return this;var s=!e&&!r;r||"object"!=typeof e||(r=this),t&&((i={})[t._listenId]=t);for(var a in i)t=i[a],t.off(e,r,this),(s||n.isEmpty(t._events))&&delete this._listeningTo[a];return this}},u=/\s+/,l=function(t,e,n,r){if(!n)return!0;if("object"==typeof n){for(var i in n)t[e].apply(t,[i,n[i]].concat(r));return!1}if(u.test(n)){for(var s=n.split(u),a=0,o=s.length;o>a;a++)t[e].apply(t,[s[a]].concat(r));return!1}return!0},c=function(t,e){var n,r=-1,i=t.length,s=e[0],a=e[1],o=e[2];switch(e.length){case 0:for(;++r<i;)(n=t[r]).callback.call(n.ctx);return;case 1:for(;++r<i;)(n=t[r]).callback.call(n.ctx,s);return;case 2:for(;++r<i;)(n=t[r]).callback.call(n.ctx,s,a);return;case 3:for(;++r<i;)(n=t[r]).callback.call(n.ctx,s,a,o);return;default:for(;++r<i;)(n=t[r]).callback.apply(n.ctx,e);return}},h={listenTo:"on",listenToOnce:"once"};n.each(h,function(t,e){o[e]=function(e,r,i){var s=this._listeningTo||(this._listeningTo={}),a=e._listenId||(e._listenId=n.uniqueId("l"));return s[a]=e,i||"object"!=typeof r||(i=this),e[t](r,i,this),this}}),o.bind=o.on,o.unbind=o.off,n.extend(e,o);var f=e.Model=function(t,e){var r=t||{};e||(e={}),this.cid=n.uniqueId("c"),this.attributes={},e.collection&&(this.collection=e.collection),e.parse&&(r=this.parse(r,e)||{}),r=n.defaults({},r,n.result(this,"defaults")),this.set(r,e),this.changed={},this.initialize.apply(this,arguments)};n.extend(f.prototype,o,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(){return n.clone(this.attributes)},sync:function(){return e.sync.apply(this,arguments)},get:function(t){return this.attributes[t]},escape:function(t){return n.escape(this.get(t))},has:function(t){return null!=this.get(t)},set:function(t,e,r){var i,s,a,o,u,l,c,h;if(null==t)return this;if("object"==typeof t?(s=t,r=e):(s={})[t]=e,r||(r={}),!this._validate(s,r))return!1;a=r.unset,u=r.silent,o=[],l=this._changing,this._changing=!0,l||(this._previousAttributes=n.clone(this.attributes),this.changed={}),h=this.attributes,c=this._previousAttributes,this.idAttribute in s&&(this.id=s[this.idAttribute]);for(i in s)e=s[i],n.isEqual(h[i],e)||o.push(i),n.isEqual(c[i],e)?delete this.changed[i]:this.changed[i]=e,a?delete h[i]:h[i]=e;if(!u){o.length&&(this._pending=r);for(var f=0,p=o.length;p>f;f++)this.trigger("change:"+o[f],this,h[o[f]],r)}if(l)return this;if(!u)for(;this._pending;)r=this._pending,this._pending=!1,this.trigger("change",this,r);return this._pending=!1,this._changing=!1,this},unset:function(t,e){return this.set(t,void 0,n.extend({},e,{unset:!0}))},clear:function(t){var e={};for(var r in this.attributes)e[r]=void 0;return this.set(e,n.extend({},t,{unset:!0}))},hasChanged:function(t){return null==t?!n.isEmpty(this.changed):n.has(this.changed,t)},changedAttributes:function(t){if(!t)return this.hasChanged()?n.clone(this.changed):!1;var e,r=!1,i=this._changing?this._previousAttributes:this.attributes;for(var s in t)n.isEqual(i[s],e=t[s])||((r||(r={}))[s]=e);return r},previous:function(t){return null!=t&&this._previousAttributes?this._previousAttributes[t]:null},previousAttributes:function(){return n.clone(this._previousAttributes)},fetch:function(t){t=t?n.clone(t):{},void 0===t.parse&&(t.parse=!0);var e=this,r=t.success;return t.success=function(n){return e.set(e.parse(n,t),t)?(r&&r(e,n,t),void e.trigger("sync",e,n,t)):!1},q(this,t),this.sync("read",this,t)},save:function(t,e,r){var i,s,a,o=this.attributes;if(null==t||"object"==typeof t?(i=t,r=e):(i={})[t]=e,r=n.extend({validate:!0},r),i&&!r.wait){if(!this.set(i,r))return!1}else if(!this._validate(i,r))return!1;i&&r.wait&&(this.attributes=n.extend({},o,i)),void 0===r.parse&&(r.parse=!0);var u=this,l=r.success;return r.success=function(t){u.attributes=o;var e=u.parse(t,r);return r.wait&&(e=n.extend(i||{},e)),n.isObject(e)&&!u.set(e,r)?!1:(l&&l(u,t,r),void u.trigger("sync",u,t,r))},q(this,r),s=this.isNew()?"create":r.patch?"patch":"update","patch"===s&&(r.attrs=i),a=this.sync(s,this,r),i&&r.wait&&(this.attributes=o),a},destroy:function(t){t=t?n.clone(t):{};var e=this,r=t.success,i=function(){e.trigger("destroy",e,e.collection,t)};if(t.success=function(n){(t.wait||e.isNew())&&i(),r&&r(e,n,t),e.isNew()||e.trigger("sync",e,n,t)},this.isNew())return t.success(),!1;q(this,t);var s=this.sync("delete",this,t);return t.wait||i(),s},url:function(){var t=n.result(this,"urlRoot")||n.result(this.collection,"url")||P();return this.isNew()?t:t.replace(/([^\/])$/,"$1/")+encodeURIComponent(this.id)},parse:function(t){return t},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return!this.has(this.idAttribute)},isValid:function(t){return this._validate({},n.extend(t||{},{validate:!0}))},_validate:function(t,e){if(!e.validate||!this.validate)return!0;t=n.extend({},this.attributes,t);var r=this.validationError=this.validate(t,e)||null;return r?(this.trigger("invalid",this,r,n.extend(e,{validationError:r})),!1):!0}});var p=["keys","values","pairs","invert","pick","omit"];n.each(p,function(t){f.prototype[t]=function(){var e=a.call(arguments);return e.unshift(this.attributes),n[t].apply(n,e)}});var d=e.Collection=function(t,e){e||(e={}),e.model&&(this.model=e.model),void 0!==e.comparator&&(this.comparator=e.comparator),this._reset(),this.initialize.apply(this,arguments),t&&this.reset(t,n.extend({silent:!0},e))},g={add:!0,remove:!0,merge:!0},v={add:!0,remove:!1};n.extend(d.prototype,o,{model:f,initialize:function(){},toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},sync:function(){return e.sync.apply(this,arguments)},add:function(t,e){return this.set(t,n.extend({merge:!1},e,v))},remove:function(t,e){var r=!n.isArray(t);t=r?[t]:n.clone(t),e||(e={});var i,s,a,o;for(i=0,s=t.length;s>i;i++)o=t[i]=this.get(t[i]),o&&(delete this._byId[o.id],delete this._byId[o.cid],a=this.indexOf(o),this.models.splice(a,1),this.length--,e.silent||(e.index=a,o.trigger("remove",o,this,e)),this._removeReference(o,e));return r?t[0]:t},set:function(t,e){e=n.defaults({},e,g),e.parse&&(t=this.parse(t,e));var r=!n.isArray(t);t=r?t?[t]:[]:n.clone(t);var i,s,a,o,u,l,c,h=e.at,p=this.model,d=this.comparator&&null==h&&e.sort!==!1,v=n.isString(this.comparator)?this.comparator:null,m=[],y=[],_={},b=e.add,k=e.merge,w=e.remove,x=!d&&b&&w?[]:!1;for(i=0,s=t.length;s>i;i++){if(u=t[i]||{},a=u instanceof f?o=u:u[p.prototype.idAttribute||"id"],l=this.get(a))w&&(_[l.cid]=!0),k&&(u=u===o?o.attributes:u,e.parse&&(u=l.parse(u,e)),l.set(u,e),d&&!c&&l.hasChanged(v)&&(c=!0)),t[i]=l;else if(b){if(o=t[i]=this._prepareModel(u,e),!o)continue;m.push(o),this._addReference(o,e)}o=l||o,!x||!o.isNew()&&_[o.id]||x.push(o),_[o.id]=!0}if(w){for(i=0,s=this.length;s>i;++i)_[(o=this.models[i]).cid]||y.push(o);y.length&&this.remove(y,e)}if(m.length||x&&x.length)if(d&&(c=!0),this.length+=m.length,null!=h)for(i=0,s=m.length;s>i;i++)this.models.splice(h+i,0,m[i]);else{x&&(this.models.length=0);var E=x||m;for(i=0,s=E.length;s>i;i++)this.models.push(E[i])}if(c&&this.sort({silent:!0}),!e.silent){for(i=0,s=m.length;s>i;i++)(o=m[i]).trigger("add",o,this,e);(c||x&&x.length)&&this.trigger("sort",this,e)}return r?t[0]:t},reset:function(t,e){e||(e={});for(var r=0,i=this.models.length;i>r;r++)this._removeReference(this.models[r],e);return e.previousModels=this.models,this._reset(),t=this.add(t,n.extend({silent:!0},e)),e.silent||this.trigger("reset",this,e),t},push:function(t,e){return this.add(t,n.extend({at:this.length},e))},pop:function(t){var e=this.at(this.length-1);return this.remove(e,t),e},unshift:function(t,e){return this.add(t,n.extend({at:0},e))},shift:function(t){var e=this.at(0);return this.remove(e,t),e},slice:function(){return a.apply(this.models,arguments)},get:function(t){return null==t?void 0:this._byId[t]||this._byId[t.id]||this._byId[t.cid]},at:function(t){return this.models[t]},where:function(t,e){return n.isEmpty(t)?e?void 0:[]:this[e?"find":"filter"](function(e){for(var n in t)if(t[n]!==e.get(n))return!1;return!0})},findWhere:function(t){return this.where(t,!0)},sort:function(t){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return t||(t={}),n.isString(this.comparator)||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(n.bind(this.comparator,this)),t.silent||this.trigger("sort",this,t),this},pluck:function(t){return n.invoke(this.models,"get",t)},fetch:function(t){t=t?n.clone(t):{},void 0===t.parse&&(t.parse=!0);var e=t.success,r=this;return t.success=function(n){var i=t.reset?"reset":"set";r[i](n,t),e&&e(r,n,t),r.trigger("sync",r,n,t)},q(this,t),this.sync("read",this,t)},create:function(t,e){if(e=e?n.clone(e):{},!(t=this._prepareModel(t,e)))return!1;e.wait||this.add(t,e);var r=this,i=e.success;return e.success=function(t,n){e.wait&&r.add(t,e),i&&i(t,n,e)},t.save(null,e),t},parse:function(t){return t},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(t,e){if(t instanceof f)return t;e=e?n.clone(e):{},e.collection=this;var r=new this.model(t,e);return r.validationError?(this.trigger("invalid",this,r.validationError,e),!1):r},_addReference:function(t){this._byId[t.cid]=t,null!=t.id&&(this._byId[t.id]=t),t.collection||(t.collection=this),t.on("all",this._onModelEvent,this)},_removeReference:function(t){this===t.collection&&delete t.collection,t.off("all",this._onModelEvent,this)},_onModelEvent:function(t,e,n,r){("add"!==t&&"remove"!==t||n===this)&&("destroy"===t&&this.remove(e,r),e&&t==="change:"+e.idAttribute&&(delete this._byId[e.previous(e.idAttribute)],null!=e.id&&(this._byId[e.id]=e)),this.trigger.apply(this,arguments))}});var m=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","difference","indexOf","shuffle","lastIndexOf","isEmpty","chain","sample"];n.each(m,function(t){d.prototype[t]=function(){var e=a.call(arguments);return e.unshift(this.models),n[t].apply(n,e)}});var y=["groupBy","countBy","sortBy","indexBy"];n.each(y,function(t){d.prototype[t]=function(e,r){var i=n.isFunction(e)?e:function(t){return t.get(e)};return n[t](this.models,i,r)}});var _=e.View=function(t){this.cid=n.uniqueId("view"),t||(t={}),n.extend(this,n.pick(t,k)),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},b=/^(\S+)\s*(.*)$/,k=["model","collection","el","id","attributes","className","tagName","events"];n.extend(_.prototype,o,{tagName:"div",$:function(t){return this.$el.find(t)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this.stopListening(),this},setElement:function(t,n){return this.$el&&this.undelegateEvents(),this.$el=t instanceof e.$?t:e.$(t),this.el=this.$el[0],n!==!1&&this.delegateEvents(),this},delegateEvents:function(t){if(!t&&!(t=n.result(this,"events")))return this;this.undelegateEvents();for(var e in t){var r=t[e];if(n.isFunction(r)||(r=this[t[e]]),r){var i=e.match(b),s=i[1],a=i[2];r=n.bind(r,this),s+=".delegateEvents"+this.cid,""===a?this.$el.on(s,r):this.$el.on(s,a,r)}}return this},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this},_ensureElement:function(){if(this.el)this.setElement(n.result(this,"el"),!1);else{var t=n.extend({},n.result(this,"attributes"));this.id&&(t.id=n.result(this,"id")),this.className&&(t["class"]=n.result(this,"className"));var r=e.$("<"+n.result(this,"tagName")+">").attr(t);this.setElement(r,!1)}}}),e.sync=function(t,r,i){var s=x[t];n.defaults(i||(i={}),{emulateHTTP:e.emulateHTTP,emulateJSON:e.emulateJSON});var a={type:s,dataType:"json"};if(i.url||(a.url=n.result(r,"url")||P()),null!=i.data||!r||"create"!==t&&"update"!==t&&"patch"!==t||(a.contentType="application/json",a.data=JSON.stringify(i.attrs||r.toJSON(i))),i.emulateJSON&&(a.contentType="application/x-www-form-urlencoded",a.data=a.data?{model:a.data}:{}),i.emulateHTTP&&("PUT"===s||"DELETE"===s||"PATCH"===s)){a.type="POST",i.emulateJSON&&(a.data._method=s);var o=i.beforeSend;i.beforeSend=function(t){return t.setRequestHeader("X-HTTP-Method-Override",s),o?o.apply(this,arguments):void 0}}"GET"===a.type||i.emulateJSON||(a.processData=!1),"PATCH"===a.type&&w&&(a.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});var u=i.xhr=e.ajax(n.extend(a,i));return r.trigger("request",r,u,i),u};var w=!("undefined"==typeof window||!window.ActiveXObject||window.XMLHttpRequest&&(new XMLHttpRequest).dispatchEvent),x={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};e.ajax=function(){return e.$.ajax.apply(e.$,arguments)};var E=e.Router=function(t){t||(t={}),t.routes&&(this.routes=t.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},S=/\((.*?)\)/g,j=/(\(\?)?:\w+/g,A=/\*\w+/g,$=/[\-{}\[\]+?.,\\\^$|#\s]/g;n.extend(E.prototype,o,{initialize:function(){},route:function(t,r,i){n.isRegExp(t)||(t=this._routeToRegExp(t)),n.isFunction(r)&&(i=r,r=""),i||(i=this[r]);var s=this;return e.history.route(t,function(n){var a=s._extractParameters(t,n);s.execute(i,a),s.trigger.apply(s,["route:"+r].concat(a)),s.trigger("route",r,a),e.history.trigger("route",s,r,a)}),this},execute:function(t,e){t&&t.apply(this,e)},navigate:function(t,n){return e.history.navigate(t,n),this},_bindRoutes:function(){if(this.routes){this.routes=n.result(this,"routes");for(var t,e=n.keys(this.routes);null!=(t=e.pop());)this.route(t,this.routes[t])}},_routeToRegExp:function(t){return t=t.replace($,"\\$&").replace(S,"(?:$1)?").replace(j,function(t,e){return e?t:"([^/?]+)"}).replace(A,"([^?]*?)"),new RegExp("^"+t+"(?:\\?([\\s\\S]*))?$")},_extractParameters:function(t,e){var r=t.exec(e).slice(1);return n.map(r,function(t,e){return e===r.length-1?t||null:t?decodeURIComponent(t):null})}});var T=e.History=function(){this.handlers=[],n.bindAll(this,"checkUrl"),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},O=/^[#\/]|\s+$/g,M=/^\/+|\/+$/g,I=/msie [\w.]+/,N=/\/$/,R=/#.*$/;T.started=!1,n.extend(T.prototype,o,{interval:50,atRoot:function(){return this.location.pathname.replace(/[^\/]$/,"$&/")===this.root},getHash:function(t){var e=(t||this).location.href.match(/#(.*)$/);return e?e[1]:""
},getFragment:function(t,e){if(null==t)if(this._hasPushState||!this._wantsHashChange||e){t=decodeURI(this.location.pathname+this.location.search);var n=this.root.replace(N,"");t.indexOf(n)||(t=t.slice(n.length))}else t=this.getHash();return t.replace(O,"")},start:function(t){if(T.started)throw new Error("Backbone.history has already been started");T.started=!0,this.options=n.extend({root:"/"},this.options,t),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var r=this.getFragment(),i=document.documentMode,s=I.exec(navigator.userAgent.toLowerCase())&&(!i||7>=i);if(this.root=("/"+this.root+"/").replace(M,"/"),s&&this._wantsHashChange){var a=e.$('<iframe src="javascript:0" tabindex="-1">');this.iframe=a.hide().appendTo("body")[0].contentWindow,this.navigate(r)}this._hasPushState?e.$(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!s?e.$(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=r;var o=this.location;if(this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!this.atRoot())return this.fragment=this.getFragment(null,!0),this.location.replace(this.root+"#"+this.fragment),!0;this._hasPushState&&this.atRoot()&&o.hash&&(this.fragment=this.getHash().replace(O,""),this.history.replaceState({},document.title,this.root+this.fragment))}return this.options.silent?void 0:this.loadUrl()},stop:function(){e.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),this._checkUrlInterval&&clearInterval(this._checkUrlInterval),T.started=!1},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(){var t=this.getFragment();return t===this.fragment&&this.iframe&&(t=this.getFragment(this.getHash(this.iframe))),t===this.fragment?!1:(this.iframe&&this.navigate(t),void this.loadUrl())},loadUrl:function(t){return t=this.fragment=this.getFragment(t),n.any(this.handlers,function(e){return e.route.test(t)?(e.callback(t),!0):void 0})},navigate:function(t,e){if(!T.started)return!1;e&&e!==!0||(e={trigger:!!e});var n=this.root+(t=this.getFragment(t||""));if(t=t.replace(R,""),this.fragment!==t){if(this.fragment=t,""===t&&"/"!==n&&(n=n.slice(0,-1)),this._hasPushState)this.history[e.replace?"replaceState":"pushState"]({},document.title,n);else{if(!this._wantsHashChange)return this.location.assign(n);this._updateHash(this.location,t,e.replace),this.iframe&&t!==this.getFragment(this.getHash(this.iframe))&&(e.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,t,e.replace))}return e.trigger?this.loadUrl(t):void 0}},_updateHash:function(t,e,n){if(n){var r=t.href.replace(/(javascript:|#).*$/,"");t.replace(r+"#"+e)}else t.hash="#"+e}}),e.history=new T;var H=function(t,e){var r,i=this;r=t&&n.has(t,"constructor")?t.constructor:function(){return i.apply(this,arguments)},n.extend(r,i,e);var s=function(){this.constructor=r};return s.prototype=i.prototype,r.prototype=new s,t&&n.extend(r.prototype,t),r.__super__=i.prototype,r};f.extend=d.extend=E.extend=_.extend=T.extend=H;var P=function(){throw new Error('A "url" property or function must be specified')},q=function(t,e){var n=e.error;e.error=function(r){n&&n(t,r,e),t.trigger("error",t,r,e)}};return e}),"object"!=typeof he&&"function"==typeof require)var he=require("he");var toMarkdown=function(t){function e(t,e){var n="void"===e.type?"<"+e.tag+"\\b([^>]*)\\/?>":"<"+e.tag+"\\b([^>]*)>([\\s\\S]*?)<\\/"+e.tag+">",r=new RegExp(n,"gi"),i="";return i="string"==typeof e.replacement?t.replace(r,e.replacement):t.replace(r,function(t,n,r,i){return e.replacement.call(this,t,n,r,i)})}function n(t){return new RegExp(t+"\\s*=\\s*[\"']?([^\"']*)[\"']?","i")}function r(t){return t=t.replace(/<(ul|ol)\b[^>]*>([\s\S]*?)<\/\1>/gi,function(t,e,n){var r=n.split("</li>");for(r.splice(r.length-1,1),o=0,u=r.length;u>o;o++)if(r[o]){var i="ol"===e?o+1+".  ":"*   ";r[o]=r[o].replace(/\s*<li[^>]*>([\s\S]*)/i,function(t,e){return e=e.replace(/^\s+/,""),e=e.replace(/\n\n/g,"\n\n    "),e=e.replace(/\n([ ]*)+(\*|\d+\.) /g,"\n$1    $2 "),i+e})}return r.join("\n")}),"\n\n"+t.replace(/[ \t]+\n|\s+$/g,"")}function i(t){return t=t.replace(/<blockquote\b[^>]*>([\s\S]*?)<\/blockquote>/gi,function(t,e){return e=e.replace(/^\s+|\s+$/g,""),e=s(e),e=e.replace(/^/gm,"> "),e=e.replace(/^(>([ \t]{2,}>)+)/gm,"> >")})}function s(t){return t=t.replace(/^[\t\r\n]+|[\t\r\n]+$/g,""),t=t.replace(/\n\s+\n/g,"\n\n"),t=t.replace(/\n{3,}/g,"\n\n")}for(var a=[{patterns:"p",replacement:function(t,e,n){return n?"\n\n"+n+"\n":""}},{patterns:"br",type:"void",replacement:"\n"},{patterns:"h([1-6])",replacement:function(t,e,n,r){for(var i="",s=0;e>s;s++)i+="#";return"\n\n"+i+" "+r+"\n"}},{patterns:"hr",type:"void",replacement:"\n\n* * *\n"},{patterns:"a",replacement:function(t,e,r){var i=e.match(n("href")),s=e.match(n("title"));return i?"["+r+"]("+i[1]+(s&&s[1]?' "'+s[1]+'"':"")+")":t}},{patterns:["b","strong"],replacement:function(t,e,n){return n?"**"+n+"**":""}},{patterns:["i","em"],replacement:function(t,e,n){return n?"_"+n+"_":""}},{patterns:"code",replacement:function(t,e,n){return n?"`"+he.decode(n)+"`":""}},{patterns:"img",type:"void",replacement:function(t,e){var r=e.match(n("src")),i=e.match(n("alt")),s=e.match(n("title"));return"!["+(i&&i[1]?i[1]:"")+"]("+r[1]+(s&&s[1]?' "'+s[1]+'"':"")+")"}}],o=0,u=a.length;u>o;o++)if("string"==typeof a[o].patterns)t=e(t,{tag:a[o].patterns,replacement:a[o].replacement,type:a[o].type});else for(var l=0,c=a[o].patterns.length;c>l;l++)t=e(t,{tag:a[o].patterns[l],replacement:a[o].replacement,type:a[o].type});t=t.replace(/<pre\b[^>]*>`([\s\S]*?)`<\/pre>/gi,function(t,e){var n=he.decode(e);return n=n.replace(/^\t+/g,"  "),n=n.replace(/\n/g,"\n    "),"\n\n    "+n+"\n"}),t=t.replace(/^(\s{0,3}\d+)\. /g,"$1\\. ");for(var h=/<(ul|ol)\b[^>]*>(?:(?!<ul|<ol)[\s\S])*?<\/\1>/gi;t.match(h);)t=t.replace(h,function(t){return r(t)});for(var f=/<blockquote\b[^>]*>((?:(?!<blockquote)[\s\S])*?)<\/blockquote>/gi;t.match(f);)t=t.replace(f,function(t){return i(t)});return s(t)};"object"==typeof exports&&(exports.toMarkdown=toMarkdown),!function(t){function e(){return"Markdown.mk_block( "+uneval(this.toString())+", "+uneval(this.trailing)+", "+uneval(this.lineNumber)+" )"}function n(){var t=require("util");return"Markdown.mk_block( "+t.inspect(this.toString())+", "+t.inspect(this.trailing)+", "+t.inspect(this.lineNumber)+" )"}function r(t){for(var e=0,n=-1;-1!==(n=t.indexOf("\n",n+1));)e++;return e}function i(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function s(t){if("string"==typeof t)return i(t);var e=t.shift(),n={},r=[];for(!t.length||"object"!=typeof t[0]||t[0]instanceof Array||(n=t.shift());t.length;)r.push(s(t.shift()));var a="";for(var o in n)a+=" "+o+'="'+i(n[o])+'"';return"img"===e||"br"===e||"hr"===e?"<"+e+a+"/>":"<"+e+a+">"+r.join("")+"</"+e+">"}function a(t,e,n){var r;n=n||{};var i=t.slice(0);"function"==typeof n.preprocessTreeNode&&(i=n.preprocessTreeNode(i,e));var s=d(i);if(s){i[1]={};for(r in s)i[1][r]=s[r];s=i[1]}if("string"==typeof i)return i;switch(i[0]){case"header":i[0]="h"+i[1].level,delete i[1].level;break;case"bulletlist":i[0]="ul";break;case"numberlist":i[0]="ol";break;case"listitem":i[0]="li";break;case"para":i[0]="p";break;case"markdown":i[0]="html",s&&delete s.references;break;case"code_block":i[0]="pre",r=s?2:1;var o=["code"];o.push.apply(o,i.splice(r,i.length-r)),i[r]=o;break;case"inlinecode":i[0]="code";break;case"img":i[1].src=i[1].href,delete i[1].href;break;case"linebreak":i[0]="br";break;case"link":i[0]="a";break;case"link_ref":i[0]="a";var u=e[s.ref];if(!u)return s.original;delete s.ref,s.href=u.href,u.title&&(s.title=u.title),delete s.original;break;case"img_ref":i[0]="img";var u=e[s.ref];if(!u)return s.original;delete s.ref,s.src=u.href,u.title&&(s.title=u.title),delete s.original}if(r=1,s){for(var l in i[1]){r=2;break}1===r&&i.splice(r,1)}for(;r<i.length;++r)i[r]=a(i[r],e,n);return i}function o(t){for(var e=d(t)?2:1;e<t.length;)"string"==typeof t[e]?e+1<t.length&&"string"==typeof t[e+1]?t[e]+=t.splice(e+1,1)[0]:++e:(o(t[e]),++e)}function u(t,e){function n(t){this.len_after=t,this.name="close_"+e}var r=t+"_state",i="strong"===t?"em_state":"strong_state";return function(s){if(this[r][0]===e)return this[r].shift(),[s.length,new n(s.length-e.length)];var a=this[i].slice(),o=this[r].slice();this[r].unshift(e);var u=this.processInline(s.substr(e.length)),l=u[u.length-1];if(this[r].shift(),l instanceof n){u.pop();var c=s.length-l.len_after;return[c,[t].concat(u)]}return this[i]=a,this[r]=o,[e.length,e]}}function l(t){for(var e=t.split(""),n=[""],r=!1;e.length;){var i=e.shift();switch(i){case" ":r?n[n.length-1]+=i:n.push("");break;case"'":case'"':r=!r;break;case"\\":i=e.shift();default:n[n.length-1]+=i}}return n}var c={};c.mk_block=function(t,r,i){1===arguments.length&&(r="\n\n");var s=new String(t);return s.trailing=r,s.inspect=n,s.toSource=e,void 0!==i&&(s.lineNumber=i),s};var h=c.isArray=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)};c.forEach=Array.prototype.forEach?function(t,e,n){return t.forEach(e,n)}:function(t,e,n){for(var r=0;r<t.length;r++)e.call(n||t,t[r],r,t)},c.isEmpty=function(t){for(var e in t)if(hasOwnProperty.call(t,e))return!1;return!0},c.extract_attr=function(t){return h(t)&&t.length>1&&"object"==typeof t[1]&&!h(t[1])?t[1]:void 0};var f=function(t){switch(typeof t){case"undefined":this.dialect=f.dialects.Gruber;break;case"object":this.dialect=t;break;default:if(!(t in f.dialects))throw new Error("Unknown Markdown dialect '"+String(t)+"'");this.dialect=f.dialects[t]}this.em_state=[],this.strong_state=[],this.debug_indent=""};f.dialects={};var p=f.mk_block=c.mk_block,h=c.isArray;f.parse=function(t,e){var n=new f(e);return n.toTree(t)},f.prototype.split_blocks=function(t){t=t.replace(/(\r\n|\n|\r)/g,"\n");var e,n=/([\s\S]+?)($|\n#|\n(?:\s*\n|$)+)/g,i=[],s=1;for(null!==(e=/^(\s*\n)/.exec(t))&&(s+=r(e[0]),n.lastIndex=e[0].length);null!==(e=n.exec(t));)"\n#"===e[2]&&(e[2]="\n",n.lastIndex--),i.push(p(e[1],e[2],s)),s+=r(e[0]);return i},f.prototype.processBlock=function(t,e){var n=this.dialect.block,r=n.__order__;if("__call__"in n)return n.__call__.call(this,t,e);for(var i=0;i<r.length;i++){var s=n[r[i]].call(this,t,e);if(s)return(!h(s)||s.length>0&&!h(s[0]))&&this.debug(r[i],"didn't return a proper array"),s}return[]},f.prototype.processInline=function(t){return this.dialect.inline.__call__.call(this,String(t))},f.prototype.toTree=function(t,e){var n=t instanceof Array?t:this.split_blocks(t),r=this.tree;try{for(this.tree=e||this.tree||["markdown"];n.length;){var i=this.processBlock(n.shift(),n);i.length&&this.tree.push.apply(this.tree,i)}return this.tree}finally{e&&(this.tree=r)}},f.prototype.debug=function(){var t=Array.prototype.slice.call(arguments);t.unshift(this.debug_indent),"undefined"!=typeof print&&print.apply(print,t),"undefined"!=typeof console&&"undefined"!=typeof console.log&&console.log.apply(null,t)},f.prototype.loop_re_over_block=function(t,e,n){for(var r,i=e.valueOf();i.length&&null!==(r=t.exec(i));)i=i.substr(r[0].length),n.call(this,r);return i},f.buildBlockOrder=function(t){var e=[];for(var n in t)"__order__"!==n&&"__call__"!==n&&e.push(n);t.__order__=e},f.buildInlinePatterns=function(t){var e=[];for(var n in t)if(!n.match(/^__.*__$/)){var r=n.replace(/([\\.*+?|()\[\]{}])/g,"\\$1").replace(/\n/,"\\n");e.push(1===n.length?r:"(?:"+r+")")}e=e.join("|"),t.__patterns__=e;var i=t.__call__;t.__call__=function(t,n){return void 0!==n?i.call(this,t,n):i.call(this,t,e)}};var d=c.extract_attr;f.renderJsonML=function(t,e){e=e||{},e.root=e.root||!1;var n=[];if(e.root)n.push(s(t));else for(t.shift(),!t.length||"object"!=typeof t[0]||t[0]instanceof Array||t.shift();t.length;)n.push(s(t.shift()));return n.join("\n\n")},f.toHTMLTree=function(t,e,n){"string"==typeof t&&(t=this.parse(t,e));var r=d(t),i={};r&&r.references&&(i=r.references);var s=a(t,i,n);return o(s),s},f.toHTML=function(t,e,n){var r=this.toHTMLTree(t,e,n);return this.renderJsonML(r)};var g={};g.inline_until_char=function(t,e){for(var n=0,r=[];;){if(t.charAt(n)===e)return n++,[n,r];if(n>=t.length)return null;var i=this.dialect.inline.__oneElement__.call(this,t.substr(n));n+=i[0],r.push.apply(r,i.slice(1))}},g.subclassDialect=function(t){function e(){}function n(){}return e.prototype=t.block,n.prototype=t.inline,{block:new e,inline:new n}};var v=c.forEach,d=c.extract_attr,p=c.mk_block,m=c.isEmpty,y=g.inline_until_char,_={block:{atxHeader:function(t,e){var n=t.match(/^(#{1,6})\s*(.*?)\s*#*\s*(?:\n|$)/);if(!n)return void 0;var r=["header",{level:n[1].length}];return Array.prototype.push.apply(r,this.processInline(n[2])),n[0].length<t.length&&e.unshift(p(t.substr(n[0].length),t.trailing,t.lineNumber+2)),[r]},setextHeader:function(t,e){var n=t.match(/^(.*)\n([-=])\2\2+(?:\n|$)/);if(!n)return void 0;var r="="===n[2]?1:2,i=["header",{level:r},n[1]];return n[0].length<t.length&&e.unshift(p(t.substr(n[0].length),t.trailing,t.lineNumber+2)),[i]},code:function(t,e){var n=[],r=/^(?: {0,3}\t| {4})(.*)\n?/;if(!t.match(r))return void 0;t:for(;;){var i=this.loop_re_over_block(r,t.valueOf(),function(t){n.push(t[1])});if(i.length){e.unshift(p(i,t.trailing));break t}if(!e.length)break t;if(!e[0].match(r))break t;n.push(t.trailing.replace(/[^\n]/g,"").substring(2)),t=e.shift()}return[["code_block",n.join("\n")]]},horizRule:function(t,e){var n=t.match(/^(?:([\s\S]*?)\n)?[ \t]*([-_*])(?:[ \t]*\2){2,}[ \t]*(?:\n([\s\S]*))?$/);if(!n)return void 0;var r=[["hr"]];if(n[1]){var i=p(n[1],"",t.lineNumber);r.unshift.apply(r,this.toTree(i,[]))}return n[3]&&e.unshift(p(n[3],t.trailing,t.lineNumber+1)),r},lists:function(){function t(t){return new RegExp("(?:^("+u+"{0,"+t+"} {0,3})("+s+")\\s+)|(^"+u+"{0,"+(t-1)+"}[ ]{0,4})")}function e(t){return t.replace(/ {0,3}\t/g,"    ")}function n(t,e,n,r){if(e)return void t.push(["para"].concat(n));var i=t[t.length-1]instanceof Array&&"para"===t[t.length-1][0]?t[t.length-1]:t;r&&t.length>1&&n.unshift(r);for(var s=0;s<n.length;s++){var a=n[s],o="string"==typeof a;o&&i.length>1&&"string"==typeof i[i.length-1]?i[i.length-1]+=a:i.push(a)}}function r(t,e){for(var n=new RegExp("^("+u+"{"+t+"}.*?\\n?)*$"),r=new RegExp("^"+u+"{"+t+"}","gm"),i=[];e.length>0&&n.exec(e[0]);){var s=e.shift(),a=s.replace(r,"");i.push(p(a,s.trailing,s.lineNumber))}return i}function i(t,e,n){var r=t.list,i=r[r.length-1];if(!(i[1]instanceof Array&&"para"===i[1][0]))if(e+1===n.length)i.push(["para"].concat(i.splice(1,i.length-1)));else{var s=i.pop();i.push(["para"].concat(i.splice(1,i.length-1)),s)}}var s="[*+-]|\\d+\\.",a=/[*+-]/,o=new RegExp("^( {0,3})("+s+")[ 	]+"),u="(?: {0,3}\\t| {4})";return function(s,u){function l(t){var e=a.exec(t[2])?["bulletlist"]:["numberlist"];return p.push({list:e,indent:t[1]}),e}var c=s.match(o);if(!c)return void 0;for(var h,f,p=[],d=l(c),g=!1,m=[p[0].list];;){for(var y=s.split(/(?=\n)/),_="",b="",k=0;k<y.length;k++){b="";var w=y[k].replace(/^\n/,function(t){return b=t,""}),x=t(p.length);if(c=w.match(x),void 0!==c[1]){_.length&&(n(h,g,this.processInline(_),b),g=!1,_=""),c[1]=e(c[1]);var E=Math.floor(c[1].length/4)+1;if(E>p.length)d=l(c),h.push(d),h=d[1]=["listitem"];else{var S=!1;for(f=0;f<p.length;f++)if(p[f].indent===c[1]){d=p[f].list,p.splice(f+1,p.length-(f+1)),S=!0;break}S||(E++,E<=p.length?(p.splice(E,p.length-E),d=p[E-1].list):(d=l(c),h.push(d))),h=["listitem"],d.push(h)}b=""}w.length>c[0].length&&(_+=b+w.substr(c[0].length))}_.length&&(n(h,g,this.processInline(_),b),g=!1,_="");var j=r(p.length,u);j.length>0&&(v(p,i,this),h.push.apply(h,this.toTree(j,[])));var A=u[0]&&u[0].valueOf()||"";if(!A.match(o)&&!A.match(/^ /))break;s=u.shift();var $=this.dialect.block.horizRule(s,u);if($){m.push.apply(m,$);break}v(p,i,this),g=!0}return m}}(),blockquote:function(t,e){if(!t.match(/^>/m))return void 0;var n=[];if(">"!==t[0]){for(var r=t.split(/\n/),i=[],s=t.lineNumber;r.length&&">"!==r[0][0];)i.push(r.shift()),s++;var a=p(i.join("\n"),"\n",t.lineNumber);n.push.apply(n,this.processBlock(a,[])),t=p(r.join("\n"),t.trailing,s)}for(;e.length&&">"===e[0][0];){var o=e.shift();t=p(t+t.trailing+o,o.trailing,t.lineNumber)}var u=t.replace(/^> ?/gm,""),l=(this.tree,this.toTree(u,["blockquote"])),c=d(l);return c&&c.references&&(delete c.references,m(c)&&l.splice(1,1)),n.push(l),n},referenceDefn:function(t,e){var n=/^\s*\[(.*?)\]:\s*(\S+)(?:\s+(?:(['"])(.*?)\3|\((.*?)\)))?\n?/;if(!t.match(n))return void 0;d(this.tree)||this.tree.splice(1,0,{});var r=d(this.tree);void 0===r.references&&(r.references={});var i=this.loop_re_over_block(n,t,function(t){t[2]&&"<"===t[2][0]&&">"===t[2][t[2].length-1]&&(t[2]=t[2].substring(1,t[2].length-1));var e=r.references[t[1].toLowerCase()]={href:t[2]};void 0!==t[4]?e.title=t[4]:void 0!==t[5]&&(e.title=t[5])});return i.length&&e.unshift(p(i,t.trailing)),[]},para:function(t){return[["para"].concat(this.processInline(t))]}},inline:{__oneElement__:function(t,e,n){var r,i;e=e||this.dialect.inline.__patterns__;var s=new RegExp("([\\s\\S]*?)("+(e.source||e)+")");if(r=s.exec(t),!r)return[t.length,t];if(r[1])return[r[1].length,r[1]];var i;return r[2]in this.dialect.inline&&(i=this.dialect.inline[r[2]].call(this,t.substr(r.index),r,n||[])),i=i||[r[2].length,r[2]]},__call__:function(t,e){function n(t){"string"==typeof t&&"string"==typeof i[i.length-1]?i[i.length-1]+=t:i.push(t)}for(var r,i=[];t.length>0;)r=this.dialect.inline.__oneElement__.call(this,t,e,i),t=t.substr(r.shift()),v(r,n);return i},"]":function(){},"}":function(){},__escape__:/^\\[\\`\*_{}\[\]()#\+.!\-]/,"\\":function(t){return this.dialect.inline.__escape__.exec(t)?[2,t.charAt(1)]:[1,"\\"]},"![":function(t){var e=t.match(/^!\[(.*?)\][ \t]*\([ \t]*([^")]*?)(?:[ \t]+(["'])(.*?)\3)?[ \t]*\)/);if(e){e[2]&&"<"===e[2][0]&&">"===e[2][e[2].length-1]&&(e[2]=e[2].substring(1,e[2].length-1)),e[2]=this.dialect.inline.__call__.call(this,e[2],/\\/)[0];var n={alt:e[1],href:e[2]||""};return void 0!==e[4]&&(n.title=e[4]),[e[0].length,["img",n]]}return e=t.match(/^!\[(.*?)\][ \t]*\[(.*?)\]/),e?[e[0].length,["img_ref",{alt:e[1],ref:e[2].toLowerCase(),original:e[0]}]]:[2,"!["]},"[":function k(t){var e=String(t),n=y.call(this,t.substr(1),"]");if(!n)return[1,"["];var k,r,i=1+n[0],s=n[1];t=t.substr(i);var a=t.match(/^\s*\([ \t]*([^"']*)(?:[ \t]+(["'])(.*?)\2)?[ \t]*\)/);if(a){var o=a[1];if(i+=a[0].length,o&&"<"===o[0]&&">"===o[o.length-1]&&(o=o.substring(1,o.length-1)),!a[3])for(var u=1,l=0;l<o.length;l++)switch(o[l]){case"(":u++;break;case")":0===--u&&(i-=o.length-l,o=o.substring(0,l))}return o=this.dialect.inline.__call__.call(this,o,/\\/)[0],r={href:o||""},void 0!==a[3]&&(r.title=a[3]),k=["link",r].concat(s),[i,k]}return a=t.match(/^\s*\[(.*?)\]/),a?(i+=a[0].length,r={ref:(a[1]||String(s)).toLowerCase(),original:e.substr(0,i)},k=["link_ref",r].concat(s),[i,k]):1===s.length&&"string"==typeof s[0]?(r={ref:s[0].toLowerCase(),original:e.substr(0,i)},k=["link_ref",r,s[0]],[i,k]):[1,"["]},"<":function(t){var e;return null!==(e=t.match(/^<(?:((https?|ftp|mailto):[^>]+)|(.*?@.*?\.[a-zA-Z]+))>/))?e[3]?[e[0].length,["link",{href:"mailto:"+e[3]},e[3]]]:"mailto"===e[2]?[e[0].length,["link",{href:e[1]},e[1].substr("mailto:".length)]]:[e[0].length,["link",{href:e[1]},e[1]]]:[1,"<"]},"`":function(t){var e=t.match(/(`+)(([\s\S]*?)\1)/);return e&&e[2]?[e[1].length+e[2].length,["inlinecode",e[3]]]:[1,"`"]},"  \n":function(){return[3,["linebreak"]]}}};_.inline["**"]=u("strong","**"),_.inline.__=u("strong","__"),_.inline["*"]=u("em","*"),_.inline._=u("em","_"),f.dialects.Gruber=_,f.buildBlockOrder(f.dialects.Gruber.block),f.buildInlinePatterns(f.dialects.Gruber.inline);var b=g.subclassDialect(_),d=c.extract_attr,v=c.forEach;b.processMetaHash=function(t){for(var e=l(t),n={},r=0;r<e.length;++r)if(/^#/.test(e[r]))n.id=e[r].substring(1);else if(/^\./.test(e[r]))n["class"]=n["class"]?n["class"]+e[r].replace(/./," "):e[r].substring(1);else if(/\=/.test(e[r])){var i=e[r].split(/\=/);n[i[0]]=i[1]}return n},b.block.document_meta=function(t){if(t.lineNumber>1)return void 0;if(!t.match(/^(?:\w+:.*\n)*\w+:.*$/))return void 0;d(this.tree)||this.tree.splice(1,0,{});var e=t.split(/\n/);for(var n in e){var r=e[n].match(/(\w+):\s*(.*)$/),i=r[1].toLowerCase(),s=r[2];this.tree[1][i]=s}return[]},b.block.block_meta=function(t){var e=t.match(/(^|\n) {0,3}\{:\s*((?:\\\}|[^\}])*)\s*\}$/);if(!e)return void 0;var n,r=this.dialect.processMetaHash(e[2]);if(""===e[1]){var i=this.tree[this.tree.length-1];if(n=d(i),"string"==typeof i)return void 0;n||(n={},i.splice(1,0,n));for(var s in r)n[s]=r[s];return[]}var a=t.replace(/\n.*$/,""),o=this.processBlock(a,[]);n=d(o[0]),n||(n={},o[0].splice(1,0,n));for(var s in r)n[s]=r[s];return o},b.block.definition_list=function(t,e){var n,r,i=/^((?:[^\s:].*\n)+):\s+([\s\S]+)$/,s=["dl"];if(!(r=t.match(i)))return void 0;for(var a=[t];e.length&&i.exec(e[0]);)a.push(e.shift());for(var o=0;o<a.length;++o){var r=a[o].match(i),u=r[1].replace(/\n$/,"").split(/\n/),l=r[2].split(/\n:\s+/);for(n=0;n<u.length;++n)s.push(["dt",u[n]]);for(n=0;n<l.length;++n)s.push(["dd"].concat(this.processInline(l[n].replace(/(\n)\s+/,"$1"))))}return[s]},b.block.table=function w(t){var e,n,r=function(t,e){e=e||"\\s",e.match(/^[\\|\[\]{}?*.+^$]$/)&&(e="\\"+e);for(var n,r=[],i=new RegExp("^((?:\\\\.|[^\\\\"+e+"])*)"+e+"(.*)");n=t.match(i);)r.push(n[1]),t=n[2];return r.push(t),r},i=/^ {0,3}\|(.+)\n {0,3}\|\s*([\-:]+[\-| :]*)\n((?:\s*\|.*(?:\n|$))*)(?=\n|$)/,s=/^ {0,3}(\S(?:\\.|[^\\|])*\|.*)\n {0,3}([\-:]+\s*\|[\-| :]*)\n((?:(?:\\.|[^\\|])*\|.*(?:\n|$))*)(?=\n|$)/;if(n=t.match(i))n[3]=n[3].replace(/^\s*\|/gm,"");else if(!(n=t.match(s)))return void 0;var w=["table",["thead",["tr"]],["tbody"]];n[2]=n[2].replace(/\|\s*$/,"").split("|");var a=[];for(v(n[2],function(t){a.push(t.match(/^\s*-+:\s*$/)?{align:"right"}:t.match(/^\s*:-+\s*$/)?{align:"left"}:t.match(/^\s*:-+:\s*$/)?{align:"center"}:{})}),n[1]=r(n[1].replace(/\|\s*$/,""),"|"),e=0;e<n[1].length;e++)w[1][1].push(["th",a[e]||{}].concat(this.processInline(n[1][e].trim())));return v(n[3].replace(/\|\s*$/gm,"").split("\n"),function(t){var n=["tr"];for(t=r(t,"|"),e=0;e<t.length;e++)n.push(["td",a[e]||{}].concat(this.processInline(t[e].trim())));w[2].push(n)},this),[w]},b.inline["{:"]=function(t,e,n){if(!n.length)return[2,"{:"];var r=n[n.length-1];if("string"==typeof r)return[2,"{:"];var i=t.match(/^\{:\s*((?:\\\}|[^\}])*)\s*\}/);if(!i)return[2,"{:"];var s=this.dialect.processMetaHash(i[1]),a=d(r);a||(a={},r.splice(1,0,a));for(var o in s)a[o]=s[o];return[i[0].length,""]},f.dialects.Maruku=b,f.dialects.Maruku.inline.__escape__=/^\\[\\`\*_{}\[\]()#\+.!\-|:]/,f.buildBlockOrder(f.dialects.Maruku.block),f.buildInlinePatterns(f.dialects.Maruku.inline),t.Markdown=f,t.parse=f.parse,t.toHTML=f.toHTML,t.toHTMLTree=f.toHTMLTree,t.renderJsonML=f.renderJsonML}(function(){return window.markdown={},window.markdown}());
!function(e,a){var n,o=this;n=o.Villain={},n.EventBus=n.EventBus||a.extend({},Backbone.Events),n.Blocks=n.Blocks||{},n.Editor=n.Editor||{},n.options=n.options||[],n.defaults={textArea:"#textarea",browseURL:"villain/browse/",uploadURL:"villain/upload/",imageseriesURL:"villain/imageseries/"};var l=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/;a.mixin({isURI:function(t){return l.test(t)},titleize:function(t){return null===t?"":(t=String(t).toLowerCase(),t.replace(/(?:^|\s|-)\S/g,function(t){return t.toUpperCase()}))},classify:function(t){return a.titleize(String(t).replace(/[\W_]/g," ")).replace(/\s/g,"")},classifyList:function(t){return a.map(t,function(t){return a.classify(t)})},capitalize:function(t){return t.charAt(0).toUpperCase()+t.substring(1).toLowerCase()},underscored:function(t){return a.trim(t).replace(/([a-z\d])([A-Z]+)/g,"$1_$2").replace(/[-\s]+/g,"_").toLowerCase()},trim:function(t){return t.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},reverse:function(t){return t.split("").reverse().join("")},flattern:function(t){var e={};return a.each(t,function(i,n){e[a.isArray(t)?i:n]=!0}),e},to_slug:function(t){return t.toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"-")}}),e.fn.visible=function(){return this.css("visibility","visible")},e.fn.invisible=function(){return this.css("visibility","hidden")},e.fn.visibilityToggle=function(){return this.css("visibility",function(t,e){return"visible"==e?"hidden":"visible"})},e.fn.caretToEnd=function(){var t,e;return t=document.createRange(),t.selectNodeContents(this[0]),t.collapse(!1),e=window.getSelection(),e.removeAllRanges(),e.addRange(t),this},e.fn.flash=function(t,e){t=t||1e3,e=e||2;var i=Math.floor(t/e);originalColor=this.css("background-color"),this.css("background-color","#ffffdd");for(var a=0;e>a;a++)this.fadeOut(i).fadeIn(i,function(){this.css("background-color","#ffffff")});return this},e.fn.shake=function(t,i,a){return t=t||3,i=i||10,a=a||300,this.each(function(){e(this).css("position","relative");for(var n=1;t>=n;n++)e(this).animate({left:-1*i},a/t/4).animate({left:i},a/t/2).animate({left:0},a/t/4)}),this},function(t){"use strict";var e={init:function(e){var i=t.extend({},t.fn.loadingOverlay.defaults,e),a=t(this).addClass(i.loadingClass),n='<div class="'+i.overlayClass+'"><p class="'+i.spinnerClass+'"><span class="'+i.iconClass+'"></span><span class="'+i.textClass+'">'+i.loadingText+"</span></p></div>";return a.data("loading-overlay")||a.prepend(t(n)).data("loading-overlay",!0),a},remove:function(e){var i=t.extend({},t.fn.loadingOverlay.defaults,e),a=t(this).data("loading-overlay",!1);return a.find("."+i.overlayClass).detach(),a.hasClass(i.loadingClass)?a.removeClass(i.loadingClass):a.find("."+i.loadingClass).removeClass(i.loadingClass),a},exposeMethods:function(){return e}};t.fn.loadingOverlay=function(i){return e[i]?e[i].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof i&&i?void t.error("Method "+i+" does not exist on jQuery.loadingOverlay"):e.init.apply(this,arguments)},t.fn.loadingOverlay.defaults={loadingClass:"loading",overlayClass:"loading-overlay",spinnerClass:"loading-spinner",iconClass:"loading-icon fa fa-circle-o-notch fa-spin",textClass:"loading-text",loadingText:""}}(jQuery),n.Plus=Backbone.View.extend({tagName:"div",className:"villain-add-block villain-droppable",blockSelectionTemplate:a.template('<div class="villain-block-selection"><%= content %></div>'),events:{"click .villain-add-block-button":"onClickAddBlock","click .villain-block-button":"onClickBlockButton"},initialize:function(t){this.store=t,this.$el.attr("data-blockstore",t),this.$el.attr("id",a.uniqueId("villain-plus-")),this.render()},render:function(){return this.$el.append('<button class="villain-add-block-button">+</button>'),this},onClickBlockButton:function(t){t.preventDefault(),$button=e(t.currentTarget),blockType=$button.data("type"),blockStore=this.store,BlockClass=n.BlockRegistry.getBlockClassByType(blockType),block=new BlockClass(!1,blockStore),block.$el.insertAfter($button.parent().parent()),block.$el.after(block.renderPlus().$el),block.hasTextBlock()&&block.setCaret(),block.scrollTo(),$button.parent().prev().show(),$button.parent().remove()},onClickAddBlock:function(t){t.preventDefault(),$addBlockButton=e(t.currentTarget),$addBlockButton.hide(),blockId=$addBlockButton.parent().data("after-block-id"),blockSelection=this.blockSelectionTemplate({content:this.getButtons(blockId)}),$addBlockButton.parent().append(blockSelection)},getButtons:function(t){for(html="",i=0;i<n.BlockRegistry.Map.length;++i)blockName=n.BlockRegistry.Map[i],b=n.BlockRegistry.getBlockClassByType(blockName),a.isUndefined(b)?console.error("Villain: Undefined block ",blockName):b.hasOwnProperty("getButton")?html+=b.getButton(t):console.log("// No button found for "+blockName);return html}}),n.BlockStore=[],n.BlockStore.stores=[],n.BlockStore.count=1,n.BlockStore.getId=function(){return id=n.BlockStore.count,n.BlockStore.count++,id},n.BlockStore.getBlockById=function(t,e){return block=a.find(n.BlockStore[t],function(t){return t.id==e}),block&&block.hasOwnProperty("object")?block.object:!1},n.BlockStore.add=function(t,e,i){n.BlockStore[t].push({id:e,object:i})},n.BlockStore.del=function(t,e){n.BlockStore[t]=a.filter(n.BlockStore[t],function(t){return parseInt(t.id)!==parseInt(e)})},n.BlockStore.delStore=function(t){a.each(n.BlockStore[t],function(t){t.object.destroy()}),n.BlockStore[t]=[];var e=n.BlockStore.stores.indexOf(t);n.BlockStore.stores.splice(e,1)},n.BlockStore.create=function(t){n.BlockStore[t]=[],n.BlockStore.stores.push(t)},n.BlockStore.listAll=function(){for(var t=0;t<n.BlockStore.stores.length;t++)console.log(n.BlockStore.stores[t]),console.log(n.BlockStore[n.BlockStore.stores[t]])},n.Block=Backbone.View.extend({tagName:"div",className:"villain-block-wrapper",type:"base",template:a.template("base"),store:"main",wrapperTemplate:a.template(['<div class="villain-block-inner"><%= content %><%= actions %></div>'].join("\n")),actionsTemplate:a.template(['<div class="villain-actions">','  <div class="villain-action-button villain-action-button-setup">','    <i class="fa fa-cogs"></i>',"  </div>",'  <div class="villain-action-button villain-action-button-del">','    <i class="fa fa-trash"></i>',"  </div>",'  <div class="villain-action-button villain-action-button-move" draggable="true">','    <i class="fa fa-arrows-alt"></i>',"  </div>","</div>"].join("\n")),setupTemplate:a.template('<div class="villain-setup-block" />'),events:{"dragstart .villain-action-button-move":"onDragStart","click .villain-action-button-move":"onClickMove","click .villain-action-button-del":"onClickDelete","mouseover .villain-block-inner":"onMouseOver","mouseout .villain-block-inner":"onMouseOut","paste .villain-text-block":"onPaste","mouseup .villain-text-block":"onMouseUp","click .villain-text-block":"onClick","click .villain-action-button-setup":"onSetupClick"},initialize:function(t,e){this.data=t||null,this.dataId=this.getIdFromBlockStore(),this.$el.attr("data-block-id",this.dataId),this.$el.attr("data-block-type",this.type),this.$el.attr("id","villain-block-"+this.dataId),e&&(this.store=e),this.$el.attr("data-blockstore",this.store),this.id="villain-block-"+this.dataId,this.addToBlockStore(e),this.render()},render:function(){return html=this.hasData()?this.renderEditorHtml():this.renderEmpty(),this.el.innerHTML=html,this.setSections(),this.addSetup(),this},onClick:function(){var t=this.getSelectedText();""===t&&n.EventBus.trigger("formatpopup:hide")},onSetupClick:function(t){t.stopPropagation(),$button=this.$(".villain-action-button-setup"),$button.hasClass("active")?($button.removeClass("active"),this.hideSetup()):($button.addClass("active"),this.showSetup())},onMouseUp:function(){var t=this.getSelectedText();""!==t?n.EventBus.trigger("formatpopup:show",this):n.EventBus.trigger("formatpopup:hide")},getSelectedText:function(){var t="";return window.getSelection?t=window.getSelection():document.getSelection?t=document.getSelection():document.selection&&(t=document.selection.createRange().text),t.toString()},deleteBlock:function(){n.BlockStore.del(this.store,this.dataId),this.destroy()},loading:function(){this.$el.loadingOverlay()},done:function(){this.$el.loadingOverlay("remove")},addToPathName:function(t){if("/"===t.charAt(0))return t;var e="/"==window.location.pathname.slice(-1)?"":"/",i=window.location.pathname+e+t;return i},destroy:function(){this.$el.next(".villain-add-block").remove(),this.undelegateEvents(),this.$el.removeData().unbind(),this.remove(),Backbone.View.prototype.remove.call(this)},onClickDelete:function(t){this.deleteBlock(),t.stopPropagation()},onClickMove:function(t){t.stopPropagation()},onDragStart:function(t){t.originalEvent.dataTransfer.setDragImage(this.$el.get(0),this.$el.width(),this.$el.height()),t.originalEvent.dataTransfer.setData("Text",this.dataId),t.stopPropagation()},onMouseOver:function(){event.stopPropagation(),this.$inner.addClass("hover"),this.$inner.children(".villain-actions").visible()},onMouseOut:function(){this.$inner.removeClass("hover"),this.$inner.children(".villain-actions").invisible()},onPaste:function(t){var i=!1;if(t&&t.originalEvent.clipboardData&&t.originalEvent.clipboardData.getData){var a="",o=t.originalEvent.clipboardData.types;if(e.isArray(o))for(var l=0;l<o.length;l++)a+=o[l]+";";else a=o;if(/text\/html/.test(a)?clipboardHTML=t.originalEvent.clipboardData.getData("text/html"):/text\/rtf/.test(a)&&n.browser.safari?clipboardHTML=t.originalEvent.clipboardData.getData("text/rtf"):/text\/plain/.test(a)&&!n.browser.mozilla&&(clipboardHTML=t.originalEvent.clipboardData.getData("text/plain").replace(/\n/g,"<br/>")),""!==this.clipboardHTML?i=!0:this.clipboardHTML=null,i)return cleanHtml=n.Editor.processPaste(clipboardHTML),t.stopPropagation(),t.preventDefault(),n.Editor.pasteHtmlAtCaret(cleanHtml),!1}},getIdFromBlockStore:function(){return n.BlockStore.getId()},doRenderCallback:function(){},hasTextBlock:function(){return 0===this.$(".villain-text-block").length?!1:!0},setCaret:function(){var t,e;t=document.createRange(),t.selectNodeContents(this.getTextBlock()[0]),t.collapse(!1),e=window.getSelection(),e.removeAllRanges(),e.addRange(t)},scrollTo:function(){e("html, body").animate({scrollTop:this.$el.offset().top-75},300,"linear")},flash:function(){},getJSON:function(){return[]},addToBlockStore:function(t){n.BlockStore.add(t?t:"main",this.dataId,this)},setData:function(t){this.data=t},getData:function(){return this.data},setDataProperty:function(t,e){data=this.getData(),data[t]=e,this.setData(data)},hasData:function(){return this.data?!a.isEmpty(this.data):!1},refreshBlock:function(){return html=this.renderEditorHtml(),this.el.innerHTML=html,this.addSetup(),this},refreshContentBlock:function(){return block=this.renderContentBlockHtml(),this.$content.html(e(block).html()),this.$content},setSections:function(){this.$inner=this.$(".villain-block-inner"),this.$content=this.$(".villain-content")},addSetup:function(){this.setup?(this.$inner.prepend(this.setupTemplate()),this.$setup=this.$(".villain-setup-block"),this.$(".villain-action-button-setup").show(),this.setup()):this.$(".villain-action-button-setup").hide()},clearSetup:function(){this.$setup.empty()},getTextBlock:function(){return this.$textBlock=this.$(".villain-text-block"),this.$textBlock},getTextBlockInner:function(){return tb=this.getTextBlock(),tb.html()},clearInsertedStyles:function(t){var e=t.target;e.removeAttribute("style")},renderEditorHtml:function(){},renderEmpty:function(){},renderPlus:function(){return addblock=new n.Plus(this.store)},showSetup:function(){innerHeight=this.$inner.height(),this.$content.hide(),$button=this.$(".villain-action-button-setup"),$button.addClass("active"),this.$setup.show(),this.$setup.height()<innerHeight&&this.$setup.height(innerHeight)},hideSetup:function(){this.$setup.hide(),this.$setup.height(""),$button=this.$(".villain-action-button-setup"),$button.removeClass("active"),this.$content.show()}}),n.Blocks.Text=n.Block.extend({type:"text",template:a.template('<div class="villain-text-block villain-content" contenteditable="true" data-text-type="<%= type %>"><%= content %></div>'),renderEditorHtml:function(){return blockTemplate=this.renderContentBlockHtml(),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderContentBlockHtml:function(){return text=this.getTextBlockInner()?this.getTextBlockInner():this.data.text,this.template({content:n.toHTML(text),type:this.data.type})},renderEmpty:function(){return blockTemplate=this.template({content:"Text",type:"paragraph"}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},getJSON:function(){return textNode=n.toMD(this.getTextBlockInner()),data=this.getData(),json={type:this.type,data:{text:textNode,type:data.type}}},getHTML:function(){return textNode=this.getTextBlock().html(),markdown.toHTML(textNode)},setup:function(){data=this.getData(),data.hasOwnProperty("type")||this.setDataProperty("type","paragraph"),type=this.data.type,this.$setup.hide();var t="";types=["paragraph","lead"];for(i in types)selected="",type===types[i]&&(selected=' checked="checked"'),t+='<label><input type="radio" name="text-type" value="'+types[i]+'"'+selected+">"+types[i]+"</label>";this.$setup.append(e(["<label>Type</label>",t].join("\n"))),this.$setup.find("input[type=radio]").on("change",e.proxy(function(t){this.setDataProperty("type",e(t.target).val()),this.refreshContentBlock(),this.$content.attr("data-text-type",e(t.target).val())},this))}},{getButton:function(e){var i="text";return(t=a.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-paragraph"></i>',"<p>text</p>","</button>"].join("\n")))({id:e,type:i})}}),n.Blocks.Blockquote=n.Block.extend({type:"blockquote",template:a.template('<div class="villain-quote-block villain-content"><blockquote contenteditable="true"><%= content %></blockquote><cite contenteditable="true"><%= cite %></cite></div>'),renderEditorHtml:function(){return blockTemplate=this.renderContentBlockHtml(),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderContentBlockHtml:function(){return text=this.getTextBlockInner()?this.getTextBlockInner():this.data.text,this.template({content:n.toHTML(text),cite:this.data.cite})},renderEmpty:function(){return blockTemplate=this.template({content:"quote",cite:"author"}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},getJSON:function(){return quote=this.$content.find("blockquote")[0].outerHTML,cite=e("cite",this.$content).html(),textNode=n.toMD(quote),data=this.getData(),json={type:this.type,data:{text:textNode,cite:cite}}},getHTML:function(){return textNode=this.getTextBlock().html(),markdown.toHTML(textNode)}},{getButton:function(e){var i="blockquote";return(t=a.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-quote-right"></i>',"<p>quote</p>","</button>"].join("\n")))({id:e,type:i})}}),n.Blocks.Divider=n.Block.extend({type:"divider",template:a.template('<div class="villain-divider-block villain-content"><hr></div>'),renderEditorHtml:function(){return blockTemplate=this.template(),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderEmpty:function(){return blockTemplate=this.template(),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},getJSON:function(){return json={type:this.type,data:{text:"--------------------"}}},getHTML:function(){return"<hr>"}},{getButton:function(e){var i="divider";return(t=a.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-minus"></i>',"<p>hr</p>","</button>"].join("\n")))({id:e,type:i})}}),n.Blocks.Header=n.Block.extend({type:"header",template:a.template(['<div class="villain-text-block villain-text-block-header villain-content" data-header-level="<%= level %>" contenteditable="true">',"<%= content %>","</div>"].join("\n")),renderEditorHtml:function(){return blockTemplate=this.renderContentBlockHtml(),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderContentBlockHtml:function(){return this.template({content:this.data.text,level:this.data.level})},renderEmpty:function(){return blockTemplate=this.template({content:"Header",level:1}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},setup:function(){data=this.getData(),data.hasOwnProperty("level")||this.setDataProperty("level",1),level=data.level,this.$setup.hide();var t="";levels=[1,2,3,4,5];for(i in levels)selected="",parseInt(level)===parseInt(levels[i])&&(selected=' checked="checked"'),t+='<label><input type="radio" name="header-size" value="'+levels[i]+'"'+selected+">H"+levels[i]+"</label>";this.$setup.append(e(["<label>Størrelse</label>",t].join("\n"))),this.$setup.find("input[type=radio]").on("change",e.proxy(function(t){this.setDataProperty("level",e(t.target).val()),this.refreshContentBlock(),this.$content.attr("data-header-level",e(t.target).val())},this))},getData:function(){return data=this.data,data.text=n.toMD(this.getTextBlock().html()).trim(),data},getJSON:function(){return json={type:this.type,data:this.getData()}},getHTML:function(){return textNode=this.getTextBlock().html(),"<h3>"+markdown.toHTML(textNode)+"</h3>"}},{getButton:function(e){var i="header";return(t=a.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-header"></i>',"<p>h1-6</p>","</button>"].join("\n")))({id:e,type:i})}}),n.Blocks.List=n.Block.extend({type:"list",template:a.template(['<div class="villain-text-block villain-text-block-list villain-content" contenteditable="true">',"<%= content %>","</div>"].join("\n")),events:{"keyup .villain-content":"onKeyUp"},onKeyUp:function(t){console.log(t.currentTarget.innerHTML),(""==t.currentTarget.innerText||"\n"==t.currentTarget.innerText)&&(console.log("empty!"),t.currentTarget.innerHTML="<ul><li><br></li></ul>")},renderEditorHtml:function(){return blockTemplate=this.template({content:markdown.toHTML(this.data.text)}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderEmpty:function(){return blockTemplate=this.template({content:"<ul><li>list</li></ul>"}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},getJSON:function(){return textNode=this.getTextBlock().html().replace(/<\/li>/gm,"\n").replace(/<\/?[^>]+(>|$)/g,"").replace(/^(.+)$/gm," - $1"),json={type:this.type,data:{text:textNode}}},getHTML:function(){return textNode=this.getTextBlock().html(),"<h3>"+markdown.toHTML(textNode)+"</h3>"},toMarkdown:function(t){return t.replace(/<\/li>/gm,"\n").replace(/<\/?[^>]+(>|$)/g,"").replace(/^(.+)$/gm," - $1")}},{getButton:function(e){var i="list";return(t=a.template(['<button class="villain-block-button" ','        data-type="<%= type %>" ','        data-after-block-id="<%= id %>"',">",'   <i class="fa fa-list-ul"></i>',"<p>list</p>","</button>"].join("\n")))({id:e,type:i})}}),n.Blocks.Image=n.Block.extend({type:"image",template:a.template('<div class="villain-image-block villain-content"><img class="img-responsive" src="<%= url %>" /></div>'),events:{"drop .villain-image-dropper i":"onDropImage","dragenter .villain-image-dropper i":"onDragEnter","dragleave .villain-image-dropper i":"onDragLeave","dragover .villain-image-dropper i":"onDragOver","click .villain-image-dropper-upload":"onUploadClickAfterDrop"},initialize:function(t,e){n.Block.prototype.initialize.apply(this,[t,e]),a.extend(this.events,n.Block.prototype.events)},renderEditorHtml:function(){return blockTemplate=this.renderContentBlockHtml(),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderContentBlockHtml:function(){return this.template({url:this.data.url})},renderEmpty:function(){return blockTemplate=this.template({url:"http://placehold.it/1150x400"}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},onUploadClickAfterDrop:function(t){var i=[this.dataId,(new Date).getTime(),"raw"].join("-"),l=new FormData;return t.preventDefault(),this.loading(),img=this.$setup.find(".villain-image-dropper img"),this.file?(l.append("name",this.file.name),l.append("image",this.file),l.append("uid",i),o=this,e.ajax({type:"post",dataType:"json",accepts:{json:"text/json"},url:this.addToPathName(n.options.uploadURL),data:l,cache:!1,contentType:!1,processData:!1,xhr:function(){var t=e.ajaxSettings.xhr();return t.upload&&t.upload.addEventListener("progress",o.progressHandlingFunction,!1),t}}).done(e.proxy(function(t){if("200"==t.status&&(this.$setup.append('<div class="villain-message success">Bildet er lastet opp</div>'),this.$setup.find(".villain-image-dropper-upload").remove(),this.$setup.find(".villain-image-dropper").remove(),t.hasOwnProperty("image")&&(imageData=t.image,$image=e('<img src="'+imageData.src+'" />'),this.$setup.append($image),json={url:imageData.src,sizes:imageData.sizes},this.setData(json)),t.hasOwnProperty("uid")&&(i=t.uid),t.hasOwnProperty("form"))){var n="";inputTemplate=a.template(["<label><%= label %></label>",'<input type="<%= type %>" ','       value="<%= value %>" ','       name="<%= name %>"',"/>"].join("\n"));for(var l=0;l<t.form.fields.length;l++)field=t.form.fields[l],n+=inputTemplate({label:field.label,type:field.type,value:field.value,name:field.name});formTemplate=a.template(['<form method="<%= method %>" ','      action="<%= action %>" ','      class="villain-form" ','      name="<%= name %>"',">","<%= inputs %>","</form>"].join("\n")),form=formTemplate({method:t.form.method,action:o.addToPathName(t.form.action),name:t.form.name,inputs:n}),$form=e(form),$submitButton=e('<input type="submit" name="'+t.form.name+'-submit" value="Lagre" />'),$submitButton.on("click",function(a){a.preventDefault(),serializedForm=$form.serialize(),imagedata=new FormData,imagedata.append("form",serializedForm),imagedata.append("uid",i),e.ajax({type:"post",url:o.addToPathName(t.form.action),data:imagedata,cache:!1,contentType:!1,processData:!1,dataType:"json"}).done(e.proxy(function(t){200==t.status&&(json=o.getData(),json.title=t.title,json.credits=t.credits,json.link="",o.setData(json),o.refreshContentBlock(),o.hideSetup(),o.setup())},this))}),$form.append($submitButton),this.$setup.append($form)}},this)).fail(e.proxy(function(){alert("Feil fra server under opplasting.")},this)).always(e.proxy(function(){})),void this.done()):(this.done(),!1)},progressHandlingFunction:function(t){t.lengthComputable},onDragEnter:function(t){this.$(".villain-image-dropper i").addClass("drop-hover"),t.preventDefault()},onDragLeave:function(t){this.$(".villain-image-dropper i").removeClass("drop-hover"),t.preventDefault()},onDragOver:function(t){t.preventDefault()},onDropImage:function(t){t.preventDefault(),this.$(".villain-image-dropper i").removeClass("drop-hover"),dataTransfer=t.originalEvent.dataTransfer;var i=dataTransfer.files[0],a="undefined"!=typeof URL?URL:"undefined"!=typeof webkitURL?webkitURL:null;/image/.test(i.type)&&(this.$(".villain-image-dropper").html(e("<img>",{src:a.createObjectURL(i)})),$form=e(['<form enctype="multipart/form-data" ','encoding="multipart/form-data" action="upload/image" ','method="post" id="villain-upload-form-'+this.dataId+'">','<input id="villain-upload-file-'+this.dataId+'" ','type="file" ','name="villain-upload-file-'+this.dataId+'" ','accept="image/*">',"</form>"].join("\n")),this.$setup.append("<hr>"),this.$setup.append('<button class="villain-image-dropper-upload">Last opp og lagre</button>'),this.file=i)},getJSON:function(){return data=this.getData(),json={type:this.type,data:{url:data.url,sizes:data.sizes,title:data.title||"",credits:data.credits||"",link:data.link||""}}},getHTML:function(){return url=this.$("img").attr("src"),this.template({url:url})},setup:function(){if(o=this,this.hasData()){this.clearSetup(),data=this.getData(),$meta=e(['<label for="title">Tittel</label><input value="'+data.title+'" type="text" name="title" />','<label for="credits">Kreditering</label><input value="'+data.credits+'" type="text" name="credits" />','<label for="link">URL</label><input value="'+data.link+'" type="text" name="link" />'].join("\n")),this.$setup.append($meta),this.$setup.find('input[name="title"]').on("keyup",a.debounce(function(){o.setDataProperty("title",e(this).val())},700,!1)),this.$setup.find('input[name="credits"]').on("keyup",a.debounce(function(){o.setDataProperty("credits",e(this).val())},700,!1)),this.$setup.find('input[name="link"]').on("keyup",a.debounce(function(){o.setDataProperty("link",e(this).val())},700,!1)),this.$setup.append(e("<label>Størrelse</label>"));for(var t in data.sizes)data.sizes.hasOwnProperty(t)&&(checked="",data.sizes[t]==data.url&&(checked=' checked="checked"'),$radio=e('<label for="'+t+'"><input type="radio" name="imagesize" value="'+data.sizes[t]+'"'+checked+" />"+t+"</label>"),this.$setup.append($radio));this.$setup.find("input[type=radio]").on("change",e.proxy(function(t){this.setUrl(e(t.target).val())},this)),this.hideSetup()}else this.$(".villain-image-block").hide(),$imageDropper=e(['<div class="villain-image-dropper"><i class="fa fa-image"></i>',"<div>Dra bildet du vil laste opp hit</div>","<div><hr></div>","<div>",'<button class="villain-image-browse-button">Hent bilde fra server</button>',"</div>","</div>"].join("\n")),$imageDropper.find(".villain-image-browse-button").on("click",e.proxy(this.onImageBrowseButton,this)),this.$setup.append($imageDropper),this.$setup.show()},setUrl:function(t){this.setDataProperty("url",t),this.refreshContentBlock()},onImageBrowseButton:function(t){t.preventDefault(),this.loading(),e.ajax({type:"get",url:this.addToPathName(n.options.browseURL),cache:!1,contentType:!1,processData:!1,dataType:"json"}).done(e.proxy(function(t){if(200!=t.status)return alert("Ingen bilder fantes."),this.done(),!1;if(!t.hasOwnProperty("images"))return!1;$images=e("<div />");for(var i=0;i<t.images.length;i++)img=t.images[i],$store_img=e('<img src="'+img.thumb+'" />'),$store_img.data("sizes",img.sizes).data("large",img.src).data("title",img.title).data("credits",img.credits),$images.append($store_img);$images.on("click","img",e.proxy(function(i){this.setData({url:e(i.target).data("large"),title:e(i.target).data("title"),credits:e(i.target).data("credits"),sizes:e(i.target).data("sizes")}),t=this.getData(),this.refreshContentBlock(),this.hideSetup(),this.setup()},this)),this.$setup.html(""),this.$setup.append('<div class="villain-message success">Klikk på bildet du vil sette inn</div>'),this.$setup.append($images),this.done()},this))},onUploadImagesButton:function(t){var e=t.target.files,i="undefined"!=typeof URL?URL:"undefined"!=typeof webkitURL?webkitURL:null;fileList=[];for(var a=0;a<e.length;a++){var n=e[a];fileList.push(['<div class="three">','<div class="center-cropped" style="background-image: url(',i.createObjectURL(n),');"></div>',"</div>"].join("\n"))}listHTML='<div style="margin-top: 10px;" class="wrapper"><div class="row">';for(var o=0;o<fileList.length;o++)listHTML+=o&&o%4===0?'</div><div style="margin-top: 15px" class="row">'+fileList[o]:fileList[o];listHTML+="</div></div>",this.$setup.append(listHTML)}},{getButton:function(e){var i="image";return(t=a.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-file-image-o"></i>',"<p>img</p>","</button>"].join("\n")))({id:e,type:i})}}),n.Blocks.Slideshow=n.Block.extend({type:"slideshow",template:a.template(['<div class="villain-slideshow-block villain-content" contenteditable="false">',"<h4>Slideshow</h4>","<%= content %>","</div>"].join("\n")),renderEditorHtml:function(){return blockTemplate=this.renderContentBlockHtml(),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderContentBlockHtml:function(){return images=this.renderDataImages(),this.template({content:images})},renderDataImages:function(){var t=this.getData();if(a.isUndefined(t.images))return"";for(var e="",i=0;i<t.images.length;i++)img=t.images[i],e+='<img src="'+t.media_url+"/"+img.sizes.thumb+'" />';return e},renderEmpty:function(){return blockTemplate=this.template({content:'<i class="fa fa-th"></i>'}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},getAllImageseries:function(){o=this,$select=this.$setup.find(".imageserie-select"),e.ajax({type:"get",dataType:"json",accepts:{json:"text/json"},url:this.addToPathName(n.options.imageseriesURL),cache:!1,contentType:!1,processData:!1,xhr:function(){var t=e.ajaxSettings.xhr();return t.upload&&t.upload.addEventListener("progress",o.progressHandlingFunction,!1),t}}).done(e.proxy(function(t){"200"==t.status&&($select.append(o.buildOptions(t.series,!0)),a.isUndefined(o.data.imageseries)||$select.val(o.data.imageseries).change())}))},getImageseries:function(t){e.ajax({type:"get",dataType:"json",accepts:{json:"text/json"},url:this.addToPathName(n.options.imageseriesURL),data:{series:t},cache:!1,contentType:!1,xhr:function(){var t=e.ajaxSettings.xhr();return t.upload&&t.upload.addEventListener("progress",o.progressHandlingFunction,!1),t}}).done(e.proxy(function(t){if("200"==t.status){var i={};if(i.imageseries=t.series,i.media_url=t.media_url,i.images=t.images,o.$setup.find(".imageserie-size-select").length>0);else{var n='<label for="imageserie-size">Str:</label><select class="imageserie-size-select"         name="imageserie-size"></select>';o.$setup.append(n)}var l=o.$setup.find(".imageserie-size-select");l.html(""),l.append(o.buildOptions(t.sizes,!0)),a.isUndefined(o.data.size)||(l.val(o.data.size).change(),i.size=o.data.size),l.on("change",function(){i.size=e(this).val(),o.hideSetup()}),o.setData(i),o.refreshContentBlock()}}))},buildOptions:function(t,e){html=e?'<option disabled="disabled" selected="selected">---</option>':"";for(var i=0;i<t.length;i++)val=t[i],html+='<option value="'+val+'">'+val+"</option>";return html},setup:function(){if(this.hasData()){this.$setup.hide();var t='<select class="imageserie-select" name="imageserie"></select>';this.$setup.append(e(['<label for="imageserie">Bildeserie</label>',t].join("\n"))),$select=this.$setup.find(".imageserie-select"),$select.on("change",function(){o.getImageseries(e(this).val())}),this.getAllImageseries()}else{this.$content.hide(),o=this,data=this.getData();var t='<select class="imageserie-select" name="imageserie"></select>';this.$setup.append(e(['<label for="imageserie">Bildeserie</label>',t].join("\n"))),$select=this.$setup.find(".imageserie-select"),$select.on("change",function(){o.getImageseries(e(this).val())}),this.getAllImageseries()}},getData:function(){return data=this.data},getJSON:function(){var t=this.getData();return delete t.images,delete t.media_url,json={type:this.type,data:t}},getHTML:function(){return textNode=this.getTextBlock().html(),"<h3>"+markdown.toHTML(textNode)+"</h3>"}},{getButton:function(e){var i="slideshow";return(t=a.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-th"></i>',"<p>slides</p>","</button>"].join("\n")))({id:e,type:i})
}}),n.Blocks.Video=n.Block.extend({type:"video",providers:{vimeo:{regex:/(?:http[s]?:\/\/)?(?:www.)?vimeo.com\/(.+)/,html:['<iframe src="{{protocol}}//player.vimeo.com/video/{{remote_id}}?title=0&byline=0" ','width="580" height="320" frameborder="0"></iframe>'].join("\n")},youtube:{regex:/(?:http[s]?:\/\/)?(?:www.)?(?:(?:youtube.com\/watch\?(?:.*)(?:v=))|(?:youtu.be\/))([^&].+)/,html:['<iframe src="{{protocol}}//www.youtube.com/embed/{{remote_id}}" ','width="580" height="320" frameborder="0" allowfullscreen></iframe>'].join("\n")}},template:a.template('<div class="villain-video-block villain-content"><%= content %></div>'),events:{"click .villain-setup-block button":"onClick"},onClick:function(t){t.preventDefault(),videoUrl=this.$(".villain-video-setup-url").val(),a.isURI(videoUrl)&&(embedString=this.buildString(videoUrl),this.$content.html(embedString),this.hideSetup())},buildString:function(t){var e,i;if(a.each(this.providers,function(n,o){e=n.regex.exec(t),null===e||a.isUndefined(e[1])||(i={source:o,remote_id:e[1]},this.setData(i))},this),this.providers.hasOwnProperty(i.source)){var n=this.providers[i.source].html.replace("{{protocol}}",window.location.protocol).replace("{{remote_id}}",i.remote_id).replace("{{width}}","100%");return n}},initialize:function(t,e){n.Block.prototype.initialize.apply(this,[t,e]),a.extend(this.events,n.Block.prototype.events)},renderEditorHtml:function(){if(this.providers.hasOwnProperty(this.data.source)){var t=this.providers[this.data.source].html.replace("{{protocol}}",window.location.protocol).replace("{{remote_id}}",this.data.remote_id).replace("{{width}}","100%");return blockTemplate=this.template({content:t}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})}},renderEmpty:function(){return blockTemplate=this.template({content:""}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},getJSON:function(){return url=this.$("img").attr("src"),json={type:this.type,data:this.data}},getHTML:function(){return url=this.$("img").attr("src"),this.template({url:url})},setup:function(){this.hasData()||(this.$(".villain-video-block").hide(),videoSetup=e(['<div class="villain-video-setup-icon">','<i class="fa fa-video-camera"></i>',"<div>Lim inn link til youtube eller vimeo, f.eks http://www.youtube.com/watch?v=jlbunmCbTBA</div>","</div>",'<div class="villain-video-setup-input-wrapper">','<input type="text" name="villain-video-setup-url" class="villain-video-setup-url" />',"</div>","<div><hr></div>",'<div style="text-align: center;"><button>Hent video</button></div>'].join("\n")),this.$setup.append(videoSetup),this.$setup.show())}},{getButton:function(e){var i="video";return(t=a.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-video-camera"></i>',"<p>video</p>","</button>"].join("\n")))({id:e,type:i})}}),n.Blocks.Columns=n.Block.extend({type:"columns",template:a.template('<div class="row"></div>'),columnTemplate:a.template('<div class="<%= columnClass %>"></div>'),events:{'keyup input[name="villain-columns-number"]':"_updateColumnCount","click button.villain-columns-apply":"_applyColumnCount"},initialize:function(t,e){n.Block.prototype.initialize.apply(this,[t,e]),a.extend(this.events,n.Block.prototype.events)},deleteBlock:function(){n.BlockStore.hasOwnProperty(this.store)&&n.BlockStore.delStore(this.store),n.BlockStore.del("main",this.dataId),this.destroy()},renderBlock:function(t){return t.$parent?void(t.$parent.attr("id")===this.$el.attr("id")&&this.$el.append(t.el)):!1},render:function(){return n.BlockStore.create(this.id),this.store=this.id,this.$el.attr("data-blockstore",this.store),blockTemplate=this.template({content:this.data}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate}),this.el.innerHTML=wrapperTemplate,this.$inner=this.$(".villain-block-inner"),this.$content=this.$(".row"),this.data?this.renderEditorHtml():this.renderEmpty(),this.setup&&(this.$inner.prepend(this.setupTemplate()),this.$setup=this.$(".villain-setup-block"),this.setup()),this},renderEditorHtml:function(){return this.parseRow(),blockTemplate=this.template({content:this.data}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate}),this},renderEmpty:function(){return blockTemplate=this.template({content:this.data}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate}),this},getRow:function(){return this.$row?this.$row:(this.$row=this.$(".row"),this.$row)},getColumns:function(t){return this.getRow().children(t)},getColumn:function(t){return this.getRow().children(":eq("+t+")")},parseRow:function(){$row=this.getRow();for(var t=0;t<=this.data.length-1;t++){columnClass=this.data[t].class,columnData=this.data[t].data,$column=e('<div class="'+columnClass+'"></div>'),$row.append($column),$column=this.getColumn(t),addblock=new n.Plus(this.store),$column.append(addblock.$el);for(var i=0;i<columnData.length;i++)(BlockClass=n.BlockRegistry.getBlockClassByType(columnData[i].type))!==!1&&(block=new BlockClass(columnData[i].data,this.store),$column.append(block.$el),addblock=new n.Plus(this.store),$column.append(addblock.$el))}},getJSON:function(){var t={type:this.type,data:[]};return this.getColumns().each(function(){var i=[];e(this).children(".villain-block-wrapper").each(function(){var t=n.BlockStore.getBlockById(e(this).attr("data-blockstore"),e(this).attr("data-block-id"));i.push(t.getJSON())}),t.data.push({"class":e(this).attr("class"),data:i})}),t},setup:function(){this.hasData()?this.$setup.hide():(this.getRow().hide(),this.$setup.append(['<label for="villain-columns-number">Antall kolonner</label>','<input type="text" class="villain-columns-number" name="villain-columns-number" />'].join("\n")),this.$setup.show(),this.$(".villain-columns-number").attr("autofocus","autofocus"))},_updateColumnCount:function(t){var i=e(t.target).val();this.$(".villain-column-widths").remove(),columnCountWrapper=e('<div class="villain-column-widths" />');for(var a=1;a<parseInt(i)+1;a++)columnCountWrapper.append(['<label for="villain-column-width-'+a+'">Kolonne '+a+" klassenavn (one, two, three ...)</label>",'<input type="text" name="villain-column-width-'+a+'" class="villain-column-width" />'].join("\n"));columnCountWrapper.append('<button class="villain-columns-apply">Sett opp kolonner</button>'),this.$setup.append(columnCountWrapper)},_applyColumnCount:function(t){t.preventDefault(),columnCount=this.$('input[name="villain-columns-number"]').val();for(var e=1;e<parseInt(columnCount)+1;e++)columnClass=this.$('input[name="villain-column-width-'+e+'"]').val(),this.getRow().append(this.columnTemplate({columnClass:columnClass})),addblock=new n.Plus(this.store),this.getColumn(e-1).append(addblock.$el);this.$setup.hide(),this.getRow().show()},onSetupClick:function(t){t.stopPropagation(),$button=this.$(".villain-action-button-setup"),$button.hasClass("active")?($button.removeClass("active"),this.hideSetup()):($button.addClass("active"),this.showSetup())},renderPlus:function(){return addblock=new n.Plus("main")}},{getButton:function(e){var i="columns";return(t=a.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-columns"></i>',"<p>cols</p>","</button>"].join("\n")))({id:e,type:i})}});n.Editor=Backbone.View.extend({el:"#villain",textArea:"#id_body",data:{},blocks:{},events:{"submit form":"clickSubmit","dragover .villain-droppable":"onDragOverDroppable","dragenter .villain-droppable":"onDragEnterDroppable","dragleave .villain-droppable":"onDragLeaveDroppable","drop .villain-droppable":"onDropDroppable","drop .villain-text-block":"onDropTextblock"},initialize:function(t){_this=this,this.$textArea=e(t.textArea)||this.textArea,e('<div id="villain"></div>').insertAfter(this.$textArea),this.el="#villain",this.$el=e(this.el),this.$textArea.hide(),this.isDirty=!1;try{this.data=JSON.parse(this.$textArea.val())}catch(i){this.data=null}e("form").submit(function(){_this.$textArea.val(_this.getJSON())}),n.BlockStore.create("main"),n.setOptions(t),n.BlockRegistry.initialize(t.extraBlocks),this.render()},render:function(){if(addblock=new n.Plus("main"),this.$el.append(addblock.$el),formatPopUp=new n.FormatPopUp,this.$el.append(formatPopUp.$el),!this.data)return!1;for(var t=0;t<=this.data.length-1;t++)blockJson=this.data[t],(BlockClass=n.BlockRegistry.getBlockClassByType(blockJson.type))!==!1?(block=new BlockClass(blockJson.data),this.$el.append(block.$el),this.$el.append(block.renderPlus().$el)):console.error("Villain: No class found for type: "+blockJson.type)},organizeMode:function(){e(".villain-block-wrapper").toggleClass("organize"),e('.villain-block-wrapper[data-block-type="columns"]').removeClass("organize"),e(".organize .villain-content").hide()},getJSON:function(){var t=[];return this.$(".villain-block-wrapper").each(function(){(block=n.BlockStore.getBlockById("main",e(this).data("block-id")))!==!1&&(blockJson=block.getJSON(),t.push(blockJson))}),ret=JSON.stringify(t),"[]"!=ret?ret:""},onDragEnterDroppable:function(t){e(".villain-add-block-button",t.currentTarget).addClass("drop-hover"),t.preventDefault(),t.stopPropagation()},onDragLeaveDroppable:function(t){e(".villain-add-block-button",t.currentTarget).removeClass("drop-hover"),t.preventDefault(),t.stopPropagation()},onDragOverDroppable:function(t){t.preventDefault(),t.stopPropagation()},onDropDroppable:function(t){return target=t.currentTarget,e(target).hasClass("villain-droppable")!==!0?(t.preventDefault(),t.stopPropagation(),!1):(e(".villain-add-block-button",target).removeClass("drop-hover"),sourceId=t.originalEvent.dataTransfer.getData("text/plain"),$source=e("[data-block-id="+sourceId+"]"),$sourceAdd=$source.next(),$source.detach(),$sourceAdd.detach(),$source.insertAfter(e(target)),oldBlockStore=$source.attr("data-blockstore"),newBlockStore=e(target).attr("data-blockstore"),block=n.BlockStore.getBlockById(oldBlockStore,sourceId),block.store=newBlockStore,n.BlockStore.del(oldBlockStore,sourceId),n.BlockStore.add(newBlockStore,sourceId,block),$source.attr("data-blockstore",newBlockStore),$sourceAdd.insertAfter($source),void $sourceAdd.attr("data-blockstore",newBlockStore))},onDropTextblock:function(t){return $target=e(t.currentTarget).closest(".villain-block-wrapper").shake(),t.preventDefault(),t.stopPropagation(),!1},clickSubmit:function(t){n.EventBus.trigger("posts:submit",t),form=this.checkForm(),form.valid===!1&&t.preventDefault(),window.onbeforeunload=e.noop()},checkForm:function(){var t={valid:!0,errors:[]};return""===$titleEl.val()&&(t.errors.push("Overskrift kan ikke være blank."),t.valid=!1,$titleEl.parent().parent().addClass("error"),$titleEl.parent().parent().append('<span class="help-inline"><strong><i class="icon-hand-up"></i> Feltet er påkrevet.</strong></span>'),e("html, body").animate({scrollTop:0},5)),t},markDirty:function(){this.isDirty=!0}}),n.FormatPopUp=Backbone.View.extend({tagName:"div",className:"villain-format-popup",events:{"click .villain-format-bold":"onClickBold","click .villain-format-italic":"onClickItalic","click .villain-format-link":"onClickLink","click .villain-format-unlink":"onClickUnlink"},onClickBold:function(t){t.preventDefault(),document.execCommand("bold",!1,!1),this.activateButton(".villain-format-bold")},onClickItalic:function(t){t.preventDefault(),document.execCommand("italic",!1,!1),this.activateButton(".villain-format-italic")},onClickLink:function(t){t.preventDefault();var e=prompt("Sett inn link:"),i=/((ftp|http|https):\/\/.)|mailto(?=\:[-\.\w]+@)/;e&&e.length>0&&(i.test(e)||(e="http://"+e),document.execCommand("CreateLink",!1,e)),this.activateButton(".villain-format-link")},onClickUnlink:function(t){t.preventDefault(),document.execCommand("unlink",!1,!1)},initialize:function(){this.render(),n.EventBus.on("formatpopup:show",this.showPopUp,this),n.EventBus.on("formatpopup:hide",this.hidePopUp,this)},render:function(){return this.$el.append('<button class="popup-button villain-format-bold"><i class="fa fa-bold"></i></button>'),this.$el.append('<button class="popup-button villain-format-italic"><i class="fa fa-italic"></i></button>'),this.$el.append('<button class="popup-button villain-format-link"><i class="fa fa-link"></i></button>'),this.$el.append('<button class="popup-button villain-format-unlink"><i class="fa fa-unlink"></i></button>'),this},showPopUp:function(t){$el=t.$el;var i=window.getSelection(),a=i.getRangeAt(0),n=a.getBoundingClientRect(),o=$el.offset(),l={};mainContent=e("section#maincontent"),l.top=n.top+mainContent.scrollTop(),l.left=(n.left+n.right)/2-this.$el.width()/2-o.left+12,parseInt(l.left)<0&&(l.left="0"),l.left=l.left+"px",this.deactivateButtons(),this.activeButtons(),this.$el.addClass("show-popup"),this.$el.css(l)},hidePopUp:function(){this.$el.removeClass("show-popup")},activeButtons:function(){var t,e=window.getSelection();e.rangeCount>0&&(t=e.getRangeAt(0).startContainer.parentNode),t&&"A"==t.nodeName&&this.activateButton(".villain-format-link"),document.queryCommandState("bold")&&this.activateButton(".villain-format-bold"),document.queryCommandState("italic")&&this.activateButton(".villain-format-italic")},activateButton:function(t){this.$(t).addClass("active")},deactivateButtons:function(){this.$(".popup-button").removeClass("active")}}),n.Editor.HTML=n.Editor.HTML||{},n.Editor.EditorHTML=n.Editor.EditorHTML||{},n.toMD=function(t){var t=toMarkdown(t);return t=t.replace(/&nbsp;/g," "),t=t.replace(/([^<>]+)(<div>)/g,"$1\n$2").replace(/<div><div>/g,"\n<div>").replace(/<div><br \/><\/div>/g,"\n\n").replace(/(?:<div>)([^<>]+)(?:<div>)/g,"$1\n").replace(/(?:<div>)(?:<br>)?([^<>]+)(?:<br>)?(?:<\/div>)/g,"$1\n").replace(/<\/p>/g,"\n\n").replace(/<(.)?br(.)?>/g,"\n").replace(/&lt;/g,"<").replace(/&gt;/g,">"),aggressiveStrip=!0,t=aggressiveStrip?t.replace(/<\/?[^>]+(>|$)/g,""):t.replace(/<(?=\S)\/?[^>]+(>|$)/gi,"")},n.toHTML=function(t,e){if(a.isUndefined(t))return"";e=a.classify(e);var i=t,o="Text"===e;a.isUndefined(o)&&(o=!1),o&&(i="<div>"+i),i=i.replace(/\[([^\]]+)\]\(([^\)]+)\)/gm,function(t,e,i){return'<a href="'+i+'">'+e.replace(/\r?\n/g,"")+"</a>"}),i=a.reverse(a.reverse(i).replace(/_(?!\\)((_\\|[^_])*)_(?=$|[^\\])/gm,function(t,e){return">i/<"+e.replace(/\r?\n/g,"").replace(/[\s]+$/,"")+">i<"}).replace(/\*\*(?!\\)((\*\*\\|[^\*\*])*)\*\*(?=$|[^\\])/gm,function(t,e){return">b/<"+e.replace(/\r?\n/g,"").replace(/[\s]+$/,"")+">b<"})),i=i.replace(/^\> (.+)$/gm,"$1");var l,r;for(l in n.Formatters)n.Formatters.hasOwnProperty(l)&&(r=n.Formatters[l],!a.isUndefined(r.toHTML)&&a.isFunction(r.toHTML)&&(i=r.toHTML(i)));return o&&(i=i.replace(/\r?\n\r?\n/gm,"</div><div><br></div><div>").replace(/\r?\n/gm,"</div><div>")),i=i.replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;").replace(/\r?\n/g,"<br>").replace(/\*\*/,"").replace(/__/,""),i=i.replace(/\\\*/g,"*").replace(/\\\[/g,"[").replace(/\\\]/g,"]").replace(/\\\_/g,"_").replace(/\\\(/g,"(").replace(/\\\)/g,")").replace(/\\\-/g,"-"),o&&(i+="</div>"),i},n.setOptions=function(t){(a.isUndefined(t.imageSeries)||a.isUndefined(t.baseURL))&&console.error("Villain: baseURL and imageSeries MUST be set on initialization."),n.defaults.browseURL=t.baseURL+n.defaults.browseURL+t.imageSeries,n.defaults.uploadURL=t.baseURL+n.defaults.uploadURL+t.imageSeries,n.defaults.imageseriesURL=t.baseURL+n.defaults.imageseriesURL,n.options=e.extend({},n.defaults,t)},n.browser=function r(){var r={};if(this.getIEversion()>0)r.msie=!0;else{var t=navigator.userAgent.toLowerCase(),e=/(chrome)[ \/]([\w.]+)/.exec(t)||/(webkit)[ \/]([\w.]+)/.exec(t)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(t)||/(msie) ([\w.]+)/.exec(t)||t.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(t)||[],i={browser:e[1]||"",version:e[2]||"0"};e[1]&&(r[i.browser]=!0),parseInt(i.version,10)<9&&r.msie&&(r.oldMsie=!0),r.chrome?r.webkit=!0:r.webkit&&(r.safari=!0)}return r},n.Editor.processPaste=function(t){var i;return t.match(/(class=\"?Mso|style=\"[^\"]*\bmso\-|w:WordDocument)/gi)?(i=n.Editor.wordClean(t),i=n.Editor.clean(e("<div>").append(i).html(),!1,!0),i=n.Editor.removeEmptyTags(i)):(i=n.Editor.clean(t,!1,!0),i=n.Editor.removeEmptyTags(i)),i=n.Editor.plainPasteClean(i),""!==i?i:void 0},n.Editor.wordClean=function(t){t.indexOf("<body")>=0&&(t=t.replace(/[.\s\S\w\W<>]*<body[^>]*>([.\s\S\w\W<>]*)<\/body>[.\s\S\w\W<>]*/g,"$1")),t=t.replace(/<p(.*?)class="?'?MsoListParagraph"?'?([\s\S]*?)>([\s\S]*?)<\/p>/gi,"<ul><li><p>$3</p></li></ul>"),t=t.replace(/<p(.*?)class="?'?MsoListParagraphCxSpFirst"?'?([\s\S]*?)>([\s\S]*?)<\/p>/gi,"<ul><li><p>$3</p></li>"),t=t.replace(/<p(.*?)class="?'?MsoListParagraphCxSpMiddle"?'?([\s\S]*?)>([\s\S]*?)<\/p>/gi,"<li><p>$3</p></li>"),t=t.replace(/<p(.*?)class="?'?MsoListParagraphCxSpLast"?'?([\s\S]*?)>([\s\S]*?)<\/p>/gi,"<li><p>$3</p></li></ul>"),t=t.replace(/<span([^<]*?)style="?'?mso-list:Ignore"?'?([\s\S]*?)>([\s\S]*?)<span/gi,"<span><span"),t=t.replace(/<!--\[if \!supportLists\]-->([\s\S]*?)<!--\[endif\]-->/gi,""),t=t.replace(/(\n|\r| class=(")?Mso[a-zA-Z]+(")?)/gi," "),t=t.replace(/<!--[\s\S]*?-->/gi,""),t=t.replace(/<(\/)*(meta|link|span|\\?xml:|st1:|o:|font)(.*?)>/gi,"");for(var e=["style","script","applet","embed","noframes","noscript"],i=0;i<e.length;i++){var a=new RegExp("<"+e[i]+".*?"+e[i]+"(.*?)>","gi");t=t.replace(a,"")}t=t.replace(/([\w\-]*)=("[^<>"]*"|'[^<>']*'|\w+)/gi,""),t=t.replace(/&nbsp;/gi,"");var o;do o=t,t=t.replace(/<[^\/>][^>]*><\/[^>]+>/gi,"");while(t!=o);return t=n.Editor.clean(t)},n.Editor.clean=function(t,i,a,n,o){o=["accept","accept-charset","accesskey","action","align","alt","async","autocomplete","autofocus","autoplay","autosave","background","bgcolor","border","charset","cellpadding","cellspacing","checked","cite","class","color","cols","colspan","contenteditable","contextmenu","controls","coords","data","data-.*","datetime","default","defer","dir","dirname","disabled","download","draggable","dropzone","enctype","for","form","formaction","headers","height","hidden","high","href","hreflang","icon","id","ismap","itemprop","keytype","kind","label","lang","language","list","loop","low","max","maxlength","media","method","min","multiple","name","novalidate","open","optimum","pattern","ping","placeholder","poster","preload","pubdate","radiogroup","readonly","rel","required","reversed","rows","rowspan","sandbox","scope","scoped","scrolling","seamless","selected","shape","size","sizes","span","src","srcdoc","srclang","srcset","start","step","summary","spellcheck","style","tabindex","target","title","type","translate","usemap","value","valign","width","wrap"],n=["!--","a","abbr","address","area","article","aside","audio","b","base","bdi","bdo","blockquote","br","button","canvas","caption","cite","code","col","colgroup","datalist","dd","del","details","dfn","dialog","div","dl","dt","em","embed","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","header","hgroup","hr","i","iframe","img","input","ins","kbd","keygen","label","legend","li","link","main","map","mark","menu","menuitem","meter","nav","noscript","object","ol","optgroup","option","output","p","param","pre","progress","queue","rp","rt","ruby","s","samp","script","section","select","small","source","span","strong","style","sub","summary","sup","table","tbody","td","textarea","tfoot","th","thead","time","title","tr","track","u","ul","var","video","wbr"],t=t.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"");var l=new RegExp("<\\/?((?!(?:"+n.join("|")+"))\\w+)[^>]*?>","gi");t=t.replace(l,"");var r=new RegExp("( (?!(?:"+o.join("|")+"))[a-zA-Z0-9-_]+)=((?:.(?!\\s+(?:\\S+)=|[>]|(\\/>)))+.)","gi");t=t.replace(r,"");var s=new RegExp("style=(\"[a-zA-Z0-9:;\\.\\s\\(\\)\\-\\,!\\/'%]*\"|'[a-zA-Z0-9:;\\.\\s\\(\\)\\-\\,!\\/\"%]*')","gi");t=t.replace(s,"");var c=e("<div>").append(t);return c.find('[class]:not([class^="fr-"])').each(function(t,i){e(i).removeAttr("class")}),t=c.html()},n.Editor.plainPasteClean=function(t){var i=e("<div>").html(t);i.find("h1, h2, h3, h4, h5, h6, pre, blockquote").each(function(t,i){e(i).replaceWith("<p>"+e(i).html()+"</p>")});for(var a=function(t,i){e(i).replaceWith(e(i).html())};i.find("strong, em, strike, b, u, i, sup, sub, span, a").length;)i.find("strong, em, strike, b, u, i, sup, sub, span, a").each(a);return i.html()},n.Editor.removeEmptyTags=function(t){for(var i,a=e("<div>").html(t),n=a.find("*:empty:not(br, img, td, th)");n.length;){for(i=0;i<n.length;i++)e(n[i]).remove();n=a.find("*:empty:not(br, img, td, th)")}a.find("> div").each(function(t,i){e(i).replaceWith(e(i).html()+"<br/>")});for(var o=a.find("div");o.length;){for(i=0;i<o.length;i++){var l=e(o[i]),r=l.html().replace(/\u0009/gi,"").trim();l.replaceWith(r)}o=a.find("div")}return a.html()},n.Editor.pasteHtmlAtCaret=function(t){var e,i;if(window.getSelection){if(e=window.getSelection(),e.getRangeAt&&e.rangeCount){i=e.getRangeAt(0),i.deleteContents();var a=document.createElement("div");a.innerHTML=t;for(var n,o,l=document.createDocumentFragment();n=a.firstChild;)o=l.appendChild(n);i.insertNode(l),o&&(i=i.cloneRange(),i.setStartAfter(o),i.collapse(!0),e.removeAllRanges(),e.addRange(i))}}else document.selection&&"Control"!=document.selection.type&&document.selection.createRange().pasteHTML(t)},n.BlockRegistry={},n.BlockRegistry.initialize=function(t){n.BlockRegistry.Map=["Text","Header","Blockquote","List","Image","Slideshow","Video","Divider","Columns"],a.isUndefined(t)||n.BlockRegistry.addExtraBlocks(t),n.BlockRegistry.checkBlocks()},n.BlockRegistry.addExtraBlocks=function(t){n.BlockRegistry.Map=n.BlockRegistry.Map.concat(t)},n.BlockRegistry.add=function(t){n.BlockRegistry.Map.push(t)},n.BlockRegistry.checkBlocks=function(){for(i=0;i<n.BlockRegistry.Map.length;++i)type=n.BlockRegistry.Map[i],a.isUndefined(n.Blocks[a(type).capitalize()])&&console.error("Villain: Missing block source for "+type+"! Please ensure it is included.")},n.BlockRegistry.getBlockClassByType=function(t){return-1!==n.BlockRegistry.Map.indexOf(a(t).capitalize())?n.Blocks[a(t).capitalize()]:!1}}(jQuery,_);