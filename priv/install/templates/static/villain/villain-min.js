!function(e,a){var n,o=this;n=o.Villain={},n.EventBus=n.EventBus||a.extend({},Backbone.Events),n.Blocks=n.Blocks||{},n.Editor=n.Editor||{},n.options=n.options||[],n.defaults={textArea:"#textarea",browseURL:"villain/browse/",uploadURL:"villain/upload/",imageseriesURL:"villain/imageseries/"};var l=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/;a.mixin({isURI:function(t){return l.test(t)},titleize:function(t){return null===t?"":(t=String(t).toLowerCase(),t.replace(/(?:^|\s|-)\S/g,function(t){return t.toUpperCase()}))},classify:function(t){return a.titleize(String(t).replace(/[\W_]/g," ")).replace(/\s/g,"")},classifyList:function(t){return a.map(t,function(t){return a.classify(t)})},capitalize:function(t){return t.charAt(0).toUpperCase()+t.substring(1).toLowerCase()},underscored:function(t){return a.trim(t).replace(/([a-z\d])([A-Z]+)/g,"$1_$2").replace(/[-\s]+/g,"_").toLowerCase()},trim:function(t){return t.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},reverse:function(t){return t.split("").reverse().join("")},flattern:function(t){var e={};return a.each(t,function(i,n){e[a.isArray(t)?i:n]=!0}),e},to_slug:function(t){return t.toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"-")}}),e.fn.visible=function(){return this.css("visibility","visible")},e.fn.invisible=function(){return this.css("visibility","hidden")},e.fn.visibilityToggle=function(){return this.css("visibility",function(t,e){return"visible"==e?"hidden":"visible"})},e.fn.caretToEnd=function(){var t,e;return t=document.createRange(),t.selectNodeContents(this[0]),t.collapse(!1),e=window.getSelection(),e.removeAllRanges(),e.addRange(t),this},e.fn.flash=function(t,e){t=t||1e3,e=e||2;var i=Math.floor(t/e);originalColor=this.css("background-color"),this.css("background-color","#ffffdd");for(var a=0;e>a;a++)this.fadeOut(i).fadeIn(i,function(){this.css("background-color","#ffffff")});return this},e.fn.shake=function(t,i,a){return t=t||3,i=i||10,a=a||300,this.each(function(){e(this).css("position","relative");for(var n=1;t>=n;n++)e(this).animate({left:-1*i},a/t/4).animate({left:i},a/t/2).animate({left:0},a/t/4)}),this},function(t){"use strict";var e={init:function(e){var i=t.extend({},t.fn.loadingOverlay.defaults,e),a=t(this).addClass(i.loadingClass),n='<div class="'+i.overlayClass+'"><p class="'+i.spinnerClass+'"><span class="'+i.iconClass+'"></span><span class="'+i.textClass+'">'+i.loadingText+"</span></p></div>";return a.data("loading-overlay")||a.prepend(t(n)).data("loading-overlay",!0),a},remove:function(e){var i=t.extend({},t.fn.loadingOverlay.defaults,e),a=t(this).data("loading-overlay",!1);return a.find("."+i.overlayClass).detach(),a.hasClass(i.loadingClass)?a.removeClass(i.loadingClass):a.find("."+i.loadingClass).removeClass(i.loadingClass),a},exposeMethods:function(){return e}};t.fn.loadingOverlay=function(i){return e[i]?e[i].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof i&&i?void t.error("Method "+i+" does not exist on jQuery.loadingOverlay"):e.init.apply(this,arguments)},t.fn.loadingOverlay.defaults={loadingClass:"loading",overlayClass:"loading-overlay",spinnerClass:"loading-spinner",iconClass:"loading-icon fa fa-circle-o-notch fa-spin",textClass:"loading-text",loadingText:""}}(jQuery),n.Plus=Backbone.View.extend({tagName:"div",className:"villain-add-block villain-droppable",blockSelectionTemplate:a.template('<div class="villain-block-selection"><%= content %></div>'),events:{"click .villain-add-block-button":"onClickAddBlock","click .villain-block-button":"onClickBlockButton"},initialize:function(t){this.store=t,this.$el.attr("data-blockstore",t),this.$el.attr("id",a.uniqueId("villain-plus-")),this.render()},render:function(){return this.$el.append('<button class="villain-add-block-button">+</button>'),this},onClickBlockButton:function(t){t.preventDefault(),$button=e(t.currentTarget),blockType=$button.data("type"),blockStore=this.store,BlockClass=n.BlockRegistry.getBlockClassByType(blockType),block=new BlockClass(!1,blockStore),block.$el.insertAfter($button.parent().parent()),block.$el.after(block.renderPlus().$el),block.hasTextBlock()&&block.setCaret(),block.scrollTo(),$button.parent().prev().show(),$button.parent().remove()},onClickAddBlock:function(t){t.preventDefault(),$addBlockButton=e(t.currentTarget),$addBlockButton.hide(),blockId=$addBlockButton.parent().data("after-block-id"),blockSelection=this.blockSelectionTemplate({content:this.getButtons(blockId)}),$addBlockButton.parent().append(blockSelection)},getButtons:function(t){for(html="",i=0;i<n.BlockRegistry.Map.length;++i)blockName=n.BlockRegistry.Map[i],b=n.BlockRegistry.getBlockClassByType(blockName),a.isUndefined(b)?console.error("Villain: Undefined block ",blockName):b.hasOwnProperty("getButton")?html+=b.getButton(t):console.log("// No button found for "+blockName);return html}}),n.BlockStore=[],n.BlockStore.stores=[],n.BlockStore.count=1,n.BlockStore.getId=function(){return id=n.BlockStore.count,n.BlockStore.count++,id},n.BlockStore.getBlockById=function(t,e){return block=a.find(n.BlockStore[t],function(t){return t.id==e}),block&&block.hasOwnProperty("object")?block.object:!1},n.BlockStore.add=function(t,e,i){n.BlockStore[t].push({id:e,object:i})},n.BlockStore.del=function(t,e){n.BlockStore[t]=a.filter(n.BlockStore[t],function(t){return parseInt(t.id)!==parseInt(e)})},n.BlockStore.delStore=function(t){a.each(n.BlockStore[t],function(t){t.object.destroy()}),n.BlockStore[t]=[];var e=n.BlockStore.stores.indexOf(t);n.BlockStore.stores.splice(e,1)},n.BlockStore.create=function(t){n.BlockStore[t]=[],n.BlockStore.stores.push(t)},n.BlockStore.listAll=function(){for(var t=0;t<n.BlockStore.stores.length;t++)console.log(n.BlockStore.stores[t]),console.log(n.BlockStore[n.BlockStore.stores[t]])},n.Block=Backbone.View.extend({tagName:"div",className:"villain-block-wrapper",type:"base",template:a.template("base"),store:"main",wrapperTemplate:a.template(['<div class="villain-block-inner"><%= content %><%= actions %></div>'].join("\n")),actionsTemplate:a.template(['<div class="villain-actions">','  <div class="villain-action-button villain-action-button-setup">','    <i class="fa fa-cogs"></i>',"  </div>",'  <div class="villain-action-button villain-action-button-del">','    <i class="fa fa-trash"></i>',"  </div>",'  <div class="villain-action-button villain-action-button-move" draggable="true">','    <i class="fa fa-arrows-alt"></i>',"  </div>","</div>"].join("\n")),setupTemplate:a.template('<div class="villain-setup-block" />'),events:{"dragstart .villain-action-button-move":"onDragStart","click .villain-action-button-move":"onClickMove","click .villain-action-button-del":"onClickDelete","mouseover .villain-block-inner":"onMouseOver","mouseout .villain-block-inner":"onMouseOut","paste .villain-text-block":"onPaste","mouseup .villain-text-block":"onMouseUp","click .villain-text-block":"onClick","click .villain-action-button-setup":"onSetupClick"},initialize:function(t,e){this.data=t||null,this.dataId=this.getIdFromBlockStore(),this.$el.attr("data-block-id",this.dataId),this.$el.attr("data-block-type",this.type),this.$el.attr("id","villain-block-"+this.dataId),e&&(this.store=e),this.$el.attr("data-blockstore",this.store),this.id="villain-block-"+this.dataId,this.addToBlockStore(e),this.render()},render:function(){return html=this.hasData()?this.renderEditorHtml():this.renderEmpty(),this.el.innerHTML=html,this.setSections(),this.addSetup(),this},onClick:function(){var t=this.getSelectedText();""===t&&n.EventBus.trigger("formatpopup:hide")},onSetupClick:function(t){t.stopPropagation(),$button=this.$(".villain-action-button-setup"),$button.hasClass("active")?($button.removeClass("active"),this.hideSetup()):($button.addClass("active"),this.showSetup())},onMouseUp:function(){var t=this.getSelectedText();""!==t?n.EventBus.trigger("formatpopup:show",this):n.EventBus.trigger("formatpopup:hide")},getSelectedText:function(){var t="";return window.getSelection?t=window.getSelection():document.getSelection?t=document.getSelection():document.selection&&(t=document.selection.createRange().text),t.toString()},deleteBlock:function(){n.BlockStore.del(this.store,this.dataId),this.destroy()},loading:function(){this.$el.loadingOverlay()},done:function(){this.$el.loadingOverlay("remove")},addToPathName:function(t){if("/"===t.charAt(0))return t;var e="/"==window.location.pathname.slice(-1)?"":"/",i=window.location.pathname+e+t;return i},destroy:function(){this.$el.next(".villain-add-block").remove(),this.undelegateEvents(),this.$el.removeData().unbind(),this.remove(),Backbone.View.prototype.remove.call(this)},onClickDelete:function(t){this.deleteBlock(),t.stopPropagation()},onClickMove:function(t){t.stopPropagation()},onDragStart:function(t){t.originalEvent.dataTransfer.setDragImage(this.$el.get(0),this.$el.width(),this.$el.height()),t.originalEvent.dataTransfer.setData("Text",this.dataId),t.stopPropagation()},onMouseOver:function(){event.stopPropagation(),this.$inner.addClass("hover"),this.$inner.children(".villain-actions").visible()},onMouseOut:function(){this.$inner.removeClass("hover"),this.$inner.children(".villain-actions").invisible()},onPaste:function(t){var i=!1;if(t&&t.originalEvent.clipboardData&&t.originalEvent.clipboardData.getData){var a="",o=t.originalEvent.clipboardData.types;if(e.isArray(o))for(var l=0;l<o.length;l++)a+=o[l]+";";else a=o;if(/text\/html/.test(a)?clipboardHTML=t.originalEvent.clipboardData.getData("text/html"):/text\/rtf/.test(a)&&n.browser.safari?clipboardHTML=t.originalEvent.clipboardData.getData("text/rtf"):/text\/plain/.test(a)&&!n.browser.mozilla&&(clipboardHTML=t.originalEvent.clipboardData.getData("text/plain").replace(/\n/g,"<br/>")),""!==this.clipboardHTML?i=!0:this.clipboardHTML=null,i)return cleanHtml=n.Editor.processPaste(clipboardHTML),t.stopPropagation(),t.preventDefault(),n.Editor.pasteHtmlAtCaret(cleanHtml),!1}},getIdFromBlockStore:function(){return n.BlockStore.getId()},doRenderCallback:function(){},hasTextBlock:function(){return 0===this.$(".villain-text-block").length?!1:!0},setCaret:function(){var t,e;t=document.createRange(),t.selectNodeContents(this.getTextBlock()[0]),t.collapse(!1),e=window.getSelection(),e.removeAllRanges(),e.addRange(t)},scrollTo:function(){e("html, body").animate({scrollTop:this.$el.offset().top-75},300,"linear")},flash:function(){},getJSON:function(){return[]},addToBlockStore:function(t){n.BlockStore.add(t?t:"main",this.dataId,this)},setData:function(t){this.data=t},getData:function(){return this.data},setDataProperty:function(t,e){data=this.getData(),data[t]=e,this.setData(data)},hasData:function(){return this.data?!a.isEmpty(this.data):!1},refreshBlock:function(){return html=this.renderEditorHtml(),this.el.innerHTML=html,this.addSetup(),this},refreshContentBlock:function(){return block=this.renderContentBlockHtml(),this.$content.html(e(block).html()),this.$content},setSections:function(){this.$inner=this.$(".villain-block-inner"),this.$content=this.$(".villain-content")},addSetup:function(){this.setup?(this.$inner.prepend(this.setupTemplate()),this.$setup=this.$(".villain-setup-block"),this.$(".villain-action-button-setup").show(),this.setup()):this.$(".villain-action-button-setup").hide()},clearSetup:function(){this.$setup.empty()},getTextBlock:function(){return this.$textBlock=this.$(".villain-text-block"),this.$textBlock},getTextBlockInner:function(){return tb=this.getTextBlock(),tb.html()},clearInsertedStyles:function(t){var e=t.target;e.removeAttribute("style")},renderEditorHtml:function(){},renderEmpty:function(){},renderPlus:function(){return addblock=new n.Plus(this.store)},showSetup:function(){innerHeight=this.$inner.height(),this.$content.hide(),$button=this.$(".villain-action-button-setup"),$button.addClass("active"),this.$setup.show(),this.$setup.height()<innerHeight&&this.$setup.height(innerHeight)},hideSetup:function(){this.$setup.hide(),this.$setup.height(""),$button=this.$(".villain-action-button-setup"),$button.removeClass("active"),this.$content.show()}}),n.Blocks.Text=n.Block.extend({type:"text",template:a.template('<div class="villain-text-block villain-content" contenteditable="true" data-text-type="<%= type %>"><%= content %></div>'),renderEditorHtml:function(){return blockTemplate=this.renderContentBlockHtml(),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderContentBlockHtml:function(){return text=this.getTextBlockInner()?this.getTextBlockInner():this.data.text,this.template({content:n.toHTML(text),type:this.data.type})},renderEmpty:function(){return blockTemplate=this.template({content:"Text",type:"paragraph"}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},getJSON:function(){return textNode=n.toMD(this.getTextBlockInner()),data=this.getData(),json={type:this.type,data:{text:textNode,type:data.type}}},getHTML:function(){return textNode=this.getTextBlock().html(),markdown.toHTML(textNode)},setup:function(){data=this.getData(),data.hasOwnProperty("type")||this.setDataProperty("type","paragraph"),type=this.data.type,this.$setup.hide();var t="";types=["paragraph","lead"];for(i in types)selected="",type===types[i]&&(selected=' checked="checked"'),t+='<label><input type="radio" name="text-type" value="'+types[i]+'"'+selected+">"+types[i]+"</label>";this.$setup.append(e(["<label>Type</label>",t].join("\n"))),this.$setup.find("input[type=radio]").on("change",e.proxy(function(t){this.setDataProperty("type",e(t.target).val()),this.refreshContentBlock(),this.$content.attr("data-text-type",e(t.target).val())},this))}},{getButton:function(e){var i="text";return(t=a.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-paragraph"></i>',"<p>text</p>","</button>"].join("\n")))({id:e,type:i})}}),n.Blocks.Blockquote=n.Block.extend({type:"blockquote",template:a.template('<div class="villain-quote-block villain-content"><blockquote contenteditable="true"><%= content %></blockquote><cite contenteditable="true"><%= cite %></cite></div>'),renderEditorHtml:function(){return blockTemplate=this.renderContentBlockHtml(),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderContentBlockHtml:function(){return text=this.getTextBlockInner()?this.getTextBlockInner():this.data.text,this.template({content:n.toHTML(text),cite:this.data.cite})},renderEmpty:function(){return blockTemplate=this.template({content:"quote",cite:"author"}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},getJSON:function(){return quote=this.$content.find("blockquote")[0].outerHTML,cite=e("cite",this.$content).html(),textNode=n.toMD(quote),data=this.getData(),json={type:this.type,data:{text:textNode,cite:cite}}},getHTML:function(){return textNode=this.getTextBlock().html(),markdown.toHTML(textNode)}},{getButton:function(e){var i="blockquote";return(t=a.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-quote-right"></i>',"<p>quote</p>","</button>"].join("\n")))({id:e,type:i})}}),n.Blocks.Divider=n.Block.extend({type:"divider",template:a.template('<div class="villain-divider-block villain-content"><hr></div>'),renderEditorHtml:function(){return blockTemplate=this.template(),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderEmpty:function(){return blockTemplate=this.template(),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},getJSON:function(){return json={type:this.type,data:{text:"--------------------"}}},getHTML:function(){return"<hr>"}},{getButton:function(e){var i="divider";return(t=a.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-minus"></i>',"<p>hr</p>","</button>"].join("\n")))({id:e,type:i})}}),n.Blocks.Header=n.Block.extend({type:"header",template:a.template(['<div class="villain-text-block villain-text-block-header villain-content" data-header-level="<%= level %>" contenteditable="true">',"<%= content %>","</div>"].join("\n")),renderEditorHtml:function(){return blockTemplate=this.renderContentBlockHtml(),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderContentBlockHtml:function(){return this.template({content:this.data.text,level:this.data.level})},renderEmpty:function(){return blockTemplate=this.template({content:"Header",level:1}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},setup:function(){data=this.getData(),data.hasOwnProperty("level")||this.setDataProperty("level",1),level=data.level,this.$setup.hide();var t="";levels=[1,2,3,4,5];for(i in levels)selected="",parseInt(level)===parseInt(levels[i])&&(selected=' checked="checked"'),t+='<label><input type="radio" name="header-size" value="'+levels[i]+'"'+selected+">H"+levels[i]+"</label>";this.$setup.append(e(["<label>Størrelse</label>",t].join("\n"))),this.$setup.find("input[type=radio]").on("change",e.proxy(function(t){this.setDataProperty("level",e(t.target).val()),this.refreshContentBlock(),this.$content.attr("data-header-level",e(t.target).val())},this))},getData:function(){return data=this.data,data.text=n.toMD(this.getTextBlock().html()).trim(),data},getJSON:function(){return json={type:this.type,data:this.getData()}},getHTML:function(){return textNode=this.getTextBlock().html(),"<h3>"+markdown.toHTML(textNode)+"</h3>"}},{getButton:function(e){var i="header";return(t=a.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-header"></i>',"<p>h1-6</p>","</button>"].join("\n")))({id:e,type:i})}}),n.Blocks.List=n.Block.extend({type:"list",template:a.template(['<div class="villain-text-block villain-text-block-list villain-content" contenteditable="true">',"<%= content %>","</div>"].join("\n")),events:{"keyup .villain-content":"onKeyUp"},onKeyUp:function(t){console.log(t.currentTarget.innerHTML),(""==t.currentTarget.innerText||"\n"==t.currentTarget.innerText)&&(console.log("empty!"),t.currentTarget.innerHTML="<ul><li><br></li></ul>")},renderEditorHtml:function(){return blockTemplate=this.template({content:markdown.toHTML(this.data.text)}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderEmpty:function(){return blockTemplate=this.template({content:"<ul><li>list</li></ul>"}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},getJSON:function(){return textNode=this.getTextBlock().html().replace(/<\/li>/gm,"\n").replace(/<\/?[^>]+(>|$)/g,"").replace(/^(.+)$/gm," - $1"),json={type:this.type,data:{text:textNode}}},getHTML:function(){return textNode=this.getTextBlock().html(),"<h3>"+markdown.toHTML(textNode)+"</h3>"},toMarkdown:function(t){return t.replace(/<\/li>/gm,"\n").replace(/<\/?[^>]+(>|$)/g,"").replace(/^(.+)$/gm," - $1")}},{getButton:function(e){var i="list";return(t=a.template(['<button class="villain-block-button" ','        data-type="<%= type %>" ','        data-after-block-id="<%= id %>"',">",'   <i class="fa fa-list-ul"></i>',"<p>list</p>","</button>"].join("\n")))({id:e,type:i})}}),n.Blocks.Image=n.Block.extend({type:"image",template:a.template('<div class="villain-image-block villain-content"><img class="img-responsive" src="<%= url %>" /></div>'),events:{"drop .villain-image-dropper i":"onDropImage","dragenter .villain-image-dropper i":"onDragEnter","dragleave .villain-image-dropper i":"onDragLeave","dragover .villain-image-dropper i":"onDragOver","click .villain-image-dropper-upload":"onUploadClickAfterDrop"},initialize:function(t,e){n.Block.prototype.initialize.apply(this,[t,e]),a.extend(this.events,n.Block.prototype.events)},renderEditorHtml:function(){return blockTemplate=this.renderContentBlockHtml(),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderContentBlockHtml:function(){return this.template({url:this.data.url})},renderEmpty:function(){return blockTemplate=this.template({url:"http://placehold.it/1150x400"}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},onUploadClickAfterDrop:function(t){var i=[this.dataId,(new Date).getTime(),"raw"].join("-"),l=new FormData;return t.preventDefault(),this.loading(),img=this.$setup.find(".villain-image-dropper img"),this.file?(l.append("name",this.file.name),l.append("image",this.file),l.append("uid",i),o=this,e.ajax({type:"post",dataType:"json",accepts:{json:"text/json"},url:this.addToPathName(n.options.uploadURL),data:l,cache:!1,contentType:!1,processData:!1,xhr:function(){var t=e.ajaxSettings.xhr();return t.upload&&t.upload.addEventListener("progress",o.progressHandlingFunction,!1),t}}).done(e.proxy(function(t){if("200"==t.status&&(this.$setup.append('<div class="villain-message success">Bildet er lastet opp</div>'),this.$setup.find(".villain-image-dropper-upload").remove(),this.$setup.find(".villain-image-dropper").remove(),t.hasOwnProperty("image")&&(imageData=t.image,$image=e('<img src="'+imageData.src+'" />'),this.$setup.append($image),json={url:imageData.src,sizes:imageData.sizes},this.setData(json)),t.hasOwnProperty("uid")&&(i=t.uid),t.hasOwnProperty("form"))){var n="";inputTemplate=a.template(["<label><%= label %></label>",'<input type="<%= type %>" ','       value="<%= value %>" ','       name="<%= name %>"',"/>"].join("\n"));for(var l=0;l<t.form.fields.length;l++)field=t.form.fields[l],n+=inputTemplate({label:field.label,type:field.type,value:field.value,name:field.name});formTemplate=a.template(['<form method="<%= method %>" ','      action="<%= action %>" ','      class="villain-form" ','      name="<%= name %>"',">","<%= inputs %>","</form>"].join("\n")),form=formTemplate({method:t.form.method,action:o.addToPathName(t.form.action),name:t.form.name,inputs:n}),$form=e(form),$submitButton=e('<input type="submit" name="'+t.form.name+'-submit" value="Lagre" />'),$submitButton.on("click",function(a){a.preventDefault(),serializedForm=$form.serialize(),imagedata=new FormData,imagedata.append("form",serializedForm),imagedata.append("uid",i),e.ajax({type:"post",url:o.addToPathName(t.form.action),data:imagedata,cache:!1,contentType:!1,processData:!1,dataType:"json"}).done(e.proxy(function(t){200==t.status&&(json=o.getData(),json.title=t.title,json.credits=t.credits,json.link="",o.setData(json),o.refreshContentBlock(),o.hideSetup(),o.setup())},this))}),$form.append($submitButton),this.$setup.append($form)}},this)).fail(e.proxy(function(){alert("Feil fra server under opplasting.")},this)).always(e.proxy(function(){})),void this.done()):(this.done(),!1)},progressHandlingFunction:function(t){t.lengthComputable},onDragEnter:function(t){this.$(".villain-image-dropper i").addClass("drop-hover"),t.preventDefault()},onDragLeave:function(t){this.$(".villain-image-dropper i").removeClass("drop-hover"),t.preventDefault()},onDragOver:function(t){t.preventDefault()},onDropImage:function(t){t.preventDefault(),this.$(".villain-image-dropper i").removeClass("drop-hover"),dataTransfer=t.originalEvent.dataTransfer;var i=dataTransfer.files[0],a="undefined"!=typeof URL?URL:"undefined"!=typeof webkitURL?webkitURL:null;/image/.test(i.type)&&(this.$(".villain-image-dropper").html(e("<img>",{src:a.createObjectURL(i)})),$form=e(['<form enctype="multipart/form-data" ','encoding="multipart/form-data" action="upload/image" ','method="post" id="villain-upload-form-'+this.dataId+'">','<input id="villain-upload-file-'+this.dataId+'" ','type="file" ','name="villain-upload-file-'+this.dataId+'" ','accept="image/*">',"</form>"].join("\n")),this.$setup.append("<hr>"),this.$setup.append('<button class="villain-image-dropper-upload">Last opp og lagre</button>'),this.file=i)},getJSON:function(){return data=this.getData(),json={type:this.type,data:{url:data.url,sizes:data.sizes,title:data.title||"",credits:data.credits||"",link:data.link||""}}},getHTML:function(){return url=this.$("img").attr("src"),this.template({url:url})},setup:function(){if(o=this,this.hasData()){this.clearSetup(),data=this.getData(),$meta=e(['<label for="title">Tittel</label><input value="'+data.title+'" type="text" name="title" />','<label for="credits">Kreditering</label><input value="'+data.credits+'" type="text" name="credits" />','<label for="link">URL</label><input value="'+data.link+'" type="text" name="link" />'].join("\n")),this.$setup.append($meta),this.$setup.find('input[name="title"]').on("keyup",a.debounce(function(){o.setDataProperty("title",e(this).val())},700,!1)),this.$setup.find('input[name="credits"]').on("keyup",a.debounce(function(){o.setDataProperty("credits",e(this).val())},700,!1)),this.$setup.find('input[name="link"]').on("keyup",a.debounce(function(){o.setDataProperty("link",e(this).val())},700,!1)),this.$setup.append(e("<label>Størrelse</label>"));for(var t in data.sizes)data.sizes.hasOwnProperty(t)&&(checked="",data.sizes[t]==data.url&&(checked=' checked="checked"'),$radio=e('<label for="'+t+'"><input type="radio" name="imagesize" value="'+data.sizes[t]+'"'+checked+" />"+t+"</label>"),this.$setup.append($radio));this.$setup.find("input[type=radio]").on("change",e.proxy(function(t){this.setUrl(e(t.target).val())},this)),this.hideSetup()}else this.$(".villain-image-block").hide(),$imageDropper=e(['<div class="villain-image-dropper"><i class="fa fa-image"></i>',"<div>Dra bildet du vil laste opp hit</div>","<div><hr></div>","<div>",'<button class="villain-image-browse-button">Hent bilde fra server</button>',"</div>","</div>"].join("\n")),$imageDropper.find(".villain-image-browse-button").on("click",e.proxy(this.onImageBrowseButton,this)),this.$setup.append($imageDropper),this.$setup.show()},setUrl:function(t){this.setDataProperty("url",t),this.refreshContentBlock()},onImageBrowseButton:function(t){t.preventDefault(),this.loading(),e.ajax({type:"get",url:this.addToPathName(n.options.browseURL),cache:!1,contentType:!1,processData:!1,dataType:"json"}).done(e.proxy(function(t){if(200!=t.status)return alert("Ingen bilder fantes."),this.done(),!1;if(!t.hasOwnProperty("images"))return!1;$images=e("<div />");for(var i=0;i<t.images.length;i++)img=t.images[i],$store_img=e('<img src="'+img.thumb+'" />'),$store_img.data("sizes",img.sizes).data("large",img.src).data("title",img.title).data("credits",img.credits),$images.append($store_img);$images.on("click","img",e.proxy(function(i){this.setData({url:e(i.target).data("large"),title:e(i.target).data("title"),credits:e(i.target).data("credits"),sizes:e(i.target).data("sizes")}),t=this.getData(),this.refreshContentBlock(),this.hideSetup(),this.setup()},this)),this.$setup.html(""),this.$setup.append('<div class="villain-message success">Klikk på bildet du vil sette inn</div>'),this.$setup.append($images),this.done()},this))},onUploadImagesButton:function(t){var e=t.target.files,i="undefined"!=typeof URL?URL:"undefined"!=typeof webkitURL?webkitURL:null;fileList=[];for(var a=0;a<e.length;a++){var n=e[a];fileList.push(['<div class="three">','<div class="center-cropped" style="background-image: url(',i.createObjectURL(n),');"></div>',"</div>"].join("\n"))}listHTML='<div style="margin-top: 10px;" class="wrapper"><div class="row">';for(var o=0;o<fileList.length;o++)listHTML+=o&&o%4===0?'</div><div style="margin-top: 15px" class="row">'+fileList[o]:fileList[o];listHTML+="</div></div>",this.$setup.append(listHTML)}},{getButton:function(e){var i="image";return(t=a.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-file-image-o"></i>',"<p>img</p>","</button>"].join("\n")))({id:e,type:i})}}),n.Blocks.Slideshow=n.Block.extend({type:"slideshow",template:a.template(['<div class="villain-slideshow-block villain-content" contenteditable="false">',"<h4>Slideshow</h4>","<%= content %>","</div>"].join("\n")),renderEditorHtml:function(){return blockTemplate=this.renderContentBlockHtml(),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderContentBlockHtml:function(){return images=this.renderDataImages(),this.template({content:images})},renderDataImages:function(){var t=this.getData();if(a.isUndefined(t.images))return"";for(var e="",i=0;i<t.images.length;i++)img=t.images[i],e+='<img src="'+t.media_url+"/"+img.sizes.thumb+'" />';return e},renderEmpty:function(){return blockTemplate=this.template({content:'<i class="fa fa-th"></i>'}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},getAllImageseries:function(){o=this,$select=this.$setup.find(".imageserie-select"),e.ajax({type:"get",dataType:"json",accepts:{json:"text/json"},url:this.addToPathName(n.options.imageseriesURL),cache:!1,contentType:!1,processData:!1,xhr:function(){var t=e.ajaxSettings.xhr();return t.upload&&t.upload.addEventListener("progress",o.progressHandlingFunction,!1),t}}).done(e.proxy(function(t){"200"==t.status&&($select.append(o.buildOptions(t.series,!0)),a.isUndefined(o.data.imageseries)||$select.val(o.data.imageseries).change())}))},getImageseries:function(t){e.ajax({type:"get",dataType:"json",accepts:{json:"text/json"},url:this.addToPathName(n.options.imageseriesURL),data:{series:t},cache:!1,contentType:!1,xhr:function(){var t=e.ajaxSettings.xhr();return t.upload&&t.upload.addEventListener("progress",o.progressHandlingFunction,!1),t}}).done(e.proxy(function(t){if("200"==t.status){var i={};if(i.imageseries=t.series,i.media_url=t.media_url,i.images=t.images,o.$setup.find(".imageserie-size-select").length>0);else{var n='<label for="imageserie-size">Str:</label><select class="imageserie-size-select"         name="imageserie-size"></select>';o.$setup.append(n)}var l=o.$setup.find(".imageserie-size-select");l.html(""),l.append(o.buildOptions(t.sizes,!0)),a.isUndefined(o.data.size)||l.val(o.data.size).change(),l.on("change",function(){o.setDataProperty("size",e(this).val()),o.hideSetup()}),o.setData(i),o.refreshContentBlock()}}))},buildOptions:function(t,e){html=e?'<option disabled="disabled" selected="selected">---</option>':"";for(var i=0;i<t.length;i++)val=t[i],html+='<option value="'+val+'">'+val+"</option>";return html},setup:function(){if(this.hasData()){this.$setup.hide();var t='<select class="imageserie-select" name="imageserie"></select>';this.$setup.append(e(['<label for="imageserie">Bildeserie</label>',t].join("\n"))),$select=this.$setup.find(".imageserie-select"),$select.on("change",function(){o.getImageseries(e(this).val())}),this.getAllImageseries()}else{this.$content.hide(),o=this,data=this.getData();var t='<select class="imageserie-select" name="imageserie"></select>';this.$setup.append(e(['<label for="imageserie">Bildeserie</label>',t].join("\n"))),$select=this.$setup.find(".imageserie-select"),$select.on("change",function(){o.getImageseries(e(this).val())}),this.getAllImageseries()}},getData:function(){return data=this.data},getJSON:function(){var t=this.getData();return delete t.images,delete t.media_url,json={type:this.type,data:t}},getHTML:function(){return textNode=this.getTextBlock().html(),"<h3>"+markdown.toHTML(textNode)+"</h3>"}},{getButton:function(e){var i="slideshow";return(t=a.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-th"></i>',"<p>slides</p>","</button>"].join("\n")))({id:e,type:i})
}}),n.Blocks.Video=n.Block.extend({type:"video",providers:{vimeo:{regex:/(?:http[s]?:\/\/)?(?:www.)?vimeo.com\/(.+)/,html:['<iframe src="{{protocol}}//player.vimeo.com/video/{{remote_id}}?title=0&byline=0" ','width="580" height="320" frameborder="0"></iframe>'].join("\n")},youtube:{regex:/(?:http[s]?:\/\/)?(?:www.)?(?:(?:youtube.com\/watch\?(?:.*)(?:v=))|(?:youtu.be\/))([^&].+)/,html:['<iframe src="{{protocol}}//www.youtube.com/embed/{{remote_id}}" ','width="580" height="320" frameborder="0" allowfullscreen></iframe>'].join("\n")}},template:a.template('<div class="villain-video-block villain-content"><%= content %></div>'),events:{"click .villain-setup-block button":"onClick"},onClick:function(t){t.preventDefault(),videoUrl=this.$(".villain-video-setup-url").val(),a.isURI(videoUrl)&&(embedString=this.buildString(videoUrl),this.$content.html(embedString),this.hideSetup())},buildString:function(t){var e,i;if(a.each(this.providers,function(n,o){e=n.regex.exec(t),null===e||a.isUndefined(e[1])||(i={source:o,remote_id:e[1]},this.setData(i))},this),this.providers.hasOwnProperty(i.source)){var n=this.providers[i.source].html.replace("{{protocol}}",window.location.protocol).replace("{{remote_id}}",i.remote_id).replace("{{width}}","100%");return n}},initialize:function(t,e){n.Block.prototype.initialize.apply(this,[t,e]),a.extend(this.events,n.Block.prototype.events)},renderEditorHtml:function(){if(this.providers.hasOwnProperty(this.data.source)){var t=this.providers[this.data.source].html.replace("{{protocol}}",window.location.protocol).replace("{{remote_id}}",this.data.remote_id).replace("{{width}}","100%");return blockTemplate=this.template({content:t}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})}},renderEmpty:function(){return blockTemplate=this.template({content:""}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},getJSON:function(){return url=this.$("img").attr("src"),json={type:this.type,data:this.data}},getHTML:function(){return url=this.$("img").attr("src"),this.template({url:url})},setup:function(){this.hasData()||(this.$(".villain-video-block").hide(),videoSetup=e(['<div class="villain-video-setup-icon">','<i class="fa fa-video-camera"></i>',"<div>Lim inn link til youtube eller vimeo, f.eks http://www.youtube.com/watch?v=jlbunmCbTBA</div>","</div>",'<div class="villain-video-setup-input-wrapper">','<input type="text" name="villain-video-setup-url" class="villain-video-setup-url" />',"</div>","<div><hr></div>",'<div style="text-align: center;"><button>Hent video</button></div>'].join("\n")),this.$setup.append(videoSetup),this.$setup.show())}},{getButton:function(e){var i="video";return(t=a.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-video-camera"></i>',"<p>video</p>","</button>"].join("\n")))({id:e,type:i})}}),n.Blocks.Columns=n.Block.extend({type:"columns",template:a.template('<div class="row"></div>'),columnTemplate:a.template('<div class="<%= columnClass %>"></div>'),events:{'keyup input[name="villain-columns-number"]':"_updateColumnCount","click button.villain-columns-apply":"_applyColumnCount"},initialize:function(t,e){n.Block.prototype.initialize.apply(this,[t,e]),a.extend(this.events,n.Block.prototype.events)},deleteBlock:function(){n.BlockStore.hasOwnProperty(this.store)&&n.BlockStore.delStore(this.store),n.BlockStore.del("main",this.dataId),this.destroy()},renderBlock:function(t){return t.$parent?void(t.$parent.attr("id")===this.$el.attr("id")&&this.$el.append(t.el)):!1},render:function(){return n.BlockStore.create(this.id),this.store=this.id,this.$el.attr("data-blockstore",this.store),blockTemplate=this.template({content:this.data}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate}),this.el.innerHTML=wrapperTemplate,this.$inner=this.$(".villain-block-inner"),this.$content=this.$(".row"),this.data?this.renderEditorHtml():this.renderEmpty(),this.setup&&(this.$inner.prepend(this.setupTemplate()),this.$setup=this.$(".villain-setup-block"),this.setup()),this},renderEditorHtml:function(){return this.parseRow(),blockTemplate=this.template({content:this.data}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate}),this},renderEmpty:function(){return blockTemplate=this.template({content:this.data}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate}),this},getRow:function(){return this.$row?this.$row:(this.$row=this.$(".row"),this.$row)},getColumns:function(t){return this.getRow().children(t)},getColumn:function(t){return this.getRow().children(":eq("+t+")")},parseRow:function(){$row=this.getRow();for(var t=0;t<=this.data.length-1;t++){columnClass=this.data[t].class,columnData=this.data[t].data,$column=e('<div class="'+columnClass+'"></div>'),$row.append($column),$column=this.getColumn(t),addblock=new n.Plus(this.store),$column.append(addblock.$el);for(var i=0;i<columnData.length;i++)(BlockClass=n.BlockRegistry.getBlockClassByType(columnData[i].type))!==!1&&(block=new BlockClass(columnData[i].data,this.store),$column.append(block.$el),addblock=new n.Plus(this.store),$column.append(addblock.$el))}},getJSON:function(){var t={type:this.type,data:[]};return this.getColumns().each(function(){var i=[];e(this).children(".villain-block-wrapper").each(function(){var t=n.BlockStore.getBlockById(e(this).attr("data-blockstore"),e(this).attr("data-block-id"));i.push(t.getJSON())}),t.data.push({"class":e(this).attr("class"),data:i})}),t},setup:function(){this.hasData()?this.$setup.hide():(this.getRow().hide(),this.$setup.append(['<label for="villain-columns-number">Antall kolonner</label>','<input type="text" class="villain-columns-number" name="villain-columns-number" />'].join("\n")),this.$setup.show(),this.$(".villain-columns-number").attr("autofocus","autofocus"))},_updateColumnCount:function(t){var i=e(t.target).val();this.$(".villain-column-widths").remove(),columnCountWrapper=e('<div class="villain-column-widths" />');for(var a=1;a<parseInt(i)+1;a++)columnCountWrapper.append(['<label for="villain-column-width-'+a+'">Kolonne '+a+" klassenavn (one, two, three ...)</label>",'<input type="text" name="villain-column-width-'+a+'" class="villain-column-width" />'].join("\n"));columnCountWrapper.append('<button class="villain-columns-apply">Sett opp kolonner</button>'),this.$setup.append(columnCountWrapper)},_applyColumnCount:function(t){t.preventDefault(),columnCount=this.$('input[name="villain-columns-number"]').val();for(var e=1;e<parseInt(columnCount)+1;e++)columnClass=this.$('input[name="villain-column-width-'+e+'"]').val(),this.getRow().append(this.columnTemplate({columnClass:columnClass})),addblock=new n.Plus(this.store),this.getColumn(e-1).append(addblock.$el);this.$setup.hide(),this.getRow().show()},onSetupClick:function(t){t.stopPropagation(),$button=this.$(".villain-action-button-setup"),$button.hasClass("active")?($button.removeClass("active"),this.hideSetup()):($button.addClass("active"),this.showSetup())},renderPlus:function(){return addblock=new n.Plus("main")}},{getButton:function(e){var i="columns";return(t=a.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-columns"></i>',"<p>cols</p>","</button>"].join("\n")))({id:e,type:i})}});n.Editor=Backbone.View.extend({el:"#villain",textArea:"#id_body",data:{},blocks:{},events:{"submit form":"clickSubmit","dragover .villain-droppable":"onDragOverDroppable","dragenter .villain-droppable":"onDragEnterDroppable","dragleave .villain-droppable":"onDragLeaveDroppable","drop .villain-droppable":"onDropDroppable","drop .villain-text-block":"onDropTextblock"},initialize:function(t){_this=this,this.$textArea=e(t.textArea)||this.textArea,e('<div id="villain"></div>').insertAfter(this.$textArea),this.el="#villain",this.$el=e(this.el),this.$textArea.hide(),this.isDirty=!1;try{this.data=JSON.parse(this.$textArea.val())}catch(i){this.data=null}e("form").submit(function(){_this.$textArea.val(_this.getJSON())}),n.BlockStore.create("main"),n.setOptions(t),n.BlockRegistry.initialize(t.extraBlocks),this.render()},render:function(){if(addblock=new n.Plus("main"),this.$el.append(addblock.$el),formatPopUp=new n.FormatPopUp,this.$el.append(formatPopUp.$el),!this.data)return!1;for(var t=0;t<=this.data.length-1;t++)blockJson=this.data[t],(BlockClass=n.BlockRegistry.getBlockClassByType(blockJson.type))!==!1?(block=new BlockClass(blockJson.data),this.$el.append(block.$el),this.$el.append(block.renderPlus().$el)):console.error("Villain: No class found for type: "+blockJson.type)},organizeMode:function(){e(".villain-block-wrapper").toggleClass("organize"),e('.villain-block-wrapper[data-block-type="columns"]').removeClass("organize"),e(".organize .villain-content").hide()},getJSON:function(){var t=[];return this.$(".villain-block-wrapper").each(function(){(block=n.BlockStore.getBlockById("main",e(this).data("block-id")))!==!1&&(blockJson=block.getJSON(),t.push(blockJson))}),ret=JSON.stringify(t),"[]"!=ret?ret:""},onDragEnterDroppable:function(t){e(".villain-add-block-button",t.currentTarget).addClass("drop-hover"),t.preventDefault(),t.stopPropagation()},onDragLeaveDroppable:function(t){e(".villain-add-block-button",t.currentTarget).removeClass("drop-hover"),t.preventDefault(),t.stopPropagation()},onDragOverDroppable:function(t){t.preventDefault(),t.stopPropagation()},onDropDroppable:function(t){return target=t.currentTarget,e(target).hasClass("villain-droppable")!==!0?(t.preventDefault(),t.stopPropagation(),!1):(e(".villain-add-block-button",target).removeClass("drop-hover"),sourceId=t.originalEvent.dataTransfer.getData("text/plain"),$source=e("[data-block-id="+sourceId+"]"),$sourceAdd=$source.next(),$source.detach(),$sourceAdd.detach(),$source.insertAfter(e(target)),oldBlockStore=$source.attr("data-blockstore"),newBlockStore=e(target).attr("data-blockstore"),block=n.BlockStore.getBlockById(oldBlockStore,sourceId),block.store=newBlockStore,n.BlockStore.del(oldBlockStore,sourceId),n.BlockStore.add(newBlockStore,sourceId,block),$source.attr("data-blockstore",newBlockStore),$sourceAdd.insertAfter($source),void $sourceAdd.attr("data-blockstore",newBlockStore))},onDropTextblock:function(t){return $target=e(t.currentTarget).closest(".villain-block-wrapper").shake(),t.preventDefault(),t.stopPropagation(),!1},clickSubmit:function(t){n.EventBus.trigger("posts:submit",t),form=this.checkForm(),form.valid===!1&&t.preventDefault(),window.onbeforeunload=e.noop()},checkForm:function(){var t={valid:!0,errors:[]};return""===$titleEl.val()&&(t.errors.push("Overskrift kan ikke være blank."),t.valid=!1,$titleEl.parent().parent().addClass("error"),$titleEl.parent().parent().append('<span class="help-inline"><strong><i class="icon-hand-up"></i> Feltet er påkrevet.</strong></span>'),e("html, body").animate({scrollTop:0},5)),t},markDirty:function(){this.isDirty=!0}}),n.FormatPopUp=Backbone.View.extend({tagName:"div",className:"villain-format-popup",events:{"click .villain-format-bold":"onClickBold","click .villain-format-italic":"onClickItalic","click .villain-format-link":"onClickLink","click .villain-format-unlink":"onClickUnlink"},onClickBold:function(t){t.preventDefault(),document.execCommand("bold",!1,!1),this.activateButton(".villain-format-bold")},onClickItalic:function(t){t.preventDefault(),document.execCommand("italic",!1,!1),this.activateButton(".villain-format-italic")},onClickLink:function(t){t.preventDefault();var e=prompt("Sett inn link:"),i=/((ftp|http|https):\/\/.)|mailto(?=\:[-\.\w]+@)/;e&&e.length>0&&(i.test(e)||(e="http://"+e),document.execCommand("CreateLink",!1,e)),this.activateButton(".villain-format-link")},onClickUnlink:function(t){t.preventDefault(),document.execCommand("unlink",!1,!1)},initialize:function(){this.render(),n.EventBus.on("formatpopup:show",this.showPopUp,this),n.EventBus.on("formatpopup:hide",this.hidePopUp,this)},render:function(){return this.$el.append('<button class="popup-button villain-format-bold"><i class="fa fa-bold"></i></button>'),this.$el.append('<button class="popup-button villain-format-italic"><i class="fa fa-italic"></i></button>'),this.$el.append('<button class="popup-button villain-format-link"><i class="fa fa-link"></i></button>'),this.$el.append('<button class="popup-button villain-format-unlink"><i class="fa fa-unlink"></i></button>'),this},showPopUp:function(t){$el=t.$el;var i=window.getSelection(),a=i.getRangeAt(0),n=a.getBoundingClientRect(),o=$el.offset(),l={};mainContent=e("section#maincontent"),l.top=n.top+mainContent.scrollTop(),l.left=(n.left+n.right)/2-this.$el.width()/2-o.left+12,parseInt(l.left)<0&&(l.left="0"),l.left=l.left+"px",this.deactivateButtons(),this.activeButtons(),this.$el.addClass("show-popup"),this.$el.css(l)},hidePopUp:function(){this.$el.removeClass("show-popup")},activeButtons:function(){var t,e=window.getSelection();e.rangeCount>0&&(t=e.getRangeAt(0).startContainer.parentNode),t&&"A"==t.nodeName&&this.activateButton(".villain-format-link"),document.queryCommandState("bold")&&this.activateButton(".villain-format-bold"),document.queryCommandState("italic")&&this.activateButton(".villain-format-italic")},activateButton:function(t){this.$(t).addClass("active")},deactivateButtons:function(){this.$(".popup-button").removeClass("active")}}),n.Editor.HTML=n.Editor.HTML||{},n.Editor.EditorHTML=n.Editor.EditorHTML||{},n.toMD=function(t){var t=toMarkdown(t);return t=t.replace(/&nbsp;/g," "),t=t.replace(/([^<>]+)(<div>)/g,"$1\n$2").replace(/<div><div>/g,"\n<div>").replace(/<div><br \/><\/div>/g,"\n\n").replace(/(?:<div>)([^<>]+)(?:<div>)/g,"$1\n").replace(/(?:<div>)(?:<br>)?([^<>]+)(?:<br>)?(?:<\/div>)/g,"$1\n").replace(/<\/p>/g,"\n\n").replace(/<(.)?br(.)?>/g,"\n").replace(/&lt;/g,"<").replace(/&gt;/g,">"),aggressiveStrip=!0,t=aggressiveStrip?t.replace(/<\/?[^>]+(>|$)/g,""):t.replace(/<(?=\S)\/?[^>]+(>|$)/gi,"")},n.toHTML=function(t,e){if(a.isUndefined(t))return"";e=a.classify(e);var i=t,o="Text"===e;a.isUndefined(o)&&(o=!1),o&&(i="<div>"+i),i=i.replace(/\[([^\]]+)\]\(([^\)]+)\)/gm,function(t,e,i){return'<a href="'+i+'">'+e.replace(/\r?\n/g,"")+"</a>"}),i=a.reverse(a.reverse(i).replace(/_(?!\\)((_\\|[^_])*)_(?=$|[^\\])/gm,function(t,e){return">i/<"+e.replace(/\r?\n/g,"").replace(/[\s]+$/,"")+">i<"}).replace(/\*\*(?!\\)((\*\*\\|[^\*\*])*)\*\*(?=$|[^\\])/gm,function(t,e){return">b/<"+e.replace(/\r?\n/g,"").replace(/[\s]+$/,"")+">b<"})),i=i.replace(/^\> (.+)$/gm,"$1");var l,r;for(l in n.Formatters)n.Formatters.hasOwnProperty(l)&&(r=n.Formatters[l],!a.isUndefined(r.toHTML)&&a.isFunction(r.toHTML)&&(i=r.toHTML(i)));return o&&(i=i.replace(/\r?\n\r?\n/gm,"</div><div><br></div><div>").replace(/\r?\n/gm,"</div><div>")),i=i.replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;").replace(/\r?\n/g,"<br>").replace(/\*\*/,"").replace(/__/,""),i=i.replace(/\\\*/g,"*").replace(/\\\[/g,"[").replace(/\\\]/g,"]").replace(/\\\_/g,"_").replace(/\\\(/g,"(").replace(/\\\)/g,")").replace(/\\\-/g,"-"),o&&(i+="</div>"),i},n.setOptions=function(t){(a.isUndefined(t.imageSeries)||a.isUndefined(t.baseURL))&&console.error("Villain: baseURL and imageSeries MUST be set on initialization."),n.defaults.browseURL=t.baseURL+n.defaults.browseURL+t.imageSeries,n.defaults.uploadURL=t.baseURL+n.defaults.uploadURL+t.imageSeries,n.defaults.imageseriesURL=t.baseURL+n.defaults.imageseriesURL,n.options=e.extend({},n.defaults,t)},n.browser=function r(){var r={};if(this.getIEversion()>0)r.msie=!0;else{var t=navigator.userAgent.toLowerCase(),e=/(chrome)[ \/]([\w.]+)/.exec(t)||/(webkit)[ \/]([\w.]+)/.exec(t)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(t)||/(msie) ([\w.]+)/.exec(t)||t.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(t)||[],i={browser:e[1]||"",version:e[2]||"0"};e[1]&&(r[i.browser]=!0),parseInt(i.version,10)<9&&r.msie&&(r.oldMsie=!0),r.chrome?r.webkit=!0:r.webkit&&(r.safari=!0)}return r},n.Editor.processPaste=function(t){var i;return t.match(/(class=\"?Mso|style=\"[^\"]*\bmso\-|w:WordDocument)/gi)?(i=n.Editor.wordClean(t),i=n.Editor.clean(e("<div>").append(i).html(),!1,!0),i=n.Editor.removeEmptyTags(i)):(i=n.Editor.clean(t,!1,!0),i=n.Editor.removeEmptyTags(i)),i=n.Editor.plainPasteClean(i),""!==i?i:void 0},n.Editor.wordClean=function(t){t.indexOf("<body")>=0&&(t=t.replace(/[.\s\S\w\W<>]*<body[^>]*>([.\s\S\w\W<>]*)<\/body>[.\s\S\w\W<>]*/g,"$1")),t=t.replace(/<p(.*?)class="?'?MsoListParagraph"?'?([\s\S]*?)>([\s\S]*?)<\/p>/gi,"<ul><li><p>$3</p></li></ul>"),t=t.replace(/<p(.*?)class="?'?MsoListParagraphCxSpFirst"?'?([\s\S]*?)>([\s\S]*?)<\/p>/gi,"<ul><li><p>$3</p></li>"),t=t.replace(/<p(.*?)class="?'?MsoListParagraphCxSpMiddle"?'?([\s\S]*?)>([\s\S]*?)<\/p>/gi,"<li><p>$3</p></li>"),t=t.replace(/<p(.*?)class="?'?MsoListParagraphCxSpLast"?'?([\s\S]*?)>([\s\S]*?)<\/p>/gi,"<li><p>$3</p></li></ul>"),t=t.replace(/<span([^<]*?)style="?'?mso-list:Ignore"?'?([\s\S]*?)>([\s\S]*?)<span/gi,"<span><span"),t=t.replace(/<!--\[if \!supportLists\]-->([\s\S]*?)<!--\[endif\]-->/gi,""),t=t.replace(/(\n|\r| class=(")?Mso[a-zA-Z]+(")?)/gi," "),t=t.replace(/<!--[\s\S]*?-->/gi,""),t=t.replace(/<(\/)*(meta|link|span|\\?xml:|st1:|o:|font)(.*?)>/gi,"");for(var e=["style","script","applet","embed","noframes","noscript"],i=0;i<e.length;i++){var a=new RegExp("<"+e[i]+".*?"+e[i]+"(.*?)>","gi");t=t.replace(a,"")}t=t.replace(/([\w\-]*)=("[^<>"]*"|'[^<>']*'|\w+)/gi,""),t=t.replace(/&nbsp;/gi,"");var o;do o=t,t=t.replace(/<[^\/>][^>]*><\/[^>]+>/gi,"");while(t!=o);return t=n.Editor.clean(t)},n.Editor.clean=function(t,i,a,n,o){o=["accept","accept-charset","accesskey","action","align","alt","async","autocomplete","autofocus","autoplay","autosave","background","bgcolor","border","charset","cellpadding","cellspacing","checked","cite","class","color","cols","colspan","contenteditable","contextmenu","controls","coords","data","data-.*","datetime","default","defer","dir","dirname","disabled","download","draggable","dropzone","enctype","for","form","formaction","headers","height","hidden","high","href","hreflang","icon","id","ismap","itemprop","keytype","kind","label","lang","language","list","loop","low","max","maxlength","media","method","min","multiple","name","novalidate","open","optimum","pattern","ping","placeholder","poster","preload","pubdate","radiogroup","readonly","rel","required","reversed","rows","rowspan","sandbox","scope","scoped","scrolling","seamless","selected","shape","size","sizes","span","src","srcdoc","srclang","srcset","start","step","summary","spellcheck","style","tabindex","target","title","type","translate","usemap","value","valign","width","wrap"],n=["!--","a","abbr","address","area","article","aside","audio","b","base","bdi","bdo","blockquote","br","button","canvas","caption","cite","code","col","colgroup","datalist","dd","del","details","dfn","dialog","div","dl","dt","em","embed","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","header","hgroup","hr","i","iframe","img","input","ins","kbd","keygen","label","legend","li","link","main","map","mark","menu","menuitem","meter","nav","noscript","object","ol","optgroup","option","output","p","param","pre","progress","queue","rp","rt","ruby","s","samp","script","section","select","small","source","span","strong","style","sub","summary","sup","table","tbody","td","textarea","tfoot","th","thead","time","title","tr","track","u","ul","var","video","wbr"],t=t.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"");var l=new RegExp("<\\/?((?!(?:"+n.join("|")+"))\\w+)[^>]*?>","gi");t=t.replace(l,"");var r=new RegExp("( (?!(?:"+o.join("|")+"))[a-zA-Z0-9-_]+)=((?:.(?!\\s+(?:\\S+)=|[>]|(\\/>)))+.)","gi");t=t.replace(r,"");var s=new RegExp("style=(\"[a-zA-Z0-9:;\\.\\s\\(\\)\\-\\,!\\/'%]*\"|'[a-zA-Z0-9:;\\.\\s\\(\\)\\-\\,!\\/\"%]*')","gi");t=t.replace(s,"");var c=e("<div>").append(t);return c.find('[class]:not([class^="fr-"])').each(function(t,i){e(i).removeAttr("class")}),t=c.html()},n.Editor.plainPasteClean=function(t){var i=e("<div>").html(t);i.find("h1, h2, h3, h4, h5, h6, pre, blockquote").each(function(t,i){e(i).replaceWith("<p>"+e(i).html()+"</p>")});for(var a=function(t,i){e(i).replaceWith(e(i).html())};i.find("strong, em, strike, b, u, i, sup, sub, span, a").length;)i.find("strong, em, strike, b, u, i, sup, sub, span, a").each(a);return i.html()},n.Editor.removeEmptyTags=function(t){for(var i,a=e("<div>").html(t),n=a.find("*:empty:not(br, img, td, th)");n.length;){for(i=0;i<n.length;i++)e(n[i]).remove();n=a.find("*:empty:not(br, img, td, th)")}a.find("> div").each(function(t,i){e(i).replaceWith(e(i).html()+"<br/>")});for(var o=a.find("div");o.length;){for(i=0;i<o.length;i++){var l=e(o[i]),r=l.html().replace(/\u0009/gi,"").trim();l.replaceWith(r)}o=a.find("div")}return a.html()},n.Editor.pasteHtmlAtCaret=function(t){var e,i;if(window.getSelection){if(e=window.getSelection(),e.getRangeAt&&e.rangeCount){i=e.getRangeAt(0),i.deleteContents();var a=document.createElement("div");a.innerHTML=t;for(var n,o,l=document.createDocumentFragment();n=a.firstChild;)o=l.appendChild(n);i.insertNode(l),o&&(i=i.cloneRange(),i.setStartAfter(o),i.collapse(!0),e.removeAllRanges(),e.addRange(i))}}else document.selection&&"Control"!=document.selection.type&&document.selection.createRange().pasteHTML(t)},n.BlockRegistry={},n.BlockRegistry.initialize=function(t){n.BlockRegistry.Map=["Text","Header","Blockquote","List","Image","Slideshow","Video","Divider","Columns"],a.isUndefined(t)||n.BlockRegistry.addExtraBlocks(t),n.BlockRegistry.checkBlocks()},n.BlockRegistry.addExtraBlocks=function(t){n.BlockRegistry.Map=n.BlockRegistry.Map.concat(t)},n.BlockRegistry.add=function(t){n.BlockRegistry.Map.push(t)},n.BlockRegistry.checkBlocks=function(){for(i=0;i<n.BlockRegistry.Map.length;++i)type=n.BlockRegistry.Map[i],a.isUndefined(n.Blocks[a(type).capitalize()])&&console.error("Villain: Missing block source for "+type+"! Please ensure it is included.")},n.BlockRegistry.getBlockClassByType=function(t){return-1!==n.BlockRegistry.Map.indexOf(a(t).capitalize())?n.Blocks[a(t).capitalize()]:!1}}(jQuery,_);