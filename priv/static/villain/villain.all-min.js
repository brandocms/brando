if(function(){var t=this,e=t._,n=Array.prototype,r=Object.prototype,i=Function.prototype,a=n.push,s=n.slice,o=n.concat,l=r.toString,u=r.hasOwnProperty,c=Array.isArray,h=Object.keys,f=i.bind,p=function(t){return t instanceof p?t:this instanceof p?void(this._wrapped=t):new p(t)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=p),exports._=p):t._=p,p.VERSION="1.7.0";var g=function(t,e,n){if(void 0===e)return t;switch(null==n?3:n){case 1:return function(n){return t.call(e,n)};case 2:return function(n,r){return t.call(e,n,r)};case 3:return function(n,r,i){return t.call(e,n,r,i)};case 4:return function(n,r,i,a){return t.call(e,n,r,i,a)}}return function(){return t.apply(e,arguments)}};p.iteratee=function(t,e,n){return null==t?p.identity:p.isFunction(t)?g(t,e,n):p.isObject(t)?p.matches(t):p.property(t)},p.each=p.forEach=function(t,e,n){if(null==t)return t;e=g(e,n);var r,i=t.length;if(i===+i)for(r=0;i>r;r++)e(t[r],r,t);else{var a=p.keys(t);for(r=0,i=a.length;i>r;r++)e(t[a[r]],a[r],t)}return t},p.map=p.collect=function(t,e,n){if(null==t)return[];e=p.iteratee(e,n);for(var r,i=t.length!==+t.length&&p.keys(t),a=(i||t).length,s=Array(a),o=0;a>o;o++)r=i?i[o]:o,s[o]=e(t[r],r,t);return s};var d="Reduce of empty array with no initial value";p.reduce=p.foldl=p.inject=function(t,e,n,r){null==t&&(t=[]),e=g(e,r,4);var i,a=t.length!==+t.length&&p.keys(t),s=(a||t).length,o=0;if(arguments.length<3){if(!s)throw new TypeError(d);n=t[a?a[o++]:o++]}for(;s>o;o++)i=a?a[o]:o,n=e(n,t[i],i,t);return n},p.reduceRight=p.foldr=function(t,e,n,r){null==t&&(t=[]),e=g(e,r,4);var i,a=t.length!==+t.length&&p.keys(t),s=(a||t).length;if(arguments.length<3){if(!s)throw new TypeError(d);n=t[a?a[--s]:--s]}for(;s--;)i=a?a[s]:s,n=e(n,t[i],i,t);return n},p.find=p.detect=function(t,e,n){var r;return e=p.iteratee(e,n),p.some(t,function(t,n,i){return e(t,n,i)?(r=t,!0):void 0}),r},p.filter=p.select=function(t,e,n){var r=[];return null==t?r:(e=p.iteratee(e,n),p.each(t,function(t,n,i){e(t,n,i)&&r.push(t)}),r)},p.reject=function(t,e,n){return p.filter(t,p.negate(p.iteratee(e)),n)},p.every=p.all=function(t,e,n){if(null==t)return!0;e=p.iteratee(e,n);var r,i,a=t.length!==+t.length&&p.keys(t),s=(a||t).length;for(r=0;s>r;r++)if(i=a?a[r]:r,!e(t[i],i,t))return!1;return!0},p.some=p.any=function(t,e,n){if(null==t)return!1;e=p.iteratee(e,n);var r,i,a=t.length!==+t.length&&p.keys(t),s=(a||t).length;for(r=0;s>r;r++)if(i=a?a[r]:r,e(t[i],i,t))return!0;return!1},p.contains=p.include=function(t,e){return null==t?!1:(t.length!==+t.length&&(t=p.values(t)),p.indexOf(t,e)>=0)},p.invoke=function(t,e){var n=s.call(arguments,2),r=p.isFunction(e);return p.map(t,function(t){return(r?e:t[e]).apply(t,n)})},p.pluck=function(t,e){return p.map(t,p.property(e))},p.where=function(t,e){return p.filter(t,p.matches(e))},p.findWhere=function(t,e){return p.find(t,p.matches(e))},p.max=function(t,e,n){var r,i,a=-1/0,s=-1/0;if(null==e&&null!=t){t=t.length===+t.length?t:p.values(t);for(var o=0,l=t.length;l>o;o++)r=t[o],r>a&&(a=r)}else e=p.iteratee(e,n),p.each(t,function(t,n,r){i=e(t,n,r),(i>s||i===-1/0&&a===-1/0)&&(a=t,s=i)});return a},p.min=function(t,e,n){var r,i,a=1/0,s=1/0;if(null==e&&null!=t){t=t.length===+t.length?t:p.values(t);for(var o=0,l=t.length;l>o;o++)r=t[o],a>r&&(a=r)}else e=p.iteratee(e,n),p.each(t,function(t,n,r){i=e(t,n,r),(s>i||1/0===i&&1/0===a)&&(a=t,s=i)});return a},p.shuffle=function(t){for(var e,n=t&&t.length===+t.length?t:p.values(t),r=n.length,i=Array(r),a=0;r>a;a++)e=p.random(0,a),e!==a&&(i[a]=i[e]),i[e]=n[a];return i},p.sample=function(t,e,n){return null==e||n?(t.length!==+t.length&&(t=p.values(t)),t[p.random(t.length-1)]):p.shuffle(t).slice(0,Math.max(0,e))},p.sortBy=function(t,e,n){return e=p.iteratee(e,n),p.pluck(p.map(t,function(t,n,r){return{value:t,index:n,criteria:e(t,n,r)}}).sort(function(t,e){var n=t.criteria,r=e.criteria;if(n!==r){if(n>r||void 0===n)return 1;if(r>n||void 0===r)return-1}return t.index-e.index}),"value")};var v=function(t){return function(e,n,r){var i={};return n=p.iteratee(n,r),p.each(e,function(r,a){var s=n(r,a,e);t(i,r,s)}),i}};p.groupBy=v(function(t,e,n){p.has(t,n)?t[n].push(e):t[n]=[e]}),p.indexBy=v(function(t,e,n){t[n]=e}),p.countBy=v(function(t,e,n){p.has(t,n)?t[n]++:t[n]=1}),p.sortedIndex=function(t,e,n,r){n=p.iteratee(n,r,1);for(var i=n(e),a=0,s=t.length;s>a;){var o=a+s>>>1;n(t[o])<i?a=o+1:s=o}return a},p.toArray=function(t){return t?p.isArray(t)?s.call(t):t.length===+t.length?p.map(t,p.identity):p.values(t):[]},p.size=function(t){return null==t?0:t.length===+t.length?t.length:p.keys(t).length},p.partition=function(t,e,n){e=p.iteratee(e,n);var r=[],i=[];return p.each(t,function(t,n,a){(e(t,n,a)?r:i).push(t)}),[r,i]},p.first=p.head=p.take=function(t,e,n){return null==t?void 0:null==e||n?t[0]:0>e?[]:s.call(t,0,e)},p.initial=function(t,e,n){return s.call(t,0,Math.max(0,t.length-(null==e||n?1:e)))},p.last=function(t,e,n){return null==t?void 0:null==e||n?t[t.length-1]:s.call(t,Math.max(t.length-e,0))},p.rest=p.tail=p.drop=function(t,e,n){return s.call(t,null==e||n?1:e)},p.compact=function(t){return p.filter(t,p.identity)};var m=function(t,e,n,r){if(e&&p.every(t,p.isArray))return o.apply(r,t);for(var i=0,s=t.length;s>i;i++){var l=t[i];p.isArray(l)||p.isArguments(l)?e?a.apply(r,l):m(l,e,n,r):n||r.push(l)}return r};p.flatten=function(t,e){return m(t,e,!1,[])},p.without=function(t){return p.difference(t,s.call(arguments,1))},p.uniq=p.unique=function(t,e,n,r){if(null==t)return[];p.isBoolean(e)||(r=n,n=e,e=!1),null!=n&&(n=p.iteratee(n,r));for(var i=[],a=[],s=0,o=t.length;o>s;s++){var l=t[s];if(e)s&&a===l||i.push(l),a=l;else if(n){var u=n(l,s,t);p.indexOf(a,u)<0&&(a.push(u),i.push(l))}else p.indexOf(i,l)<0&&i.push(l)}return i},p.union=function(){return p.uniq(m(arguments,!0,!0,[]))},p.intersection=function(t){if(null==t)return[];for(var e=[],n=arguments.length,r=0,i=t.length;i>r;r++){var a=t[r];if(!p.contains(e,a)){for(var s=1;n>s&&p.contains(arguments[s],a);s++);s===n&&e.push(a)}}return e},p.difference=function(t){var e=m(s.call(arguments,1),!0,!0,[]);return p.filter(t,function(t){return!p.contains(e,t)})},p.zip=function(t){if(null==t)return[];for(var e=p.max(arguments,"length").length,n=Array(e),r=0;e>r;r++)n[r]=p.pluck(arguments,r);return n},p.object=function(t,e){if(null==t)return{};for(var n={},r=0,i=t.length;i>r;r++)e?n[t[r]]=e[r]:n[t[r][0]]=t[r][1];return n},p.indexOf=function(t,e,n){if(null==t)return-1;var r=0,i=t.length;if(n){if("number"!=typeof n)return r=p.sortedIndex(t,e),t[r]===e?r:-1;r=0>n?Math.max(0,i+n):n}for(;i>r;r++)if(t[r]===e)return r;return-1},p.lastIndexOf=function(t,e,n){if(null==t)return-1;var r=t.length;for("number"==typeof n&&(r=0>n?r+n+1:Math.min(r,n+1));--r>=0;)if(t[r]===e)return r;return-1},p.range=function(t,e,n){arguments.length<=1&&(e=t||0,t=0),n=n||1;for(var r=Math.max(Math.ceil((e-t)/n),0),i=Array(r),a=0;r>a;a++,t+=n)i[a]=t;return i};var y=function(){};p.bind=function(t,e){var n,r;if(f&&t.bind===f)return f.apply(t,s.call(arguments,1));if(!p.isFunction(t))throw new TypeError("Bind must be called on a function");return n=s.call(arguments,2),r=function(){if(!(this instanceof r))return t.apply(e,n.concat(s.call(arguments)));y.prototype=t.prototype;var i=new y;y.prototype=null;var a=t.apply(i,n.concat(s.call(arguments)));return p.isObject(a)?a:i}},p.partial=function(t){var e=s.call(arguments,1);return function(){for(var n=0,r=e.slice(),i=0,a=r.length;a>i;i++)r[i]===p&&(r[i]=arguments[n++]);for(;n<arguments.length;)r.push(arguments[n++]);return t.apply(this,r)}},p.bindAll=function(t){var e,n,r=arguments.length;if(1>=r)throw new Error("bindAll must be passed function names");for(e=1;r>e;e++)n=arguments[e],t[n]=p.bind(t[n],t);return t},p.memoize=function(t,e){var n=function(r){var i=n.cache,a=e?e.apply(this,arguments):r;return p.has(i,a)||(i[a]=t.apply(this,arguments)),i[a]};return n.cache={},n},p.delay=function(t,e){var n=s.call(arguments,2);return setTimeout(function(){return t.apply(null,n)},e)},p.defer=function(t){return p.delay.apply(p,[t,1].concat(s.call(arguments,1)))},p.throttle=function(t,e,n){var r,i,a,s=null,o=0;n||(n={});var l=function(){o=n.leading===!1?0:p.now(),s=null,a=t.apply(r,i),s||(r=i=null)};return function(){var u=p.now();o||n.leading!==!1||(o=u);var c=e-(u-o);return r=this,i=arguments,0>=c||c>e?(clearTimeout(s),s=null,o=u,a=t.apply(r,i),s||(r=i=null)):s||n.trailing===!1||(s=setTimeout(l,c)),a}},p.debounce=function(t,e,n){var r,i,a,s,o,l=function(){var u=p.now()-s;e>u&&u>0?r=setTimeout(l,e-u):(r=null,n||(o=t.apply(a,i),r||(a=i=null)))};return function(){a=this,i=arguments,s=p.now();var u=n&&!r;return r||(r=setTimeout(l,e)),u&&(o=t.apply(a,i),a=i=null),o}},p.wrap=function(t,e){return p.partial(e,t)},p.negate=function(t){return function(){return!t.apply(this,arguments)}},p.compose=function(){var t=arguments,e=t.length-1;return function(){for(var n=e,r=t[e].apply(this,arguments);n--;)r=t[n].call(this,r);return r}},p.after=function(t,e){return function(){return--t<1?e.apply(this,arguments):void 0}},p.before=function(t,e){var n;return function(){return--t>0?n=e.apply(this,arguments):e=null,n}},p.once=p.partial(p.before,2),p.keys=function(t){if(!p.isObject(t))return[];if(h)return h(t);var e=[];for(var n in t)p.has(t,n)&&e.push(n);return e},p.values=function(t){for(var e=p.keys(t),n=e.length,r=Array(n),i=0;n>i;i++)r[i]=t[e[i]];return r},p.pairs=function(t){for(var e=p.keys(t),n=e.length,r=Array(n),i=0;n>i;i++)r[i]=[e[i],t[e[i]]];return r},p.invert=function(t){for(var e={},n=p.keys(t),r=0,i=n.length;i>r;r++)e[t[n[r]]]=n[r];return e},p.functions=p.methods=function(t){var e=[];for(var n in t)p.isFunction(t[n])&&e.push(n);return e.sort()},p.extend=function(t){if(!p.isObject(t))return t;for(var e,n,r=1,i=arguments.length;i>r;r++){e=arguments[r];for(n in e)u.call(e,n)&&(t[n]=e[n])}return t},p.pick=function(t,e,n){var r,i={};if(null==t)return i;if(p.isFunction(e)){e=g(e,n);for(r in t){var a=t[r];e(a,r,t)&&(i[r]=a)}}else{var l=o.apply([],s.call(arguments,1));t=new Object(t);for(var u=0,c=l.length;c>u;u++)r=l[u],r in t&&(i[r]=t[r])}return i},p.omit=function(t,e,n){if(p.isFunction(e))e=p.negate(e);else{var r=p.map(o.apply([],s.call(arguments,1)),String);e=function(t,e){return!p.contains(r,e)}}return p.pick(t,e,n)},p.defaults=function(t){if(!p.isObject(t))return t;for(var e=1,n=arguments.length;n>e;e++){var r=arguments[e];for(var i in r)void 0===t[i]&&(t[i]=r[i])}return t},p.clone=function(t){return p.isObject(t)?p.isArray(t)?t.slice():p.extend({},t):t},p.tap=function(t,e){return e(t),t};var _=function(t,e,n,r){if(t===e)return 0!==t||1/t===1/e;if(null==t||null==e)return t===e;t instanceof p&&(t=t._wrapped),e instanceof p&&(e=e._wrapped);var i=l.call(t);if(i!==l.call(e))return!1;switch(i){case"[object RegExp]":case"[object String]":return""+t==""+e;case"[object Number]":return+t!==+t?+e!==+e:0===+t?1/+t===1/e:+t===+e;case"[object Date]":case"[object Boolean]":return+t===+e}if("object"!=typeof t||"object"!=typeof e)return!1;for(var a=n.length;a--;)if(n[a]===t)return r[a]===e;var s=t.constructor,o=e.constructor;if(s!==o&&"constructor"in t&&"constructor"in e&&!(p.isFunction(s)&&s instanceof s&&p.isFunction(o)&&o instanceof o))return!1;n.push(t),r.push(e);var u,c;if("[object Array]"===i){if(u=t.length,c=u===e.length)for(;u--&&(c=_(t[u],e[u],n,r)););}else{var h,f=p.keys(t);if(u=f.length,c=p.keys(e).length===u)for(;u--&&(h=f[u],c=p.has(e,h)&&_(t[h],e[h],n,r)););}return n.pop(),r.pop(),c};p.isEqual=function(t,e){return _(t,e,[],[])},p.isEmpty=function(t){if(null==t)return!0;if(p.isArray(t)||p.isString(t)||p.isArguments(t))return 0===t.length;for(var e in t)if(p.has(t,e))return!1;return!0},p.isElement=function(t){return!(!t||1!==t.nodeType)},p.isArray=c||function(t){return"[object Array]"===l.call(t)},p.isObject=function(t){var e=typeof t;return"function"===e||"object"===e&&!!t},p.each(["Arguments","Function","String","Number","Date","RegExp"],function(t){p["is"+t]=function(e){return l.call(e)==="[object "+t+"]"}}),p.isArguments(arguments)||(p.isArguments=function(t){return p.has(t,"callee")}),"function"!=typeof/./&&(p.isFunction=function(t){return"function"==typeof t||!1}),p.isFinite=function(t){return isFinite(t)&&!isNaN(parseFloat(t))},p.isNaN=function(t){return p.isNumber(t)&&t!==+t},p.isBoolean=function(t){return t===!0||t===!1||"[object Boolean]"===l.call(t)},p.isNull=function(t){return null===t},p.isUndefined=function(t){return void 0===t},p.has=function(t,e){return null!=t&&u.call(t,e)},p.noConflict=function(){return t._=e,this},p.identity=function(t){return t},p.constant=function(t){return function(){return t}},p.noop=function(){},p.property=function(t){return function(e){return e[t]}},p.matches=function(t){var e=p.pairs(t),n=e.length;return function(t){if(null==t)return!n;t=new Object(t);for(var r=0;n>r;r++){var i=e[r],a=i[0];if(i[1]!==t[a]||!(a in t))return!1}return!0}},p.times=function(t,e,n){var r=Array(Math.max(0,t));e=g(e,n,1);for(var i=0;t>i;i++)r[i]=e(i);return r},p.random=function(t,e){return null==e&&(e=t,t=0),t+Math.floor(Math.random()*(e-t+1))},p.now=Date.now||function(){return(new Date).getTime()};var b={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},w=p.invert(b),k=function(t){var e=function(e){return t[e]},n="(?:"+p.keys(t).join("|")+")",r=RegExp(n),i=RegExp(n,"g");return function(t){return t=null==t?"":""+t,r.test(t)?t.replace(i,e):t}};p.escape=k(b),p.unescape=k(w),p.result=function(t,e){if(null==t)return void 0;var n=t[e];return p.isFunction(n)?t[e]():n};var x=0;p.uniqueId=function(t){var e=++x+"";return t?t+e:e},p.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var E=/(.)^/,A={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},S=/\\|'|\r|\n|\u2028|\u2029/g,j=function(t){return"\\"+A[t]};p.template=function(t,e,n){!e&&n&&(e=n),e=p.defaults({},e,p.templateSettings);var r=RegExp([(e.escape||E).source,(e.interpolate||E).source,(e.evaluate||E).source].join("|")+"|$","g"),i=0,a="__p+='";t.replace(r,function(e,n,r,s,o){return a+=t.slice(i,o).replace(S,j),i=o+e.length,n?a+="'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'":r?a+="'+\n((__t=("+r+"))==null?'':__t)+\n'":s&&(a+="';\n"+s+"\n__p+='"),e}),a+="';\n",e.variable||(a="with(obj||{}){\n"+a+"}\n"),a="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+a+"return __p;\n";try{var s=new Function(e.variable||"obj","_",a)}catch(o){throw o.source=a,o}var l=function(t){return s.call(this,t,p)},u=e.variable||"obj";return l.source="function("+u+"){\n"+a+"}",l},p.chain=function(t){var e=p(t);return e._chain=!0,e};var $=function(t){return this._chain?p(t).chain():t};p.mixin=function(t){p.each(p.functions(t),function(e){var n=p[e]=t[e];p.prototype[e]=function(){var t=[this._wrapped];return a.apply(t,arguments),$.call(this,n.apply(p,t))}})},p.mixin(p),p.each(["pop","push","reverse","shift","sort","splice","unshift"],function(t){var e=n[t];p.prototype[t]=function(){var n=this._wrapped;return e.apply(n,arguments),"shift"!==t&&"splice"!==t||0!==n.length||delete n[0],$.call(this,n)}}),p.each(["concat","join","slice"],function(t){var e=n[t];p.prototype[t]=function(){return $.call(this,e.apply(this._wrapped,arguments))}}),p.prototype.value=function(){return this._wrapped},"function"==typeof define&&define.amd&&define("underscore",[],function(){return p})}.call(this),function(){var t,e=this,n=e.Backbone,r=Array.prototype.slice,i=Array.prototype.splice;t="undefined"!=typeof exports?exports:e.Backbone={},t.VERSION="0.9.2";var a=e._;a||"undefined"==typeof require||(a=require("underscore"));var s=e.jQuery||e.Zepto||e.ender;t.setDomLibrary=function(t){s=t},t.noConflict=function(){return e.Backbone=n,this},t.emulateHTTP=!1,t.emulateJSON=!1;var o=/\s+/,l=t.Events={on:function(t,e,n){var r,i,a,s,l;if(!e)return this;for(t=t.split(o),r=this._callbacks||(this._callbacks={});i=t.shift();)l=r[i],a=l?l.tail:{},a.next=s={},a.context=n,a.callback=e,r[i]={tail:s,next:l?l.next:a};return this},off:function(t,e,n){var r,i,s,l,u,c;if(i=this._callbacks){if(!(t||e||n))return delete this._callbacks,this;for(t=t?t.split(o):a.keys(i);r=t.shift();)if(s=i[r],delete i[r],s&&(e||n))for(l=s.tail;(s=s.next)!==l;)u=s.callback,c=s.context,(e&&u!==e||n&&c!==n)&&this.on(r,u,c);return this}},trigger:function(t){var e,n,i,a,s,l,u;if(!(i=this._callbacks))return this;for(l=i.all,t=t.split(o),u=r.call(arguments,1);e=t.shift();){if(n=i[e])for(a=n.tail;(n=n.next)!==a;)n.callback.apply(n.context||this,u);if(n=l)for(a=n.tail,s=[e].concat(u);(n=n.next)!==a;)n.callback.apply(n.context||this,s)}return this}};l.bind=l.on,l.unbind=l.off;var u=t.Model=function(t,e){var n;t||(t={}),e&&e.parse&&(t=this.parse(t)),(n=S(this,"defaults"))&&(t=a.extend({},n,t)),e&&e.collection&&(this.collection=e.collection),this.attributes={},this._escapedAttributes={},this.cid=a.uniqueId("c"),this.changed={},this._silent={},this._pending={},this.set(t,{silent:!0}),this.changed={},this._silent={},this._pending={},this._previousAttributes=a.clone(this.attributes),this.initialize.apply(this,arguments)};a.extend(u.prototype,l,{changed:null,_silent:null,_pending:null,idAttribute:"id",initialize:function(){},toJSON:function(){return a.clone(this.attributes)},get:function(t){return this.attributes[t]},escape:function(t){var e;if(e=this._escapedAttributes[t])return e;var n=this.get(t);return this._escapedAttributes[t]=a.escape(null==n?"":""+n)},has:function(t){return null!=this.get(t)},set:function(t,e,n){var r,i,s;if(a.isObject(t)||null==t?(r=t,n=e):(r={},r[t]=e),n||(n={}),!r)return this;if(r instanceof u&&(r=r.attributes),n.unset)for(i in r)r[i]=void 0;if(!this._validate(r,n))return!1;this.idAttribute in r&&(this.id=r[this.idAttribute]);var o=n.changes={},l=this.attributes,c=this._escapedAttributes,h=this._previousAttributes||{};for(i in r)s=r[i],(!a.isEqual(l[i],s)||n.unset&&a.has(l,i))&&(delete c[i],(n.silent?this._silent:o)[i]=!0),n.unset?delete l[i]:l[i]=s,a.isEqual(h[i],s)&&a.has(l,i)==a.has(h,i)?(delete this.changed[i],delete this._pending[i]):(this.changed[i]=s,n.silent||(this._pending[i]=!0));return n.silent||this.change(n),this},unset:function(t,e){return(e||(e={})).unset=!0,this.set(t,null,e)},clear:function(t){return(t||(t={})).unset=!0,this.set(a.clone(this.attributes),t)},fetch:function(e){e=e?a.clone(e):{};var n=this,r=e.success;return e.success=function(t,i,a){return n.set(n.parse(t,a),e)?void(r&&r(n,t)):!1},e.error=t.wrapError(e.error,n,e),(this.sync||t.sync).call(this,"read",this,e)},save:function(e,n,r){var i,s;if(a.isObject(e)||null==e?(i=e,r=n):(i={},i[e]=n),r=r?a.clone(r):{},r.wait){if(!this._validate(i,r))return!1;s=a.clone(this.attributes)}var o=a.extend({},r,{silent:!0});if(i&&!this.set(i,r.wait?o:r))return!1;var l=this,u=r.success;r.success=function(t,e,n){var s=l.parse(t,n);return r.wait&&(delete r.wait,s=a.extend(i||{},s)),l.set(s,r)?void(u?u(l,t):l.trigger("sync",l,t,r)):!1},r.error=t.wrapError(r.error,l,r);var c=this.isNew()?"create":"update",h=(this.sync||t.sync).call(this,c,this,r);return r.wait&&this.set(s,o),h},destroy:function(e){e=e?a.clone(e):{};var n=this,r=e.success,i=function(){n.trigger("destroy",n,n.collection,e)};if(this.isNew())return i(),!1;e.success=function(t){e.wait&&i(),r?r(n,t):n.trigger("sync",n,t,e)},e.error=t.wrapError(e.error,n,e);var s=(this.sync||t.sync).call(this,"delete",this,e);return e.wait||i(),s},url:function(){var t=S(this,"urlRoot")||S(this.collection,"url")||j();return this.isNew()?t:t+("/"==t.charAt(t.length-1)?"":"/")+encodeURIComponent(this.id)},parse:function(t){return t},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return null==this.id},change:function(t){t||(t={});var e=this._changing;this._changing=!0;for(var n in this._silent)this._pending[n]=!0;var r=a.extend({},t.changes,this._silent);this._silent={};for(var n in r)this.trigger("change:"+n,this,this.get(n),t);if(e)return this;for(;!a.isEmpty(this._pending);){this._pending={},this.trigger("change",this,t);for(var n in this.changed)this._pending[n]||this._silent[n]||delete this.changed[n];this._previousAttributes=a.clone(this.attributes)}return this._changing=!1,this},hasChanged:function(t){return arguments.length?a.has(this.changed,t):!a.isEmpty(this.changed)},changedAttributes:function(t){if(!t)return this.hasChanged()?a.clone(this.changed):!1;var e,n=!1,r=this._previousAttributes;for(var i in t)a.isEqual(r[i],e=t[i])||((n||(n={}))[i]=e);return n},previous:function(t){return arguments.length&&this._previousAttributes?this._previousAttributes[t]:null},previousAttributes:function(){return a.clone(this._previousAttributes)},isValid:function(){return!this.validate(this.attributes)},_validate:function(t,e){if(e.silent||!this.validate)return!0;t=a.extend({},this.attributes,t);var n=this.validate(t,e);return n?(e&&e.error?e.error(this,n,e):this.trigger("error",this,n,e),!1):!0}});var c=t.Collection=function(t,e){e||(e={}),e.model&&(this.model=e.model),e.comparator&&(this.comparator=e.comparator),this._reset(),this.initialize.apply(this,arguments),t&&this.reset(t,{silent:!0,parse:e.parse})};a.extend(c.prototype,l,{model:u,initialize:function(){},toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},add:function(t,e){var n,r,s,o,l,u,c={},h={},f=[];for(e||(e={}),t=a.isArray(t)?t.slice():[t],n=0,s=t.length;s>n;n++){if(!(o=t[n]=this._prepareModel(t[n],e)))throw new Error("Can't add an invalid model to a collection");l=o.cid,u=o.id,c[l]||this._byCid[l]||null!=u&&(h[u]||this._byId[u])?f.push(n):c[l]=h[u]=o}for(n=f.length;n--;)t.splice(f[n],1);for(n=0,s=t.length;s>n;n++)(o=t[n]).on("all",this._onModelEvent,this),this._byCid[o.cid]=o,null!=o.id&&(this._byId[o.id]=o);if(this.length+=s,r=null!=e.at?e.at:this.models.length,i.apply(this.models,[r,0].concat(t)),this.comparator&&this.sort({silent:!0}),e.silent)return this;for(n=0,s=this.models.length;s>n;n++)c[(o=this.models[n]).cid]&&(e.index=n,o.trigger("add",o,this,e));return this},remove:function(t,e){var n,r,i,s;for(e||(e={}),t=a.isArray(t)?t.slice():[t],n=0,r=t.length;r>n;n++)s=this.getByCid(t[n])||this.get(t[n]),s&&(delete this._byId[s.id],delete this._byCid[s.cid],i=this.indexOf(s),this.models.splice(i,1),this.length--,e.silent||(e.index=i,s.trigger("remove",s,this,e)),this._removeReference(s));return this},push:function(t,e){return t=this._prepareModel(t,e),this.add(t,e),t},pop:function(t){var e=this.at(this.length-1);return this.remove(e,t),e},unshift:function(t,e){return t=this._prepareModel(t,e),this.add(t,a.extend({at:0},e)),t},shift:function(t){var e=this.at(0);return this.remove(e,t),e},get:function(t){return null==t?void 0:this._byId[null!=t.id?t.id:t]},getByCid:function(t){return t&&this._byCid[t.cid||t]},at:function(t){return this.models[t]},where:function(t){return a.isEmpty(t)?[]:this.filter(function(e){for(var n in t)if(t[n]!==e.get(n))return!1;return!0})},sort:function(t){if(t||(t={}),!this.comparator)throw new Error("Cannot sort a set without a comparator");var e=a.bind(this.comparator,this);return 1==this.comparator.length?this.models=this.sortBy(e):this.models.sort(e),t.silent||this.trigger("reset",this,t),this},pluck:function(t){return a.map(this.models,function(e){return e.get(t)})},reset:function(t,e){t||(t=[]),e||(e={});for(var n=0,r=this.models.length;r>n;n++)this._removeReference(this.models[n]);return this._reset(),this.add(t,a.extend({silent:!0},e)),e.silent||this.trigger("reset",this,e),this},fetch:function(e){e=e?a.clone(e):{},void 0===e.parse&&(e.parse=!0);var n=this,r=e.success;return e.success=function(t,i,a){n[e.add?"add":"reset"](n.parse(t,a),e),r&&r(n,t)},e.error=t.wrapError(e.error,n,e),(this.sync||t.sync).call(this,"read",this,e)},create:function(t,e){var n=this;if(e=e?a.clone(e):{},t=this._prepareModel(t,e),!t)return!1;e.wait||n.add(t,e);var r=e.success;return e.success=function(i,a){e.wait&&n.add(i,e),r?r(i,a):i.trigger("sync",t,a,e)},t.save(null,e),t},parse:function(t){return t},chain:function(){return a(this.models).chain()},_reset:function(){this.length=0,this.models=[],this._byId={},this._byCid={}},_prepareModel:function(t,e){if(e||(e={}),t instanceof u)t.collection||(t.collection=this);else{var n=t;e.collection=this,t=new this.model(n,e),t._validate(t.attributes,e)||(t=!1)}return t},_removeReference:function(t){this==t.collection&&delete t.collection,t.off("all",this._onModelEvent,this)},_onModelEvent:function(t,e,n,r){("add"!=t&&"remove"!=t||n==this)&&("destroy"==t&&this.remove(e,r),e&&t==="change:"+e.idAttribute&&(delete this._byId[e.previous(e.idAttribute)],this._byId[e.id]=e),this.trigger.apply(this,arguments))}});var h=["forEach","each","map","reduce","reduceRight","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","sortBy","sortedIndex","toArray","size","first","initial","rest","last","without","indexOf","shuffle","lastIndexOf","isEmpty","groupBy"];a.each(h,function(t){c.prototype[t]=function(){return a[t].apply(a,[this.models].concat(a.toArray(arguments)))}});var f=t.Router=function(t){t||(t={}),t.routes&&(this.routes=t.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},p=/:\w+/g,g=/\*\w+/g,d=/[-[\]{}()+?.,\\^$|#\s]/g;a.extend(f.prototype,l,{initialize:function(){},route:function(e,n,r){return t.history||(t.history=new v),a.isRegExp(e)||(e=this._routeToRegExp(e)),r||(r=this[n]),t.history.route(e,a.bind(function(i){var a=this._extractParameters(e,i);r&&r.apply(this,a),this.trigger.apply(this,["route:"+n].concat(a)),t.history.trigger("route",this,n,a)},this)),this},navigate:function(e,n){t.history.navigate(e,n)},_bindRoutes:function(){if(this.routes){var t=[];for(var e in this.routes)t.unshift([e,this.routes[e]]);for(var n=0,r=t.length;r>n;n++)this.route(t[n][0],t[n][1],this[t[n][1]])}},_routeToRegExp:function(t){return t=t.replace(d,"\\$&").replace(p,"([^/]+)").replace(g,"(.*?)"),new RegExp("^"+t+"$")},_extractParameters:function(t,e){return t.exec(e).slice(1)}});var v=t.History=function(){this.handlers=[],a.bindAll(this,"checkUrl")},m=/^[#\/]/,y=/msie [\w.]+/;v.started=!1,a.extend(v.prototype,l,{interval:50,getHash:function(t){var e=t?t.location:window.location,n=e.href.match(/#(.*)$/);return n?n[1]:""},getFragment:function(t,e){if(null==t)if(this._hasPushState||e){t=window.location.pathname;var n=window.location.search;n&&(t+=n)}else t=this.getHash();return t.indexOf(this.options.root)||(t=t.substr(this.options.root.length)),t.replace(m,"")},start:function(t){if(v.started)throw new Error("Backbone.history has already been started");v.started=!0,this.options=a.extend({},{root:"/"},this.options,t),this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&window.history&&window.history.pushState);var e=this.getFragment(),n=document.documentMode,r=y.exec(navigator.userAgent.toLowerCase())&&(!n||7>=n);r&&(this.iframe=s('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(e)),this._hasPushState?s(window).bind("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!r?s(window).bind("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=e;var i=window.location,o=i.pathname==this.options.root;return this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!o?(this.fragment=this.getFragment(null,!0),window.location.replace(this.options.root+"#"+this.fragment),!0):(this._wantsPushState&&this._hasPushState&&o&&i.hash&&(this.fragment=this.getHash().replace(m,""),window.history.replaceState({},document.title,i.protocol+"//"+i.host+this.options.root+this.fragment)),this.options.silent?void 0:this.loadUrl())},stop:function(){s(window).unbind("popstate",this.checkUrl).unbind("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),v.started=!1},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(){var t=this.getFragment();return t==this.fragment&&this.iframe&&(t=this.getFragment(this.getHash(this.iframe))),t==this.fragment?!1:(this.iframe&&this.navigate(t),void(this.loadUrl()||this.loadUrl(this.getHash())))},loadUrl:function(t){var e=this.fragment=this.getFragment(t),n=a.any(this.handlers,function(t){return t.route.test(e)?(t.callback(e),!0):void 0});return n},navigate:function(t,e){if(!v.started)return!1;e&&e!==!0||(e={trigger:e});var n=(t||"").replace(m,"");this.fragment!=n&&(this._hasPushState?(0!=n.indexOf(this.options.root)&&(n=this.options.root+n),this.fragment=n,window.history[e.replace?"replaceState":"pushState"]({},document.title,n)):this._wantsHashChange?(this.fragment=n,this._updateHash(window.location,n,e.replace),this.iframe&&n!=this.getFragment(this.getHash(this.iframe))&&(e.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,n,e.replace))):window.location.assign(this.options.root+t),e.trigger&&this.loadUrl(t))},_updateHash:function(t,e,n){n?t.replace(t.toString().replace(/(javascript:|#).*$/,"")+"#"+e):t.hash=e}});var _=t.View=function(t){this.cid=a.uniqueId("view"),this._configure(t||{}),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},b=/^(\S+)\s*(.*)$/,w=["model","collection","el","id","attributes","className","tagName"];a.extend(_.prototype,l,{tagName:"div",$:function(t){return this.$el.find(t)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this},make:function(t,e,n){var r=document.createElement(t);return e&&s(r).attr(e),n&&s(r).html(n),r},setElement:function(t,e){return this.$el&&this.undelegateEvents(),this.$el=t instanceof s?t:s(t),this.el=this.$el[0],e!==!1&&this.delegateEvents(),this},delegateEvents:function(t){if(t||(t=S(this,"events"))){this.undelegateEvents();for(var e in t){var n=t[e];if(a.isFunction(n)||(n=this[t[e]]),!n)throw new Error('Method "'+t[e]+'" does not exist');var r=e.match(b),i=r[1],s=r[2];n=a.bind(n,this),i+=".delegateEvents"+this.cid,""===s?this.$el.bind(i,n):this.$el.delegate(s,i,n)}}},undelegateEvents:function(){this.$el.unbind(".delegateEvents"+this.cid)},_configure:function(t){this.options&&(t=a.extend({},this.options,t));for(var e=0,n=w.length;n>e;e++){var r=w[e];t[r]&&(this[r]=t[r])}this.options=t},_ensureElement:function(){if(this.el)this.setElement(this.el,!1);else{var t=S(this,"attributes")||{};this.id&&(t.id=this.id),this.className&&(t["class"]=this.className),this.setElement(this.make(this.tagName,t),!1)}}});var k=function(t,e){var n=A(this,t,e);return n.extend=this.extend,n};u.extend=c.extend=f.extend=_.extend=k;var x={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};t.sync=function(e,n,r){var i=x[e];r||(r={});var o={type:i,dataType:"json"};return r.url||(o.url=S(n,"url")||j()),r.data||!n||"create"!=e&&"update"!=e||(o.contentType="application/json",o.data=JSON.stringify(n.toJSON())),t.emulateJSON&&(o.contentType="application/x-www-form-urlencoded",o.data=o.data?{model:o.data}:{}),t.emulateHTTP&&("PUT"===i||"DELETE"===i)&&(t.emulateJSON&&(o.data._method=i),o.type="POST",o.beforeSend=function(t){t.setRequestHeader("X-HTTP-Method-Override",i)}),"GET"===o.type||t.emulateJSON||(o.processData=!1),s.ajax(a.extend(o,r))},t.wrapError=function(t,e,n){return function(r,i){i=r===e?i:r,t?t(e,i,n):e.trigger("error",e,i,n)}};var E=function(){},A=function(t,e,n){var r;return r=e&&e.hasOwnProperty("constructor")?e.constructor:function(){t.apply(this,arguments)},a.extend(r,t),E.prototype=t.prototype,r.prototype=new E,e&&a.extend(r.prototype,e),n&&a.extend(r,n),r.prototype.constructor=r,r.__super__=t.prototype,r},S=function(t,e){return t&&t[e]?a.isFunction(t[e])?t[e]():t[e]:null},j=function(){throw new Error('A "url" property or function must be specified')}}.call(this),"object"!=typeof he&&"function"==typeof require)var he=require("he");var toMarkdown=function(t){function e(t,e){var n="void"===e.type?"<"+e.tag+"\\b([^>]*)\\/?>":"<"+e.tag+"\\b([^>]*)>([\\s\\S]*?)<\\/"+e.tag+">",r=new RegExp(n,"gi"),i="";return i="string"==typeof e.replacement?t.replace(r,e.replacement):t.replace(r,function(t,n,r,i){return e.replacement.call(this,t,n,r,i)
})}function n(t){return new RegExp(t+"\\s*=\\s*[\"']?([^\"']*)[\"']?","i")}function r(t){return t=t.replace(/<(ul|ol)\b[^>]*>([\s\S]*?)<\/\1>/gi,function(t,e,n){var r=n.split("</li>");for(r.splice(r.length-1,1),o=0,l=r.length;l>o;o++)if(r[o]){var i="ol"===e?o+1+".  ":"*   ";r[o]=r[o].replace(/\s*<li[^>]*>([\s\S]*)/i,function(t,e){return e=e.replace(/^\s+/,""),e=e.replace(/\n\n/g,"\n\n    "),e=e.replace(/\n([ ]*)+(\*|\d+\.) /g,"\n$1    $2 "),i+e})}return r.join("\n")}),"\n\n"+t.replace(/[ \t]+\n|\s+$/g,"")}function i(t){return t=t.replace(/<blockquote\b[^>]*>([\s\S]*?)<\/blockquote>/gi,function(t,e){return e=e.replace(/^\s+|\s+$/g,""),e=a(e),e=e.replace(/^/gm,"> "),e=e.replace(/^(>([ \t]{2,}>)+)/gm,"> >")})}function a(t){return t=t.replace(/^[\t\r\n]+|[\t\r\n]+$/g,""),t=t.replace(/\n\s+\n/g,"\n\n"),t=t.replace(/\n{3,}/g,"\n\n")}for(var s=[{patterns:"p",replacement:function(t,e,n){return n?"\n\n"+n+"\n":""}},{patterns:"br",type:"void",replacement:"\n"},{patterns:"h([1-6])",replacement:function(t,e,n,r){for(var i="",a=0;e>a;a++)i+="#";return"\n\n"+i+" "+r+"\n"}},{patterns:"hr",type:"void",replacement:"\n\n* * *\n"},{patterns:"a",replacement:function(t,e,r){var i=e.match(n("href")),a=e.match(n("title"));return i?"["+r+"]("+i[1]+(a&&a[1]?' "'+a[1]+'"':"")+")":t}},{patterns:["b","strong"],replacement:function(t,e,n){return n?"**"+n+"**":""}},{patterns:["i","em"],replacement:function(t,e,n){return n?"_"+n+"_":""}},{patterns:"code",replacement:function(t,e,n){return n?"`"+he.decode(n)+"`":""}},{patterns:"img",type:"void",replacement:function(t,e){var r=e.match(n("src")),i=e.match(n("alt")),a=e.match(n("title"));return"!["+(i&&i[1]?i[1]:"")+"]("+r[1]+(a&&a[1]?' "'+a[1]+'"':"")+")"}}],o=0,l=s.length;l>o;o++)if("string"==typeof s[o].patterns)t=e(t,{tag:s[o].patterns,replacement:s[o].replacement,type:s[o].type});else for(var u=0,c=s[o].patterns.length;c>u;u++)t=e(t,{tag:s[o].patterns[u],replacement:s[o].replacement,type:s[o].type});t=t.replace(/<pre\b[^>]*>`([\s\S]*?)`<\/pre>/gi,function(t,e){var n=he.decode(e);return n=n.replace(/^\t+/g,"  "),n=n.replace(/\n/g,"\n    "),"\n\n    "+n+"\n"}),t=t.replace(/^(\s{0,3}\d+)\. /g,"$1\\. ");for(var h=/<(ul|ol)\b[^>]*>(?:(?!<ul|<ol)[\s\S])*?<\/\1>/gi;t.match(h);)t=t.replace(h,function(t){return r(t)});for(var f=/<blockquote\b[^>]*>((?:(?!<blockquote)[\s\S])*?)<\/blockquote>/gi;t.match(f);)t=t.replace(f,function(t){return i(t)});return a(t)};"object"==typeof exports&&(exports.toMarkdown=toMarkdown),!function(t){function e(){return"Markdown.mk_block( "+uneval(this.toString())+", "+uneval(this.trailing)+", "+uneval(this.lineNumber)+" )"}function n(){var t=require("util");return"Markdown.mk_block( "+t.inspect(this.toString())+", "+t.inspect(this.trailing)+", "+t.inspect(this.lineNumber)+" )"}function r(t){for(var e=0,n=-1;-1!==(n=t.indexOf("\n",n+1));)e++;return e}function i(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function a(t){if("string"==typeof t)return i(t);var e=t.shift(),n={},r=[];for(!t.length||"object"!=typeof t[0]||t[0]instanceof Array||(n=t.shift());t.length;)r.push(a(t.shift()));var s="";for(var o in n)s+=" "+o+'="'+i(n[o])+'"';return"img"===e||"br"===e||"hr"===e?"<"+e+s+"/>":"<"+e+s+">"+r.join("")+"</"+e+">"}function s(t,e,n){var r;n=n||{};var i=t.slice(0);"function"==typeof n.preprocessTreeNode&&(i=n.preprocessTreeNode(i,e));var a=g(i);if(a){i[1]={};for(r in a)i[1][r]=a[r];a=i[1]}if("string"==typeof i)return i;switch(i[0]){case"header":i[0]="h"+i[1].level,delete i[1].level;break;case"bulletlist":i[0]="ul";break;case"numberlist":i[0]="ol";break;case"listitem":i[0]="li";break;case"para":i[0]="p";break;case"markdown":i[0]="html",a&&delete a.references;break;case"code_block":i[0]="pre",r=a?2:1;var o=["code"];o.push.apply(o,i.splice(r,i.length-r)),i[r]=o;break;case"inlinecode":i[0]="code";break;case"img":i[1].src=i[1].href,delete i[1].href;break;case"linebreak":i[0]="br";break;case"link":i[0]="a";break;case"link_ref":i[0]="a";var l=e[a.ref];if(!l)return a.original;delete a.ref,a.href=l.href,l.title&&(a.title=l.title),delete a.original;break;case"img_ref":i[0]="img";var l=e[a.ref];if(!l)return a.original;delete a.ref,a.src=l.href,l.title&&(a.title=l.title),delete a.original}if(r=1,a){for(var u in i[1]){r=2;break}1===r&&i.splice(r,1)}for(;r<i.length;++r)i[r]=s(i[r],e,n);return i}function o(t){for(var e=g(t)?2:1;e<t.length;)"string"==typeof t[e]?e+1<t.length&&"string"==typeof t[e+1]?t[e]+=t.splice(e+1,1)[0]:++e:(o(t[e]),++e)}function l(t,e){function n(t){this.len_after=t,this.name="close_"+e}var r=t+"_state",i="strong"===t?"em_state":"strong_state";return function(a){if(this[r][0]===e)return this[r].shift(),[a.length,new n(a.length-e.length)];var s=this[i].slice(),o=this[r].slice();this[r].unshift(e);var l=this.processInline(a.substr(e.length)),u=l[l.length-1];if(this[r].shift(),u instanceof n){l.pop();var c=a.length-u.len_after;return[c,[t].concat(l)]}return this[i]=s,this[r]=o,[e.length,e]}}function u(t){for(var e=t.split(""),n=[""],r=!1;e.length;){var i=e.shift();switch(i){case" ":r?n[n.length-1]+=i:n.push("");break;case"'":case'"':r=!r;break;case"\\":i=e.shift();default:n[n.length-1]+=i}}return n}var c={};c.mk_block=function(t,r,i){1===arguments.length&&(r="\n\n");var a=new String(t);return a.trailing=r,a.inspect=n,a.toSource=e,void 0!==i&&(a.lineNumber=i),a};var h=c.isArray=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)};c.forEach=Array.prototype.forEach?function(t,e,n){return t.forEach(e,n)}:function(t,e,n){for(var r=0;r<t.length;r++)e.call(n||t,t[r],r,t)},c.isEmpty=function(t){for(var e in t)if(hasOwnProperty.call(t,e))return!1;return!0},c.extract_attr=function(t){return h(t)&&t.length>1&&"object"==typeof t[1]&&!h(t[1])?t[1]:void 0};var f=function(t){switch(typeof t){case"undefined":this.dialect=f.dialects.Gruber;break;case"object":this.dialect=t;break;default:if(!(t in f.dialects))throw new Error("Unknown Markdown dialect '"+String(t)+"'");this.dialect=f.dialects[t]}this.em_state=[],this.strong_state=[],this.debug_indent=""};f.dialects={};var p=f.mk_block=c.mk_block,h=c.isArray;f.parse=function(t,e){var n=new f(e);return n.toTree(t)},f.prototype.split_blocks=function(t){t=t.replace(/(\r\n|\n|\r)/g,"\n");var e,n=/([\s\S]+?)($|\n#|\n(?:\s*\n|$)+)/g,i=[],a=1;for(null!==(e=/^(\s*\n)/.exec(t))&&(a+=r(e[0]),n.lastIndex=e[0].length);null!==(e=n.exec(t));)"\n#"===e[2]&&(e[2]="\n",n.lastIndex--),i.push(p(e[1],e[2],a)),a+=r(e[0]);return i},f.prototype.processBlock=function(t,e){var n=this.dialect.block,r=n.__order__;if("__call__"in n)return n.__call__.call(this,t,e);for(var i=0;i<r.length;i++){var a=n[r[i]].call(this,t,e);if(a)return(!h(a)||a.length>0&&!h(a[0]))&&this.debug(r[i],"didn't return a proper array"),a}return[]},f.prototype.processInline=function(t){return this.dialect.inline.__call__.call(this,String(t))},f.prototype.toTree=function(t,e){var n=t instanceof Array?t:this.split_blocks(t),r=this.tree;try{for(this.tree=e||this.tree||["markdown"];n.length;){var i=this.processBlock(n.shift(),n);i.length&&this.tree.push.apply(this.tree,i)}return this.tree}finally{e&&(this.tree=r)}},f.prototype.debug=function(){var t=Array.prototype.slice.call(arguments);t.unshift(this.debug_indent),"undefined"!=typeof print&&print.apply(print,t),"undefined"!=typeof console&&"undefined"!=typeof console.log&&console.log.apply(null,t)},f.prototype.loop_re_over_block=function(t,e,n){for(var r,i=e.valueOf();i.length&&null!==(r=t.exec(i));)i=i.substr(r[0].length),n.call(this,r);return i},f.buildBlockOrder=function(t){var e=[];for(var n in t)"__order__"!==n&&"__call__"!==n&&e.push(n);t.__order__=e},f.buildInlinePatterns=function(t){var e=[];for(var n in t)if(!n.match(/^__.*__$/)){var r=n.replace(/([\\.*+?|()\[\]{}])/g,"\\$1").replace(/\n/,"\\n");e.push(1===n.length?r:"(?:"+r+")")}e=e.join("|"),t.__patterns__=e;var i=t.__call__;t.__call__=function(t,n){return void 0!==n?i.call(this,t,n):i.call(this,t,e)}};var g=c.extract_attr;f.renderJsonML=function(t,e){e=e||{},e.root=e.root||!1;var n=[];if(e.root)n.push(a(t));else for(t.shift(),!t.length||"object"!=typeof t[0]||t[0]instanceof Array||t.shift();t.length;)n.push(a(t.shift()));return n.join("\n\n")},f.toHTMLTree=function(t,e,n){"string"==typeof t&&(t=this.parse(t,e));var r=g(t),i={};r&&r.references&&(i=r.references);var a=s(t,i,n);return o(a),a},f.toHTML=function(t,e,n){var r=this.toHTMLTree(t,e,n);return this.renderJsonML(r)};var d={};d.inline_until_char=function(t,e){for(var n=0,r=[];;){if(t.charAt(n)===e)return n++,[n,r];if(n>=t.length)return null;var i=this.dialect.inline.__oneElement__.call(this,t.substr(n));n+=i[0],r.push.apply(r,i.slice(1))}},d.subclassDialect=function(t){function e(){}function n(){}return e.prototype=t.block,n.prototype=t.inline,{block:new e,inline:new n}};var v=c.forEach,g=c.extract_attr,p=c.mk_block,m=c.isEmpty,y=d.inline_until_char,_={block:{atxHeader:function(t,e){var n=t.match(/^(#{1,6})\s*(.*?)\s*#*\s*(?:\n|$)/);if(!n)return void 0;var r=["header",{level:n[1].length}];return Array.prototype.push.apply(r,this.processInline(n[2])),n[0].length<t.length&&e.unshift(p(t.substr(n[0].length),t.trailing,t.lineNumber+2)),[r]},setextHeader:function(t,e){var n=t.match(/^(.*)\n([-=])\2\2+(?:\n|$)/);if(!n)return void 0;var r="="===n[2]?1:2,i=["header",{level:r},n[1]];return n[0].length<t.length&&e.unshift(p(t.substr(n[0].length),t.trailing,t.lineNumber+2)),[i]},code:function(t,e){var n=[],r=/^(?: {0,3}\t| {4})(.*)\n?/;if(!t.match(r))return void 0;t:for(;;){var i=this.loop_re_over_block(r,t.valueOf(),function(t){n.push(t[1])});if(i.length){e.unshift(p(i,t.trailing));break t}if(!e.length)break t;if(!e[0].match(r))break t;n.push(t.trailing.replace(/[^\n]/g,"").substring(2)),t=e.shift()}return[["code_block",n.join("\n")]]},horizRule:function(t,e){var n=t.match(/^(?:([\s\S]*?)\n)?[ \t]*([-_*])(?:[ \t]*\2){2,}[ \t]*(?:\n([\s\S]*))?$/);if(!n)return void 0;var r=[["hr"]];if(n[1]){var i=p(n[1],"",t.lineNumber);r.unshift.apply(r,this.toTree(i,[]))}return n[3]&&e.unshift(p(n[3],t.trailing,t.lineNumber+1)),r},lists:function(){function t(t){return new RegExp("(?:^("+l+"{0,"+t+"} {0,3})("+a+")\\s+)|(^"+l+"{0,"+(t-1)+"}[ ]{0,4})")}function e(t){return t.replace(/ {0,3}\t/g,"    ")}function n(t,e,n,r){if(e)return void t.push(["para"].concat(n));var i=t[t.length-1]instanceof Array&&"para"===t[t.length-1][0]?t[t.length-1]:t;r&&t.length>1&&n.unshift(r);for(var a=0;a<n.length;a++){var s=n[a],o="string"==typeof s;o&&i.length>1&&"string"==typeof i[i.length-1]?i[i.length-1]+=s:i.push(s)}}function r(t,e){for(var n=new RegExp("^("+l+"{"+t+"}.*?\\n?)*$"),r=new RegExp("^"+l+"{"+t+"}","gm"),i=[];e.length>0&&n.exec(e[0]);){var a=e.shift(),s=a.replace(r,"");i.push(p(s,a.trailing,a.lineNumber))}return i}function i(t,e,n){var r=t.list,i=r[r.length-1];if(!(i[1]instanceof Array&&"para"===i[1][0]))if(e+1===n.length)i.push(["para"].concat(i.splice(1,i.length-1)));else{var a=i.pop();i.push(["para"].concat(i.splice(1,i.length-1)),a)}}var a="[*+-]|\\d+\\.",s=/[*+-]/,o=new RegExp("^( {0,3})("+a+")[ 	]+"),l="(?: {0,3}\\t| {4})";return function(a,l){function u(t){var e=s.exec(t[2])?["bulletlist"]:["numberlist"];return p.push({list:e,indent:t[1]}),e}var c=a.match(o);if(!c)return void 0;for(var h,f,p=[],g=u(c),d=!1,m=[p[0].list];;){for(var y=a.split(/(?=\n)/),_="",b="",w=0;w<y.length;w++){b="";var k=y[w].replace(/^\n/,function(t){return b=t,""}),x=t(p.length);if(c=k.match(x),void 0!==c[1]){_.length&&(n(h,d,this.processInline(_),b),d=!1,_=""),c[1]=e(c[1]);var E=Math.floor(c[1].length/4)+1;if(E>p.length)g=u(c),h.push(g),h=g[1]=["listitem"];else{var A=!1;for(f=0;f<p.length;f++)if(p[f].indent===c[1]){g=p[f].list,p.splice(f+1,p.length-(f+1)),A=!0;break}A||(E++,E<=p.length?(p.splice(E,p.length-E),g=p[E-1].list):(g=u(c),h.push(g))),h=["listitem"],g.push(h)}b=""}k.length>c[0].length&&(_+=b+k.substr(c[0].length))}_.length&&(n(h,d,this.processInline(_),b),d=!1,_="");var S=r(p.length,l);S.length>0&&(v(p,i,this),h.push.apply(h,this.toTree(S,[])));var j=l[0]&&l[0].valueOf()||"";if(!j.match(o)&&!j.match(/^ /))break;a=l.shift();var $=this.dialect.block.horizRule(a,l);if($){m.push.apply(m,$);break}v(p,i,this),d=!0}return m}}(),blockquote:function(t,e){if(!t.match(/^>/m))return void 0;var n=[];if(">"!==t[0]){for(var r=t.split(/\n/),i=[],a=t.lineNumber;r.length&&">"!==r[0][0];)i.push(r.shift()),a++;var s=p(i.join("\n"),"\n",t.lineNumber);n.push.apply(n,this.processBlock(s,[])),t=p(r.join("\n"),t.trailing,a)}for(;e.length&&">"===e[0][0];){var o=e.shift();t=p(t+t.trailing+o,o.trailing,t.lineNumber)}var l=t.replace(/^> ?/gm,""),u=(this.tree,this.toTree(l,["blockquote"])),c=g(u);return c&&c.references&&(delete c.references,m(c)&&u.splice(1,1)),n.push(u),n},referenceDefn:function(t,e){var n=/^\s*\[(.*?)\]:\s*(\S+)(?:\s+(?:(['"])(.*?)\3|\((.*?)\)))?\n?/;if(!t.match(n))return void 0;g(this.tree)||this.tree.splice(1,0,{});var r=g(this.tree);void 0===r.references&&(r.references={});var i=this.loop_re_over_block(n,t,function(t){t[2]&&"<"===t[2][0]&&">"===t[2][t[2].length-1]&&(t[2]=t[2].substring(1,t[2].length-1));var e=r.references[t[1].toLowerCase()]={href:t[2]};void 0!==t[4]?e.title=t[4]:void 0!==t[5]&&(e.title=t[5])});return i.length&&e.unshift(p(i,t.trailing)),[]},para:function(t){return[["para"].concat(this.processInline(t))]}},inline:{__oneElement__:function(t,e,n){var r,i;e=e||this.dialect.inline.__patterns__;var a=new RegExp("([\\s\\S]*?)("+(e.source||e)+")");if(r=a.exec(t),!r)return[t.length,t];if(r[1])return[r[1].length,r[1]];var i;return r[2]in this.dialect.inline&&(i=this.dialect.inline[r[2]].call(this,t.substr(r.index),r,n||[])),i=i||[r[2].length,r[2]]},__call__:function(t,e){function n(t){"string"==typeof t&&"string"==typeof i[i.length-1]?i[i.length-1]+=t:i.push(t)}for(var r,i=[];t.length>0;)r=this.dialect.inline.__oneElement__.call(this,t,e,i),t=t.substr(r.shift()),v(r,n);return i},"]":function(){},"}":function(){},__escape__:/^\\[\\`\*_{}\[\]()#\+.!\-]/,"\\":function(t){return this.dialect.inline.__escape__.exec(t)?[2,t.charAt(1)]:[1,"\\"]},"![":function(t){var e=t.match(/^!\[(.*?)\][ \t]*\([ \t]*([^")]*?)(?:[ \t]+(["'])(.*?)\3)?[ \t]*\)/);if(e){e[2]&&"<"===e[2][0]&&">"===e[2][e[2].length-1]&&(e[2]=e[2].substring(1,e[2].length-1)),e[2]=this.dialect.inline.__call__.call(this,e[2],/\\/)[0];var n={alt:e[1],href:e[2]||""};return void 0!==e[4]&&(n.title=e[4]),[e[0].length,["img",n]]}return e=t.match(/^!\[(.*?)\][ \t]*\[(.*?)\]/),e?[e[0].length,["img_ref",{alt:e[1],ref:e[2].toLowerCase(),original:e[0]}]]:[2,"!["]},"[":function w(t){var e=String(t),n=y.call(this,t.substr(1),"]");if(!n)return[1,"["];var w,r,i=1+n[0],a=n[1];t=t.substr(i);var s=t.match(/^\s*\([ \t]*([^"']*)(?:[ \t]+(["'])(.*?)\2)?[ \t]*\)/);if(s){var o=s[1];if(i+=s[0].length,o&&"<"===o[0]&&">"===o[o.length-1]&&(o=o.substring(1,o.length-1)),!s[3])for(var l=1,u=0;u<o.length;u++)switch(o[u]){case"(":l++;break;case")":0===--l&&(i-=o.length-u,o=o.substring(0,u))}return o=this.dialect.inline.__call__.call(this,o,/\\/)[0],r={href:o||""},void 0!==s[3]&&(r.title=s[3]),w=["link",r].concat(a),[i,w]}return s=t.match(/^\s*\[(.*?)\]/),s?(i+=s[0].length,r={ref:(s[1]||String(a)).toLowerCase(),original:e.substr(0,i)},w=["link_ref",r].concat(a),[i,w]):1===a.length&&"string"==typeof a[0]?(r={ref:a[0].toLowerCase(),original:e.substr(0,i)},w=["link_ref",r,a[0]],[i,w]):[1,"["]},"<":function(t){var e;return null!==(e=t.match(/^<(?:((https?|ftp|mailto):[^>]+)|(.*?@.*?\.[a-zA-Z]+))>/))?e[3]?[e[0].length,["link",{href:"mailto:"+e[3]},e[3]]]:"mailto"===e[2]?[e[0].length,["link",{href:e[1]},e[1].substr("mailto:".length)]]:[e[0].length,["link",{href:e[1]},e[1]]]:[1,"<"]},"`":function(t){var e=t.match(/(`+)(([\s\S]*?)\1)/);return e&&e[2]?[e[1].length+e[2].length,["inlinecode",e[3]]]:[1,"`"]},"  \n":function(){return[3,["linebreak"]]}}};_.inline["**"]=l("strong","**"),_.inline.__=l("strong","__"),_.inline["*"]=l("em","*"),_.inline._=l("em","_"),f.dialects.Gruber=_,f.buildBlockOrder(f.dialects.Gruber.block),f.buildInlinePatterns(f.dialects.Gruber.inline);var b=d.subclassDialect(_),g=c.extract_attr,v=c.forEach;b.processMetaHash=function(t){for(var e=u(t),n={},r=0;r<e.length;++r)if(/^#/.test(e[r]))n.id=e[r].substring(1);else if(/^\./.test(e[r]))n["class"]=n["class"]?n["class"]+e[r].replace(/./," "):e[r].substring(1);else if(/\=/.test(e[r])){var i=e[r].split(/\=/);n[i[0]]=i[1]}return n},b.block.document_meta=function(t){if(t.lineNumber>1)return void 0;if(!t.match(/^(?:\w+:.*\n)*\w+:.*$/))return void 0;g(this.tree)||this.tree.splice(1,0,{});var e=t.split(/\n/);for(var n in e){var r=e[n].match(/(\w+):\s*(.*)$/),i=r[1].toLowerCase(),a=r[2];this.tree[1][i]=a}return[]},b.block.block_meta=function(t){var e=t.match(/(^|\n) {0,3}\{:\s*((?:\\\}|[^\}])*)\s*\}$/);if(!e)return void 0;var n,r=this.dialect.processMetaHash(e[2]);if(""===e[1]){var i=this.tree[this.tree.length-1];if(n=g(i),"string"==typeof i)return void 0;n||(n={},i.splice(1,0,n));for(var a in r)n[a]=r[a];return[]}var s=t.replace(/\n.*$/,""),o=this.processBlock(s,[]);n=g(o[0]),n||(n={},o[0].splice(1,0,n));for(var a in r)n[a]=r[a];return o},b.block.definition_list=function(t,e){var n,r,i=/^((?:[^\s:].*\n)+):\s+([\s\S]+)$/,a=["dl"];if(!(r=t.match(i)))return void 0;for(var s=[t];e.length&&i.exec(e[0]);)s.push(e.shift());for(var o=0;o<s.length;++o){var r=s[o].match(i),l=r[1].replace(/\n$/,"").split(/\n/),u=r[2].split(/\n:\s+/);for(n=0;n<l.length;++n)a.push(["dt",l[n]]);for(n=0;n<u.length;++n)a.push(["dd"].concat(this.processInline(u[n].replace(/(\n)\s+/,"$1"))))}return[a]},b.block.table=function k(t){var e,n,r=function(t,e){e=e||"\\s",e.match(/^[\\|\[\]{}?*.+^$]$/)&&(e="\\"+e);for(var n,r=[],i=new RegExp("^((?:\\\\.|[^\\\\"+e+"])*)"+e+"(.*)");n=t.match(i);)r.push(n[1]),t=n[2];return r.push(t),r},i=/^ {0,3}\|(.+)\n {0,3}\|\s*([\-:]+[\-| :]*)\n((?:\s*\|.*(?:\n|$))*)(?=\n|$)/,a=/^ {0,3}(\S(?:\\.|[^\\|])*\|.*)\n {0,3}([\-:]+\s*\|[\-| :]*)\n((?:(?:\\.|[^\\|])*\|.*(?:\n|$))*)(?=\n|$)/;if(n=t.match(i))n[3]=n[3].replace(/^\s*\|/gm,"");else if(!(n=t.match(a)))return void 0;var k=["table",["thead",["tr"]],["tbody"]];n[2]=n[2].replace(/\|\s*$/,"").split("|");var s=[];for(v(n[2],function(t){s.push(t.match(/^\s*-+:\s*$/)?{align:"right"}:t.match(/^\s*:-+\s*$/)?{align:"left"}:t.match(/^\s*:-+:\s*$/)?{align:"center"}:{})}),n[1]=r(n[1].replace(/\|\s*$/,""),"|"),e=0;e<n[1].length;e++)k[1][1].push(["th",s[e]||{}].concat(this.processInline(n[1][e].trim())));return v(n[3].replace(/\|\s*$/gm,"").split("\n"),function(t){var n=["tr"];for(t=r(t,"|"),e=0;e<t.length;e++)n.push(["td",s[e]||{}].concat(this.processInline(t[e].trim())));k[2].push(n)},this),[k]},b.inline["{:"]=function(t,e,n){if(!n.length)return[2,"{:"];var r=n[n.length-1];if("string"==typeof r)return[2,"{:"];var i=t.match(/^\{:\s*((?:\\\}|[^\}])*)\s*\}/);if(!i)return[2,"{:"];var a=this.dialect.processMetaHash(i[1]),s=g(r);s||(s={},r.splice(1,0,s));for(var o in a)s[o]=a[o];return[i[0].length,""]},f.dialects.Maruku=b,f.dialects.Maruku.inline.__escape__=/^\\[\\`\*_{}\[\]()#\+.!\-|:]/,f.buildBlockOrder(f.dialects.Maruku.block),f.buildInlinePatterns(f.dialects.Maruku.inline),t.Markdown=f,t.parse=f.parse,t.toHTML=f.toHTML,t.toHTMLTree=f.toHTMLTree,t.renderJsonML=f.renderJsonML}(function(){return window.markdown={},window.markdown}());
!function(e,i){var a,n=this;a=n.Villain={},a.EventBus=a.EventBus||i.extend({},Backbone.Events),a.Blocks=a.Blocks||{},a.Editor=a.Editor||{},a.options=a.options||[],a.defaults={browseURL:"browse/",textArea:"#textarea",uploadURL:"/upload/post"};var o=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/;i.mixin({isURI:function(t){return o.test(t)},titleize:function(t){return null===t?"":(t=String(t).toLowerCase(),t.replace(/(?:^|\s|-)\S/g,function(t){return t.toUpperCase()}))},classify:function(t){return i.titleize(String(t).replace(/[\W_]/g," ")).replace(/\s/g,"")},classifyList:function(t){return i.map(t,function(t){return i.classify(t)})},capitalize:function(t){return t.charAt(0).toUpperCase()+t.substring(1).toLowerCase()},underscored:function(t){return i.trim(t).replace(/([a-z\d])([A-Z]+)/g,"$1_$2").replace(/[-\s]+/g,"_").toLowerCase()},trim:function(t){return t.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},reverse:function(t){return t.split("").reverse().join("")},flattern:function(t){var e={};return i.each(t,function(a,n){e[i.isArray(t)?a:n]=!0}),e},to_slug:function(t){return t.toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"-")}}),e.fn.visible=function(){return this.css("visibility","visible")},e.fn.invisible=function(){return this.css("visibility","hidden")},e.fn.visibilityToggle=function(){return this.css("visibility",function(t,e){return"visible"==e?"hidden":"visible"})},e.fn.caretToEnd=function(){var t,e;return t=document.createRange(),t.selectNodeContents(this[0]),t.collapse(!1),e=window.getSelection(),e.removeAllRanges(),e.addRange(t),this},e.fn.flash=function(t,e){t=t||1e3,e=e||2;var i=Math.floor(t/e);originalColor=this.css("background-color"),this.css("background-color","#ffffdd");for(var a=0;e>a;a++)this.fadeOut(i).fadeIn(i,function(){this.css("background-color","#ffffff")});return this},e.fn.shake=function(t,i,a){return t=t||3,i=i||10,a=a||300,this.each(function(){e(this).css("position","relative");for(var n=1;t>=n;n++)e(this).animate({left:-1*i},a/t/4).animate({left:i},a/t/2).animate({left:0},a/t/4)}),this},function(t){"use strict";var e={init:function(e){var i=t.extend({},t.fn.loadingOverlay.defaults,e),a=t(this).addClass(i.loadingClass),n='<div class="'+i.overlayClass+'"><p class="'+i.spinnerClass+'"><span class="'+i.iconClass+'"></span><span class="'+i.textClass+'">'+i.loadingText+"</span></p></div>";return a.data("loading-overlay")||a.prepend(t(n)).data("loading-overlay",!0),a},remove:function(e){var i=t.extend({},t.fn.loadingOverlay.defaults,e),a=t(this).data("loading-overlay",!1);return a.find("."+i.overlayClass).detach(),a.hasClass(i.loadingClass)?a.removeClass(i.loadingClass):a.find("."+i.loadingClass).removeClass(i.loadingClass),a},exposeMethods:function(){return e}};t.fn.loadingOverlay=function(i){return e[i]?e[i].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof i&&i?void t.error("Method "+i+" does not exist on jQuery.loadingOverlay"):e.init.apply(this,arguments)},t.fn.loadingOverlay.defaults={loadingClass:"loading",overlayClass:"loading-overlay",spinnerClass:"loading-spinner",iconClass:"loading-icon fa fa-circle-o-notch fa-spin",textClass:"loading-text",loadingText:""}}(jQuery),a.Plus=Backbone.View.extend({tagName:"div",className:"villain-add-block villain-droppable",blockSelectionTemplate:i.template('<div class="villain-block-selection"><%= content %></div>'),events:{"click .villain-add-block-button":"onClickAddBlock","click .villain-block-button":"onClickBlockButton"},initialize:function(t){this.store=t,this.$el.attr("data-blockstore",t),this.$el.attr("id",i.uniqueId("villain-plus-")),this.render()},render:function(){return this.$el.append('<button class="villain-add-block-button">+</button>'),this},onClickBlockButton:function(t){t.preventDefault(),$button=e(t.currentTarget),blockType=$button.data("type"),blockStore=this.store,BlockClass=a.BlockRegistry.getBlockClassByType(blockType),block=new BlockClass(!1,blockStore),block.$el.insertAfter($button.parent().parent()),block.$el.after(block.renderPlus().$el),block.hasTextBlock()&&block.setCaret(),block.scrollTo(),$button.parent().prev().show(),$button.parent().remove()},onClickAddBlock:function(t){t.preventDefault(),$addBlockButton=e(t.currentTarget),$addBlockButton.hide(),blockId=$addBlockButton.parent().data("after-block-id"),blockSelection=this.blockSelectionTemplate({content:this.getButtons(blockId)}),$addBlockButton.parent().append(blockSelection)},getButtons:function(t){html="";for(var e in a.BlockRegistry.Map)b=a.BlockRegistry.getBlockClassByType(e),b.hasOwnProperty("getButton")&&(html+=b.getButton(t));return html}}),a.BlockStore=[],a.BlockStore.count=1,a.BlockStore.getId=function(){return id=a.BlockStore.count,a.BlockStore.count++,id},a.BlockStore.getBlockById=function(t,e){return block=i.find(a.BlockStore[t],function(t){return t.id==e}),block&&block.hasOwnProperty("object")?block.object:!1},a.BlockStore.add=function(t,e,i){a.BlockStore[t].push({id:e,object:i})},a.BlockStore.del=function(t,e){a.BlockStore[t]=i.filter(a.BlockStore[t],function(t){return t.id!==e})},a.BlockStore.delStore=function(t){i.each(a.BlockStore[t],function(t){t.object.destroy()}),a.BlockStore[t]=[]},a.BlockStore.create=function(t){a.BlockStore[t]=[]},a.Block=Backbone.View.extend({tagName:"div",className:"villain-block-wrapper",type:"base",template:i.template("base"),store:"main",wrapperTemplate:i.template(['<div class="villain-block-inner"><%= content %><%= actions %></div>'].join("\n")),actionsTemplate:i.template(['<div class="villain-actions">','  <div class="villain-action-button villain-action-button-setup">','    <i class="fa fa-cogs"></i>',"  </div>",'  <div class="villain-action-button villain-action-button-del">','    <i class="fa fa-trash"></i>',"  </div>",'  <div class="villain-action-button villain-action-button-move" draggable="true">','    <i class="fa fa-arrows-alt"></i>',"  </div>","</div>"].join("\n")),setupTemplate:i.template('<div class="villain-setup-block" />'),events:{"dragstart .villain-action-button-move":"onDragStart","click .villain-action-button-del":"onClickDelete","mouseover .villain-block-inner":"onMouseOver","mouseout .villain-block-inner":"onMouseOut","paste .villain-text-block":"onPaste","mouseup .villain-text-block":"onMouseUp","click .villain-text-block":"onClick","click .villain-action-button-setup":"onSetupClick"},onClick:function(){var t=this.getSelectedText();""===t&&a.EventBus.trigger("formatpopup:hide")},onSetupClick:function(){$button=this.$(".villain-action-button-setup"),$button.hasClass("active")?($button.removeClass("active"),this.hideSetup()):($button.addClass("active"),this.showSetup())},onMouseUp:function(){var t=this.getSelectedText();""!==t?a.EventBus.trigger("formatpopup:show",this):a.EventBus.trigger("formatpopup:hide")},getSelectedText:function(){var t="";return window.getSelection?t=window.getSelection():document.getSelection?t=document.getSelection():document.selection&&(t=document.selection.createRange().text),t.toString()},deleteBlock:function(){a.BlockStore.del(this.store,this.dataId),this.destroy()},loading:function(){this.$el.loadingOverlay()},done:function(){this.$el.loadingOverlay("remove")},destroy:function(){this.$el.next(".villain-add-block").remove(),this.undelegateEvents(),this.$el.removeData().unbind(),this.remove(),Backbone.View.prototype.remove.call(this)},onClickDelete:function(t){this.deleteBlock(),t.stopPropagation()},onDragStart:function(t){t.originalEvent.dataTransfer.setDragImage(this.$el.get(0),this.$el.width(),this.$el.height()),t.originalEvent.dataTransfer.setData("Text",this.dataId),t.stopPropagation()},onMouseOver:function(){this.$inner.addClass("hover"),this.$inner.children(".villain-actions").visible()},onMouseOut:function(){this.$inner.removeClass("hover"),this.$inner.children(".villain-actions").invisible()},onPaste:function(t){var i=!1;if(t&&t.originalEvent.clipboardData&&t.originalEvent.clipboardData.getData){var n="",o=t.originalEvent.clipboardData.types;if(e.isArray(o))for(var l=0;l<o.length;l++)n+=o[l]+";";else n=o;if(/text\/html/.test(n)?clipboardHTML=t.originalEvent.clipboardData.getData("text/html"):/text\/rtf/.test(n)&&a.browser.safari?clipboardHTML=t.originalEvent.clipboardData.getData("text/rtf"):/text\/plain/.test(n)&&!a.browser.mozilla&&(clipboardHTML=t.originalEvent.clipboardData.getData("text/plain").replace(/\n/g,"<br/>")),""!==this.clipboardHTML?i=!0:this.clipboardHTML=null,i)return cleanHtml=a.Editor.processPaste(clipboardHTML),t.stopPropagation(),t.preventDefault(),a.Editor.pasteHtmlAtCaret(cleanHtml),!1}},getIdFromBlockStore:function(){return a.BlockStore.getId()},initialize:function(t,e){this.data=t||null,this.dataId=this.getIdFromBlockStore(),this.$el.attr("data-block-id",this.dataId),this.$el.attr("data-block-type",this.type),this.$el.attr("id","villain-block-"+this.dataId),e&&(this.store=e),this.$el.attr("data-blockstore",this.store),this.id="villain-block-"+this.dataId,this.addToBlockStore(e),this.render()},doRenderCallback:function(){},hasTextBlock:function(){return 0===this.$(".villain-text-block").length?!1:!0},setCaret:function(){var t,e;t=document.createRange(),t.selectNodeContents(this.getTextBlock()[0]),t.collapse(!1),e=window.getSelection(),e.removeAllRanges(),e.addRange(t)},scrollTo:function(){e("html, body").animate({scrollTop:this.$el.offset().top-75},300,"linear")},flash:function(){},getJSON:function(){return[]},addToBlockStore:function(t){a.BlockStore.add(t?t:"main",this.dataId,this)},setData:function(t){this.data=t},getData:function(){return this.data},hasData:function(){return this.data?!0:!1},refreshBlock:function(){return html=this.renderEditorHtml(),this.el.innerHTML=html,this.$inner=this.$(".villain-block-inner"),this},render:function(){return html=this.data?this.renderEditorHtml():this.renderEmpty(),this.el.innerHTML=html,this.$inner=this.$(".villain-block-inner"),this.$content=this.$(".villain-content"),this.setup?(this.$inner.prepend(this.setupTemplate()),this.$setup=this.$(".villain-setup-block"),this.$(".villain-action-button-setup").show(),this.setup()):this.$(".villain-action-button-setup").hide(),this},getTextBlock:function(){return i.isUndefined(this.textBlock)&&(this.textBlock=this.$(".villain-text-block")),this.textBlock},clearInsertedStyles:function(t){var e=t.target;e.removeAttribute("style")},renderEditorHtml:function(){},renderEmpty:function(){},renderPlus:function(){return addblock=new a.Plus(this.store)},showSetup:function(){this.$content.hide(),$button=this.$(".villain-action-button-setup"),$button.addClass("active"),this.$setup.show()},hideSetup:function(){this.$setup.hide(),$button=this.$(".villain-action-button-setup"),$button.removeClass("active"),this.$content.show()}}),a.Blocks.Text=a.Block.extend({type:"text",template:i.template('<div class="villain-text-block villain-content" contenteditable="true"><%= content %></div>'),renderEditorHtml:function(){return blockTemplate=this.template({content:a.toHTML(this.data.text)}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderEmpty:function(){return blockTemplate=this.template({content:""}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},getJSON:function(){return textNode=a.toMD(this.getTextBlock().html()),json={type:this.type,data:{text:textNode}}},getHTML:function(){return textNode=this.getTextBlock().html(),markdown.toHTML(textNode)}},{getButton:function(e){return blockType="text",(t=i.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-paragraph"></i>',"</button>"].join("\n")))({id:e,type:blockType})}}),a.Blocks.Divider=a.Block.extend({type:"divider",template:i.template('<div class="villain-divider-block villain-content"><hr></div>'),renderEditorHtml:function(){return blockTemplate=this.template(),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderEmpty:function(){return blockTemplate=this.template(),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},getJSON:function(){return json={type:this.type,data:{text:"--------------------"}}},getHTML:function(){return"<hr>"}},{getButton:function(e){return blockType="divider",(t=i.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-minus"></i>',"</button>"].join("\n")))({id:e,type:blockType})}}),a.Blocks.Header=a.Block.extend({type:"header",template:i.template(['<div class="villain-text-block villain-text-block-header villain-content" contenteditable="true">',"<%= content %>","</div>"].join("\n")),renderEditorHtml:function(){return blockTemplate=this.template({content:this.data.text}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderEmpty:function(){return blockTemplate=this.template({content:""}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},getJSON:function(){return textNode=a.toMD(this.getTextBlock().html()).trim(),json={type:this.type,data:{text:textNode}}},getHTML:function(){return textNode=this.getTextBlock().html(),"<h3>"+markdown.toHTML(textNode)+"</h3>"}},{getButton:function(e){return blockType="header",(t=i.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-header"></i>',"</button>"].join("\n")))({id:e,type:blockType})}}),a.Blocks.List=a.Block.extend({type:"list",template:i.template(['<div class="villain-text-block villain-text-block-list villain-content" contenteditable="true">',"<%= content %>","</div>"].join("\n")),renderEditorHtml:function(){return blockTemplate=this.template({content:markdown.toHTML(this.data.text)}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderEmpty:function(){return blockTemplate=this.template({content:"Liste"}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},getJSON:function(){return textNode=this.getTextBlock().html().replace(/<\/li>/gm,"\n").replace(/<\/?[^>]+(>|$)/g,"").replace(/^(.+)$/gm," - $1"),json={type:this.type,data:{text:textNode}}},getHTML:function(){return textNode=this.getTextBlock().html(),"<h3>"+markdown.toHTML(textNode)+"</h3>"},toMarkdown:function(t){return t.replace(/<\/li>/gm,"\n").replace(/<\/?[^>]+(>|$)/g,"").replace(/^(.+)$/gm," - $1")}},{getButton:function(e){return blockType="list",(t=i.template(['<button class="villain-block-button" ','        data-type="<%= type %>" ','        data-after-block-id="<%= id %>"',">",'   <i class="fa fa-list-ul"></i>',"</button>"].join("\n")))({id:e,type:blockType})}}),a.Blocks.Image=a.Block.extend({type:"image",template:i.template('<div class="villain-image-block villain-content"><img class="img-responsive" src="<%= url %>" /></div>'),events:{"drop .villain-image-dropper i":"onDropImage","dragenter .villain-image-dropper i":"onDragEnter","dragleave .villain-image-dropper i":"onDragLeave","dragover .villain-image-dropper i":"onDragOver","click .villain-image-dropper-upload":"onUploadClickAfterDrop"},initialize:function(t,e){a.Block.prototype.initialize.apply(this,[t,e]),i.extend(this.events,a.Block.prototype.events)},onUploadClickAfterDrop:function(t){t.preventDefault(),this.loading();var n=[this.dataId,(new Date).getTime(),"raw"].join("-");if(img=this.$setup.find(".villain-image-dropper img"),!this.file)return this.done(),!1;var o=new FormData;o.append("name",this.file.name),o.append("image",this.file),o.append("uid",n),that=this,e.ajax({type:"post",dataType:"json",accepts:{json:"text/json"},url:a.options.uploadURL,data:o,cache:!1,contentType:!1,processData:!1,xhr:function(){var t=e.ajaxSettings.xhr();return t.upload&&t.upload.addEventListener("progress",that.progressHandlingFunction,!1),t},dataType:"json"}).done(e.proxy(function(t){if("200"==t.status&&(this.$setup.append('<div class="villain-message success">Bildet er lastet opp</div>'),this.$setup.find(".villain-image-dropper-upload").remove(),this.$setup.find(".villain-image-dropper").remove(),t.hasOwnProperty("image")&&(imageData=t.image,$image=e('<img src="'+imageData.src+'" />'),this.$setup.append($image),json={url:imageData.src},this.setData(json)),t.hasOwnProperty("uid")&&(n=t.uid),t.hasOwnProperty("form"))){var a="";inputTemplate=i.template(["<label><%= label %></label>",'<input type="<%= type %>" ','       value="<%= value %>" ','       name="<%= name %>"',"/>"].join("\n"));for(var o=0;o<t.form.fields.length;o++)field=t.form.fields[o],a+=inputTemplate({label:field.label,type:field.type,value:field.value,name:field.name});formTemplate=i.template(['<form method="<%= method %>" ','      action="<%= action %>" ','      class="villain-form" ','      name="<%= name %>"',">","<%= inputs %>","</form>"].join("\n")),form=formTemplate({method:t.form.method,action:t.form.action,name:t.form.name,inputs:a}),$form=e(form),$submitButton=e('<input type="submit" name="'+t.form.name+'-submit" value="Lagre" />'),$submitButton.on("click",function(i){i.preventDefault(),serializedForm=$form.serialize(),imagedata=new FormData,imagedata.append("form",serializedForm),imagedata.append("uid",n),e.ajax({type:"post",url:t.form.action,data:imagedata,cache:!1,contentType:!1,processData:!1,dataType:"json"}).done(e.proxy(function(t){200==t.status&&(json=that.getData(),json.title=t.title,json.credits=t.credits,that.setData(json),that.refreshBlock())},this))}),$form.append($submitButton),this.$setup.append($form)}},this)).fail(e.proxy(function(){alert("Feil fra server under opplasting.")},this)).always(e.proxy(function(){})),this.done()},progressHandlingFunction:function(t){t.lengthComputable},onDragEnter:function(t){this.$(".villain-image-dropper i").addClass("drop-hover"),t.preventDefault()},onDragLeave:function(t){this.$(".villain-image-dropper i").removeClass("drop-hover"),t.preventDefault()},onDragOver:function(t){t.preventDefault()},onDropImage:function(t){t.preventDefault(),this.$(".villain-image-dropper i").removeClass("drop-hover"),dataTransfer=t.originalEvent.dataTransfer;var i=dataTransfer.files[0],a="undefined"!=typeof URL?URL:"undefined"!=typeof webkitURL?webkitURL:null;/image/.test(i.type)&&(this.$(".villain-image-dropper").html(e("<img>",{src:a.createObjectURL(i)})),$form=e(['<form enctype="multipart/form-data" ','encoding="multipart/form-data" action="upload/image" ','method="post" id="villain-upload-form-'+this.dataId+'">','<input id="villain-upload-file-'+this.dataId+'" ','type="file" ','name="villain-upload-file-'+this.dataId+'" ','accept="image/*">',"</form>"].join("\n")),this.$setup.append("<hr>"),this.$setup.append('<button class="villain-image-dropper-upload">Last opp og lagre</button>'),this.file=i)},renderEditorHtml:function(){return blockTemplate=this.template({url:this.data.url}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderEmpty:function(){return blockTemplate=this.template({url:"http://placehold.it/1150x400"}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},getJSON:function(){return json={type:this.type,data:{url:this.data.url,title:this.data.title||"",credits:this.data.credits||""}}},getHTML:function(){return url=this.$("img").attr("src"),this.template({url:url})},setup:function(){this.hasData()||(this.$(".villain-image-block").hide(),$imageDropper=e(['<div class="villain-image-dropper"><i class="fa fa-image"></i>',"<div>Dra bildet du vil laste opp hit</div>","<div><hr></div>","<div>",'<button class="villain-image-browse-button">Hent bilde fra server</button>',"</div>","</div>"].join("\n")),$imageDropper.find(".villain-image-browse-button").on("click",e.proxy(this.onImageBrowseButton,this)),this.$setup.append($imageDropper),this.$setup.show())},onImageBrowseButton:function(t){t.preventDefault(),this.loading(),e.ajax({type:"get",url:a.options.browseURL,cache:!1,contentType:!1,processData:!1,dataType:"json"}).done(e.proxy(function(t){if(200!=t.status)return!1;if(!t.hasOwnProperty("images"))return!1;$images=e("<div />");for(var i=0;i<t.images.length;i++)img=t.images[i],$images.append('<img src="'+img.thumb+'" data-large="'+img.src+'" />');$images.on("click","img",e.proxy(function(t){this.setData({url:e(t.target).data("large")}),this.refreshBlock()},this)),this.$setup.html(""),this.$setup.append('<div class="villain-message success">Klikk på bildet du vil sette inn</div>'),this.$setup.append($images),this.done()},this))},onUploadImagesButton:function(t){var e=t.target.files,i="undefined"!=typeof URL?URL:"undefined"!=typeof webkitURL?webkitURL:null;fileList=[];for(var a=0;a<e.length;a++){var n=e[a];fileList.push(['<div class="three">','<div class="center-cropped" style="background-image: url(',i.createObjectURL(n),');"></div>',"</div>"].join("\n"))}listHTML='<div style="margin-top: 10px;" class="wrapper"><div class="row">';for(var o=0;o<fileList.length;o++)listHTML+=o&&o%4===0?'</div><div style="margin-top: 15px" class="row">'+fileList[o]:fileList[o];listHTML+="</div></div>",this.$setup.append(listHTML)}},{getButton:function(e){return blockType="image",(t=i.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-file-image-o"></i>',"</button>"].join("\n")))({id:e,type:blockType})}}),a.Blocks.Video=a.Block.extend({type:"video",providers:{vimeo:{regex:/(?:http[s]?:\/\/)?(?:www.)?vimeo.com\/(.+)/,html:['<iframe src="{{protocol}}//player.vimeo.com/video/{{remote_id}}?title=0&byline=0" ','width="580" height="320" frameborder="0"></iframe>'].join("\n")},youtube:{regex:/(?:http[s]?:\/\/)?(?:www.)?(?:(?:youtube.com\/watch\?(?:.*)(?:v=))|(?:youtu.be\/))([^&].+)/,html:['<iframe src="{{protocol}}//www.youtube.com/embed/{{remote_id}}" ','width="580" height="320" frameborder="0" allowfullscreen></iframe>'].join("\n")}},template:i.template('<div class="villain-video-block villain-content"><%= content %></div>'),events:{"click .villain-setup-block button":"onClick"},onClick:function(t){t.preventDefault(),videoUrl=this.$(".villain-video-setup-url").val(),i.isURI(videoUrl)&&(embedString=this.buildString(videoUrl),this.$content.html(embedString),this.hideSetup())},buildString:function(t){var e,a;if(i.each(this.providers,function(n,o){e=n.regex.exec(t),null===e||i.isUndefined(e[1])||(a={source:o,remote_id:e[1]},this.setData(a))},this),this.providers.hasOwnProperty(a.source)){var n=this.providers[a.source].html.replace("{{protocol}}",window.location.protocol).replace("{{remote_id}}",a.remote_id).replace("{{width}}","100%");return n}},initialize:function(t,e){a.Block.prototype.initialize.apply(this,[t,e]),i.extend(this.events,a.Block.prototype.events)},renderEditorHtml:function(){if(this.providers.hasOwnProperty(this.data.source)){var t=this.providers[this.data.source].html.replace("{{protocol}}",window.location.protocol).replace("{{remote_id}}",this.data.remote_id).replace("{{width}}","100%");return blockTemplate=this.template({content:t}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})}},renderEmpty:function(){return blockTemplate=this.template({content:""}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},getJSON:function(){return url=this.$("img").attr("src"),json={type:this.type,data:this.data}},getHTML:function(){return url=this.$("img").attr("src"),this.template({url:url})},setup:function(){this.hasData()||(this.$(".villain-video-block").hide(),videoSetup=e(['<div class="villain-video-setup-icon">','<i class="fa fa-video-camera"></i>',"<div>Lim inn link til youtube eller vimeo, f.eks http://www.youtube.com/watch?v=jlbunmCbTBA</div>","</div>",'<div class="villain-video-setup-input-wrapper">','<input type="text" name="villain-video-setup-url" class="villain-video-setup-url" />',"</div>","<div><hr></div>",'<div style="text-align: center;"><button>Hent video</button></div>'].join("\n")),this.$setup.append(videoSetup),this.$setup.show())}},{getButton:function(e){return blockType="video",(t=i.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-video-camera"></i>',"</button>"].join("\n")))({id:e,type:blockType})}}),a.Blocks.Columns=a.Block.extend({type:"columns",template:i.template('<div class="row"></div>'),columnTemplate:i.template('<div class="<%= columnClass %>"></div>'),events:{'keyup input[name="villain-columns-number"]':"_updateColumnCount","click button.villain-columns-apply":"_applyColumnCount"},initialize:function(t,e){a.Block.prototype.initialize.apply(this,[t,e]),i.extend(this.events,a.Block.prototype.events)},deleteBlock:function(){a.BlockStore.hasOwnProperty(this.store)&&a.BlockStore.delStore(this.store),a.BlockStore.del("main",this.dataId),this.destroy()},renderBlock:function(t){return t.$parent?void(t.$parent.attr("id")===this.$el.attr("id")&&this.$el.append(t.el)):!1},render:function(){return a.BlockStore.create(this.id),this.store=this.id,this.$el.attr("data-blockstore",this.store),blockTemplate=this.template({content:this.data}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate}),this.el.innerHTML=wrapperTemplate,this.$inner=this.$(".villain-block-inner"),this.data?this.renderEditorHtml():this.renderEmpty(),this.setup&&(this.$inner.prepend(this.setupTemplate()),this.$setup=this.$(".villain-setup-block"),this.setup()),this},renderEditorHtml:function(){return this.parseRow(),blockTemplate=this.template({content:this.data}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate}),this},renderEmpty:function(){return blockTemplate=this.template({content:this.data}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate}),this},getRow:function(){return this.$row?this.$row:(this.$row=this.$(".row"),this.$row)},getColumns:function(t){return this.getRow().children(t)},getColumn:function(t){return this.getRow().children(":eq("+t+")")},parseRow:function(){$row=this.getRow();for(var t=0;t<=this.data.length-1;t++){columnClass=this.data[t].class,columnData=this.data[t].data,$column=e('<div class="'+columnClass+'"></div>'),$row.append($column),$column=this.getColumn(t),addblock=new a.Plus(this.store),$column.append(addblock.$el);for(var i=0;i<columnData.length;i++)(BlockClass=a.BlockRegistry.getBlockClassByType(columnData[i].type))!==!1&&(block=new BlockClass(columnData[i].data,this.store),$column.append(block.$el),addblock=new a.Plus(this.store),$column.append(addblock.$el))}},getJSON:function(){var t={type:this.type,data:[]};return this.getColumns().each(function(){var i=[];e(this).children(".villain-block-wrapper").each(function(){var t=a.BlockStore.getBlockById(e(this).attr("data-blockstore"),e(this).attr("data-block-id"));i.push(t.getJSON())}),t.data.push({"class":e(this).attr("class"),data:i})}),t},setup:function(){this.hasData()||(this.getRow().hide(),this.$setup.append(['<label for="villain-columns-number">Antall kolonner</label>','<input type="text" class="villain-columns-number" name="villain-columns-number" />'].join("\n")),this.$setup.show(),this.$(".villain-columns-number").attr("autofocus","autofocus"))},_updateColumnCount:function(t){var i=e(t.target).val();this.$(".villain-column-widths").remove(),columnCountWrapper=e('<div class="villain-column-widths" />');for(var a=1;a<parseInt(i)+1;a++)columnCountWrapper.append(['<label for="villain-column-width-'+a+'">Kolonne '+a+" klassenavn (one, two, three ...)</label>",'<input type="text" name="villain-column-width-'+a+'" class="villain-column-width" />'].join("\n"));columnCountWrapper.append('<button class="villain-columns-apply">Sett opp kolonner</button>'),this.$setup.append(columnCountWrapper)},_applyColumnCount:function(t){t.preventDefault(),columnCount=this.$('input[name="villain-columns-number"]').val();for(var e=1;e<parseInt(columnCount)+1;e++)columnClass=this.$('input[name="villain-column-width-'+e+'"]').val(),this.getRow().append(this.columnTemplate({columnClass:columnClass})),addblock=new a.Plus(this.store),this.getColumn(e-1).append(addblock.$el);this.$setup.hide(),this.getRow().show()},renderPlus:function(){return addblock=new a.Plus("main")}},{getButton:function(e){return blockType="columns",(t=i.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-columns"></i>',"</button>"].join("\n")))({id:e,type:blockType})}});a.Editor=Backbone.View.extend({el:"#villain",textArea:"#id_body",data:{},blocks:{},events:{"submit form":"clickSubmit","dragover .villain-droppable":"onDragOverDroppable","dragenter .villain-droppable":"onDragEnterDroppable","dragleave .villain-droppable":"onDragLeaveDroppable","drop .villain-droppable":"onDropDroppable","drop .villain-text-block":"onDropTextblock"},getJSON:function(){var t=[];return this.$(".villain-block-wrapper").each(function(){(block=a.BlockStore.getBlockById("main",e(this).data("block-id")))!==!1&&(blockJson=block.getJSON(),t.push(blockJson))}),ret=JSON.stringify(t),"[]"!=ret?ret:""},onDragEnterDroppable:function(t){e(".villain-add-block-button",t.currentTarget).addClass("drop-hover"),t.preventDefault(),t.stopPropagation()},onDragLeaveDroppable:function(t){e(".villain-add-block-button",t.currentTarget).removeClass("drop-hover"),t.preventDefault(),t.stopPropagation()},onDragOverDroppable:function(t){t.preventDefault(),t.stopPropagation()},onDropDroppable:function(t){return target=t.currentTarget,e(target).hasClass("villain-droppable")!==!0?(t.preventDefault(),t.stopPropagation(),!1):(e(".villain-add-block-button",target).removeClass("drop-hover"),sourceId=t.originalEvent.dataTransfer.getData("text/plain"),$source=e("[data-block-id="+sourceId+"]"),$sourceAdd=$source.next(),$source.detach(),$sourceAdd.detach(),$source.insertAfter(e(target)),oldBlockStore=$source.attr("data-blockstore"),newBlockStore=e(target).attr("data-blockstore"),block=a.BlockStore.getBlockById(oldBlockStore,sourceId),block.store=newBlockStore,a.BlockStore.del(oldBlockStore,sourceId),a.BlockStore.add(newBlockStore,sourceId,block),$source.attr("data-blockstore",newBlockStore),$sourceAdd.insertAfter($source),void $sourceAdd.attr("data-blockstore",newBlockStore))},onDropTextblock:function(t){return $target=e(t.currentTarget).closest(".villain-block-wrapper").shake(),t.preventDefault(),t.stopPropagation(),!1},clickSubmit:function(t){a.EventBus.trigger("posts:submit",t),form=this.checkForm(),form.valid===!1&&t.preventDefault(),window.onbeforeunload=e.noop()},checkForm:function(){var t={valid:!0,errors:[]};return""===$titleEl.val()&&(t.errors.push("Overskrift kan ikke være blank."),t.valid=!1,$titleEl.parent().parent().addClass("error"),$titleEl.parent().parent().append('<span class="help-inline"><strong><i class="icon-hand-up"></i> Feltet er påkrevet.</strong></span>'),e("html, body").animate({scrollTop:0},5)),t},markDirty:function(){this.isDirty=!0},initialize:function(t){that=this,this.$textArea=e(t.textArea)||this.textArea,e('<div id="villain"></div>').insertAfter(this.$textArea),this.el="#villain",this.$el=e(this.el),this.$textArea.hide(),this.isDirty=!1;try{this.data=JSON.parse(this.$textArea.val())}catch(i){console.log("editor/init: No usable JSON found in textarea."),this.data=null}e("form").submit(function(){that.$textArea.val(that.getJSON())}),a.BlockStore.create("main"),a.setOptions(t),this.render()
},render:function(){if(addblock=new a.Plus("main"),this.$el.append(addblock.$el),formatPopUp=new a.FormatPopUp,this.$el.append(formatPopUp.$el),!this.data)return!1;for(var t=0;t<=this.data.length-1;t++)blockJson=this.data[t],(BlockClass=a.BlockRegistry.getBlockClassByType(blockJson.type))!==!1?(block=new BlockClass(blockJson.data),this.$el.append(block.$el),this.$el.append(block.renderPlus().$el)):console.error("Villain: No class found for type: "+blockJson.type)}}),a.FormatPopUp=Backbone.View.extend({tagName:"div",className:"villain-format-popup",events:{"click .villain-format-bold":"onClickBold","click .villain-format-italic":"onClickItalic","click .villain-format-link":"onClickLink","click .villain-format-unlink":"onClickUnlink"},onClickBold:function(t){t.preventDefault(),document.execCommand("bold",!1,!1),this.activateButton(".villain-format-bold")},onClickItalic:function(t){t.preventDefault(),document.execCommand("italic",!1,!1),this.activateButton(".villain-format-italic")},onClickLink:function(t){t.preventDefault();var e=prompt("Sett inn link:"),i=/((ftp|http|https):\/\/.)|mailto(?=\:[-\.\w]+@)/;e&&e.length>0&&(i.test(e)||(e="http://"+e),document.execCommand("CreateLink",!1,e)),this.activateButton(".villain-format-link")},onClickUnlink:function(t){t.preventDefault(),document.execCommand("unlink",!1,!1)},initialize:function(){this.render(),a.EventBus.on("formatpopup:show",this.showPopUp,this),a.EventBus.on("formatpopup:hide",this.hidePopUp,this)},render:function(){return this.$el.append('<button class="popup-button villain-format-bold"><i class="fa fa-bold"></i></button>'),this.$el.append('<button class="popup-button villain-format-italic"><i class="fa fa-italic"></i></button>'),this.$el.append('<button class="popup-button villain-format-link"><i class="fa fa-link"></i></button>'),this.$el.append('<button class="popup-button villain-format-unlink"><i class="fa fa-unlink"></i></button>'),this},showPopUp:function(t){$el=t.$el;var i=window.getSelection(),a=i.getRangeAt(0),n=a.getBoundingClientRect(),o=$el.offset(),l={};mainContent=e("section#maincontent"),l.top=n.top+mainContent.scrollTop(),l.left=(n.left+n.right)/2-this.$el.width()/2-o.left+12,parseInt(l.left)<0&&(l.left="0"),l.left=l.left+"px",this.deactivateButtons(),this.activeButtons(),this.$el.addClass("show-popup"),this.$el.css(l)},hidePopUp:function(){this.$el.removeClass("show-popup")},activeButtons:function(){var t,e=window.getSelection();e.rangeCount>0&&(t=e.getRangeAt(0).startContainer.parentNode),t&&"A"==t.nodeName&&this.activateButton(".villain-format-link"),document.queryCommandState("bold")&&this.activateButton(".villain-format-bold"),document.queryCommandState("italic")&&this.activateButton(".villain-format-italic")},activateButton:function(t){this.$(t).addClass("active")},deactivateButtons:function(){this.$(".popup-button").removeClass("active")}}),a.Editor.HTML=a.Editor.HTML||{},a.Editor.EditorHTML=a.Editor.EditorHTML||{},a.toMD=function(t){return t=toMarkdown(t),t=t.replace(/&nbsp;/g," "),t=t.replace(/([^<>]+)(<div>)/g,"$1\n$2").replace(/<div><div>/g,"\n<div>").replace(/<div><br \/><\/div>/g,"\n\n").replace(/(?:<div>)([^<>]+)(?:<div>)/g,"$1\n").replace(/(?:<div>)(?:<br>)?([^<>]+)(?:<br>)?(?:<\/div>)/g,"$1\n").replace(/<\/p>/g,"\n\n").replace(/<(.)?br(.)?>/g,"\n").replace(/&lt;/g,"<").replace(/&gt;/g,">"),aggressiveStrip=!0,t=aggressiveStrip?t.replace(/<\/?[^>]+(>|$)/g,""):t.replace(/<(?=\S)\/?[^>]+(>|$)/gi,"")},a.toHTML=function(t,e){e=i.classify(e);var n=t,o="Text"===e;i.isUndefined(o)&&(o=!1),o&&(n="<div>"+n),n=n.replace(/\[([^\]]+)\]\(([^\)]+)\)/gm,function(t,e,i){return'<a href="'+i+'">'+e.replace(/\r?\n/g,"")+"</a>"}),n=i.reverse(i.reverse(n).replace(/_(?!\\)((_\\|[^_])*)_(?=$|[^\\])/gm,function(t,e){return">i/<"+e.replace(/\r?\n/g,"").replace(/[\s]+$/,"")+">i<"}).replace(/\*\*(?!\\)((\*\*\\|[^\*\*])*)\*\*(?=$|[^\\])/gm,function(t,e){return">b/<"+e.replace(/\r?\n/g,"").replace(/[\s]+$/,"")+">b<"})),n=n.replace(/^\> (.+)$/gm,"$1");var l,r;for(l in a.Formatters)a.Formatters.hasOwnProperty(l)&&(r=a.Formatters[l],!i.isUndefined(r.toHTML)&&i.isFunction(r.toHTML)&&(n=r.toHTML(n)));return o&&(n=n.replace(/\r?\n\r?\n/gm,"</div><div><br></div><div>"),n=n.replace(/\r?\n/gm,"</div><div>")),n=n.replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;").replace(/\r?\n/g,"<br>").replace(/\*\*/,"").replace(/__/,""),n=n.replace(/\\\*/g,"*").replace(/\\\[/g,"[").replace(/\\\]/g,"]").replace(/\\\_/g,"_").replace(/\\\(/g,"(").replace(/\\\)/g,")").replace(/\\\-/g,"-"),o&&(n+="</div>"),n},a.setOptions=function(t){a.options=e.extend({},a.defaults,t)},a.browser=function(){var t={};if(this.getIEversion()>0)t.msie=!0;else{var e=navigator.userAgent.toLowerCase(),i=/(chrome)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||e.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[],a={browser:i[1]||"",version:i[2]||"0"};i[1]&&(t[a.browser]=!0),parseInt(a.version,10)<9&&t.msie&&(t.oldMsie=!0),t.chrome?t.webkit=!0:t.webkit&&(t.safari=!0)}return t},a.Editor.processPaste=function(t){return t.match(/(class=\"?Mso|style=\"[^\"]*\bmso\-|w:WordDocument)/gi)?(clean_html=a.Editor.wordClean(t),clean_html=a.Editor.clean(e("<div>").append(clean_html).html(),!1,!0),clean_html=a.Editor.removeEmptyTags(clean_html)):(clean_html=a.Editor.clean(t,!1,!0),clean_html=a.Editor.removeEmptyTags(clean_html)),clean_html=a.Editor.plainPasteClean(clean_html),""!==clean_html?clean_html:void 0},a.Editor.wordClean=function(t){t.indexOf("<body")>=0&&(t=t.replace(/[.\s\S\w\W<>]*<body[^>]*>([.\s\S\w\W<>]*)<\/body>[.\s\S\w\W<>]*/g,"$1")),t=t.replace(/<p(.*?)class="?'?MsoListParagraph"?'?([\s\S]*?)>([\s\S]*?)<\/p>/gi,"<ul><li><p>$3</p></li></ul>"),t=t.replace(/<p(.*?)class="?'?MsoListParagraphCxSpFirst"?'?([\s\S]*?)>([\s\S]*?)<\/p>/gi,"<ul><li><p>$3</p></li>"),t=t.replace(/<p(.*?)class="?'?MsoListParagraphCxSpMiddle"?'?([\s\S]*?)>([\s\S]*?)<\/p>/gi,"<li><p>$3</p></li>"),t=t.replace(/<p(.*?)class="?'?MsoListParagraphCxSpLast"?'?([\s\S]*?)>([\s\S]*?)<\/p>/gi,"<li><p>$3</p></li></ul>"),t=t.replace(/<span([^<]*?)style="?'?mso-list:Ignore"?'?([\s\S]*?)>([\s\S]*?)<span/gi,"<span><span"),t=t.replace(/<!--\[if \!supportLists\]-->([\s\S]*?)<!--\[endif\]-->/gi,""),t=t.replace(/(\n|\r| class=(")?Mso[a-zA-Z]+(")?)/gi," "),t=t.replace(/<!--[\s\S]*?-->/gi,""),t=t.replace(/<(\/)*(meta|link|span|\\?xml:|st1:|o:|font)(.*?)>/gi,"");for(var e=["style","script","applet","embed","noframes","noscript"],i=0;i<e.length;i++){var n=new RegExp("<"+e[i]+".*?"+e[i]+"(.*?)>","gi");t=t.replace(n,"")}t=t.replace(/([\w\-]*)=("[^<>"]*"|'[^<>']*'|\w+)/gi,""),t=t.replace(/&nbsp;/gi,"");var o;do o=t,t=t.replace(/<[^\/>][^>]*><\/[^>]+>/gi,"");while(t!=o);return t=a.Editor.clean(t)},a.Editor.clean=function(t,i,a,n,o){o=["accept","accept-charset","accesskey","action","align","alt","async","autocomplete","autofocus","autoplay","autosave","background","bgcolor","border","charset","cellpadding","cellspacing","checked","cite","class","color","cols","colspan","contenteditable","contextmenu","controls","coords","data","data-.*","datetime","default","defer","dir","dirname","disabled","download","draggable","dropzone","enctype","for","form","formaction","headers","height","hidden","high","href","hreflang","icon","id","ismap","itemprop","keytype","kind","label","lang","language","list","loop","low","max","maxlength","media","method","min","multiple","name","novalidate","open","optimum","pattern","ping","placeholder","poster","preload","pubdate","radiogroup","readonly","rel","required","reversed","rows","rowspan","sandbox","scope","scoped","scrolling","seamless","selected","shape","size","sizes","span","src","srcdoc","srclang","srcset","start","step","summary","spellcheck","style","tabindex","target","title","type","translate","usemap","value","valign","width","wrap"],n=["!--","a","abbr","address","area","article","aside","audio","b","base","bdi","bdo","blockquote","br","button","canvas","caption","cite","code","col","colgroup","datalist","dd","del","details","dfn","dialog","div","dl","dt","em","embed","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","header","hgroup","hr","i","iframe","img","input","ins","kbd","keygen","label","legend","li","link","main","map","mark","menu","menuitem","meter","nav","noscript","object","ol","optgroup","option","output","p","param","pre","progress","queue","rp","rt","ruby","s","samp","script","section","select","small","source","span","strong","style","sub","summary","sup","table","tbody","td","textarea","tfoot","th","thead","time","title","tr","track","u","ul","var","video","wbr"],t=t.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"");var l=new RegExp("<\\/?((?!(?:"+n.join("|")+"))\\w+)[^>]*?>","gi");t=t.replace(l,"");var r=new RegExp("( (?!(?:"+o.join("|")+"))[a-zA-Z0-9-_]+)=((?:.(?!\\s+(?:\\S+)=|[>]|(\\/>)))+.)","gi");t=t.replace(r,"");var s=new RegExp("style=(\"[a-zA-Z0-9:;\\.\\s\\(\\)\\-\\,!\\/'%]*\"|'[a-zA-Z0-9:;\\.\\s\\(\\)\\-\\,!\\/\"%]*')","gi");t=t.replace(s,"");var c=e("<div>").append(t);return c.find('[class]:not([class^="fr-"])').each(function(t,i){e(i).removeAttr("class")}),t=c.html()},a.Editor.plainPasteClean=function(t){var i=e("<div>").html(t);i.find("h1, h2, h3, h4, h5, h6, pre, blockquote").each(function(t,i){e(i).replaceWith("<p>"+e(i).html()+"</p>")});for(var a=function(t,i){e(i).replaceWith(e(i).html())};i.find("strong, em, strike, b, u, i, sup, sub, span, a").length;)i.find("strong, em, strike, b, u, i, sup, sub, span, a").each(a);return i.html()},a.Editor.removeEmptyTags=function(t){for(var i,a=e("<div>").html(t),n=a.find("*:empty:not(br, img, td, th)");n.length;){for(i=0;i<n.length;i++)e(n[i]).remove();n=a.find("*:empty:not(br, img, td, th)")}a.find("> div").each(function(t,i){e(i).replaceWith(e(i).html()+"<br/>")});for(var o=a.find("div");o.length;){for(i=0;i<o.length;i++){var l=e(o[i]),r=l.html().replace(/\u0009/gi,"").trim();l.replaceWith(r)}o=a.find("div")}return a.html()},a.Editor.pasteHtmlAtCaret=function(t){var e,i;if(window.getSelection){if(e=window.getSelection(),e.getRangeAt&&e.rangeCount){i=e.getRangeAt(0),i.deleteContents();var a=document.createElement("div");a.innerHTML=t;for(var n,o,l=document.createDocumentFragment();n=a.firstChild;)o=l.appendChild(n);i.insertNode(l),o&&(i=i.cloneRange(),i.setStartAfter(o),i.collapse(!0),e.removeAllRanges(),e.addRange(i))}}else document.selection&&"Control"!=document.selection.type&&document.selection.createRange().pasteHTML(t)},a.BlockRegistry={},a.BlockRegistry.Map={text:a.Blocks.Text,header:a.Blocks.Header,list:a.Blocks.List,image:a.Blocks.Image,video:a.Blocks.Video,divider:a.Blocks.Divider,columns:a.Blocks.Columns},a.BlockRegistry.getBlockClassByType=function(t){return a.BlockRegistry.Map.hasOwnProperty(t)?a.BlockRegistry.Map[t]:!1}}(jQuery,_);